<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Page 6 | Shigaro</title>
  <meta name="author" content="minyez">
  
  <meta name="description" content="minyez&#39;s blog on life, science and programming">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  
  <meta property="og:site_name" content="Shigaro"/>

  
    <meta property="og:image" content=""/>
  

  
  
    <link href="/assets/images/favicon/icon.png" rel="icon">
  
  
  <link rel="stylesheet" href="/css/bootstrap.min.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/bootstrap.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/font-awesome.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/responsive.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/highlight.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/google-fonts.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

  <script src="/js/jquery-2.0.3.min.js"></script>

  <!-- analytics -->
  
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-111612868-1', 'auto');
  ga('send', 'pageview');
</script>





<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js">
</script>



</head>

 <body 
>
  <nav id="main-nav" class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <button type="button" class="navbar-header navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
      <span class="sr-only">Toggle navigation</span>
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
    </button>
    <a class="navbar-brand" href="/"></a>
    <div class="collapse navbar-collapse nav-menu">
      <ul class="nav navbar-nav">
        

        <!-- Categories -->
        
        <li>
          <a href="/" title="Shigaro's Home"
            style="font-weight: normal; font-family: Calibri,Arial; font-size: 18px">
            <i class="fa fa-bank"></i>Home
          </a>
        </li>
        
        

        <!-- Categories -->
        
        <!-- Archives -->
        <li>
          <a href="/archives" title="All the articles."
            style="font-weight: normal; font-family: Calibri,Arial; font-size:     18px">
            <i class="fa fa-archive"></i>Archives
          </a>
        </li>
        
        

        <!-- Categories -->
        
        <!-- Tags -->
        <li>
          <a href="/tags" title="All the tags."
            style="font-weight: normal; font-family: Calibri,Arial; font-size:     18px">
            <i class="fa fa-tags"></i>Tags
          </a>
        </li>
        
        

        <!-- Categories -->
        
        <li class="dropdown">
          <a href="/categories" class="dropdown-toggle" data-toggle="dropdown" title="All the categories."
            style="font-weight: normal; font-family: Calibri,Arial; font-size:     18px">
            <i class="fa fa-folder"></i>Categories
            <b class="caret"></b>
          </a>
          <ul class="dropdown-menu">
            <li class="divider"></li>
            <li><a href="/categories" style="font-size: 20px; font-family: 'Calibri Light',Arial">All
                Categories</a><span></span></li>
            <li class="divider"></li>
            
            <li><a href="/categories/Software/"
                style="font-size: 15px; font-family: 微软雅黑">Software<span></span></a></li>
            
            <li><a href="/categories/Programming/"
                style="font-size: 15px; font-family: 微软雅黑">Programming<span></span></a></li>
            
            <li><a href="/categories/Comment/"
                style="font-size: 15px; font-family: 微软雅黑">Comment<span></span></a></li>
            
            <li><a href="/categories/Algorithm/"
                style="font-size: 15px; font-family: 微软雅黑">Algorithm<span></span></a></li>
            
            <li class="divider"></li>
          </ul>
        </li>
        
        

        <!-- Categories -->
        
        <li>
          <a href="/about" title="About me."
            style="font-weight: normal; font-family: Calibri,Arial; font-size: 18px">
            <i class="fa fa-user"></i>About
          </a>
        </li>
        
        
      </ul>
    </div>
  </div> <!-- container -->
</nav>
<div class="clearfix"></div>
  <div class="container">
  	<div class="content">
    	 <div class="page-header">
  <h1 class="home-title">Shigaro</h1>
</div>

<div class="row page">

	
	<div class="col-md-9">
	

		<div class="slogan">
      <i class="fa fa-code"></i>
      朝日が昇る　私は旅する
</div>    

		<div id="top_search"></div>
		<div class="mypage">
		
		<!-- title and entry -->
		
			
	
	<!-- display as entry -->	
		<h3 class="title">
			<div class="date"> 2019-04-20 </div>
			<div class="article-title"><a href="/2019/04/20/wien2k-fftw3-multi-def/" >解决编译WIEN2k时FFTW3 multiple definition错误</a></div>						
		</h3>
	


			<div class="entry">
  <div class="row">
	
	
		<link rel="stylesheet" type="text/css" href="/css/hint.min.css"><h2>摘要</h2>
<p><div class="alert alert-success"><i class="fa fa-lightbulb-o  float-left"></i>  <p>使用Intel FFTW3 wrapper, 解决自编FFTW下编译WIEN2k v14.2时出现的多次定义&quot;fftw_destroy_plan&quot;错误</p>
</div>
&lt;!-- more --&gt;</p>
<h2>问题描述</h2>
<p>尝试用Intel 2018.0和对应编译的FFTW3库编译WIEN2k v14.2. 用<code>siteconfig_lapw</code>, 在编译<code>SRC_lapw0</code>中的并行程序<code>lapw0_mpi</code>时, 报错</p>
<p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">libfftw3.a (apiplan.o): In function `fftw_destroy_plan’:</span><br><span class="line">apiplan.c:(.text+0x430): multiple definition of `fftw_destroy_plan’</span><br><span class="line">mkl/lib/intel64/libmkl_intel_lp64.a(fftw_destroy_panl.o):fftw_destroy_plan.c(.text+0x0): first defined here</span><br><span class="line">make[1]: *** [Makefile:99: lapw0_mpi] Error 1</span><br></pre></td></tr></table></figure></p>
<p>最终编译信息里提示<code>tetra</code>, <code>joint</code>, <code>telnes3</code>报错, 错误为<code>Internal compiler error</code>.</p>
<h2>解决过程</h2>
<p>因为是FFTW3和MKL的冲突, 所以考虑放弃自己编译的FFTW3, 用Intel自带的FFTW3 wrapper. 在编译好静态库<code>libfftw3xf_intel.a</code>后, 把<code>include</code>改为<code>mkl/interfaces/fftw</code>, 把<code>-lfftw3</code>改为该静态库的绝对路径, 删掉<code>lfftw3_mpi</code></p>
<p>作上述修改后用<code>siteconfig_lapw</code>重新编译<code>lapw0</code>, 出现<code>fft_modules</code>报错, 提示未定义MPI FFTW3变量的引用. 参考Intel的官方文档, 发现对MPI FFTW3有关变量的包装器定义在<code>fftw3x_cdtf</code>中, 需要编译这个lib. 链接时用它取代原来<code>lfftw3_mpi</code>的位置.</p>
<p>改完后再重新编译, 这一次报错<code>libfftw3x_cdft</code>链接错误: <code>Undefined reference to DftiSetValueDM</code>. 参考该 <a href="https://software.intel.com/en-us/forums/intel-math-kernel-library/topic/284696" target="_blank" rel="noopener">Intel forum链接</a> , 在静态链接时把<code>libmkl_cdft_core.a</code>放入链接的group中. 编译通过! 这时把RP_LIBS中的<code>libfftw3xf.a</code>去掉, 也可以正常编译.</p>

	
	</div>
  <!-- categories -->
  <span style="font-size:90%">
  
  <i style="color:#bbb" class="fa fa-folder"></i> <a style="color:#bbb" href="/categories/Software/">Software</a>
  </span>
  &nbsp
  <!-- tags -->
  <span style="font-size:90%" >
  
  <a style="color:#bbb" href="/tags/Compilation/">#Compilation</a>&nbsp&nbsp<a style="color:#bbb" href="/tags/Bugfix/">#Bugfix</a>&nbsp&nbsp<a style="color:#bbb" href="/tags/WIEN2k/">#WIEN2k</a>&nbsp&nbsp<a style="color:#bbb" href="/tags/FFTW/">#FFTW</a>
  </span>
  <!-- read more button -->
  <a type="button" href="/2019/04/20/wien2k-fftw3-multi-def/#more" class="pull-right btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->	
		<h3 class="title">
			<div class="date"> 2019-03-23 </div>
			<div class="article-title"><a href="/2019/03/23/valgrind-1/" >Valgrind笔记(一)——Memcheck初探</a></div>						
		</h3>
	


			<div class="entry">
  <div class="row">
	
	
		<link rel="stylesheet" type="text/css" href="/css/hint.min.css"><p><div class="alert alert-success"><i class="fa fa-lightbulb-o  float-left"></i>  <p>为了调试和优化GAP3程序, 使用Valgrind对其内存调用进行检查. 本文是对Valgrind功能的初步探索, 对一个简单程序的Valgrind输出进行了分析.</p>
</div>
&lt;!-- more --&gt;</p>
<h2>八卦</h2>
<p>很早就听说过Valgrind这个软件, 对它的名字和Logo很好奇, 粗略搜了一下名字, 在<a href="http://valgrind.org/docs/manual/faq.html#faq.whence" target="_blank" rel="noopener">官方FAQ</a>里发现这样一段话</p>
<blockquote>
<p>Q: Where does the name “Valgrind” come from?</p>
<p>A: From Nordic mythology. Originally (before release) the project was named <a href="https://en.wikipedia.org/wiki/Heimdallr" target="_blank" rel="noopener">Heimdall</a>, after the watchman of the Nordic gods. He could “see a hundred miles by day or night, hear the grass growing, see the wool growing on a sheep’s back”, etc. This would have been a great name, but it was already taken by a security package “Heimdal”.</p>
<p>Keeping with the Nordic theme, Valgrind was chosen. Valgrind is the name of the main entrance to <a href="https://en.wikipedia.org/wiki/Valhalla" target="_blank" rel="noopener">Valhalla</a> (the Hall of the Chosen Slain in Asgard). Over this entrance there resides a wolf and over it there is the head of a boar and on it perches a huge eagle, whose eyes can see to the far regions of the nine worlds. Only those judged worthy by the guardians are allowed to pass through Valgrind. All others are refused entrance.</p>
<p>It’s not short for “value grinder”, although that’s not a bad guess.</p>
</blockquote>
<p>大意就是, Valgrind取自北欧神话中Valhalla&lt;sup id=&quot;fnref:1&quot;&gt;&lt;a href=&quot;#fn:1&quot; rel=&quot;footnote&quot;&gt;&lt;span class=&quot;hint--top hint--error hint--medium hint--rounded hint--bounce&quot; aria-label=&quot;Valhalla在老伊达(<a href="https://en.wikipedia.org/wiki/Poetic_Edda" target="_blank" rel="noopener">The Poetic Edda</a>)里有记录, 想起来之前读文史大纲的时候遇到过, 见<a href="https://book.douban.com/subject/1203864/" target="_blank" rel="noopener">郑振铎全集</a>第十卷P343.&quot;&gt;[1]&lt;/span&gt;&lt;/a&gt;&lt;/sup&gt;入口的名字, 这个地方挂着熊头, 栖息着一匹狼和一只巨鹰, 视野达九界终焉. 只有被这些守卫者认为具有价值者才可通过Valgrind. 真是读书人呀 :P</p>
<h2>安装</h2>
<p>Valgrind的安装比较容易, 可以下载源码, 用<code>./configure; make; make install</code>的方式. 在Fedora上可以从源安装,</p>
<p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo dnf install valgrind</span><br></pre></td></tr></table></figure></p>
<p>撰写本文时Valgrind最新版本为3.15.0, macOS支持到10.13, 但不支持10.14 Mojave.</p>
<h2>程序编译选项</h2>
<p>为了让Valgrind能够工作, 在编译程序时, 应该采用<code>-g -O1</code>选项进行编译, 原因是</p>
<ul>
<li>使用<code>-g</code>产生所有debug需要的symbol.</li>
<li>优化选项推荐用O1. 可以用O0, 但那会非常慢, 因为在用Valgrind跑程序本身就要慢上<strong>20-30</strong>倍并用上数倍的内存.</li>
<li>不推荐用O2及以上, 那样会产生很多uninitialised value错误, 但这些error其实是由于优化产生, 并不实际存在于code当中.</li>
</ul>
<p>编译完程序以后, 在需要运行程序(比如<code>hello.out</code>)的地方执行</p>
<p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">valgrind --leak-check=yes ./hello.out</span><br></pre></td></tr></table></figure></p>
<p>将默认使用Memcheck工具, 检查内存leakage问题. 将<code>yes</code>改成<code>full</code>可以输出具体细节.</p>
<p><div class="alert alert-warning"><i class="fa fa-bell  float-left"></i>  <p>如果需要检查内存泄漏以外的问题, 尽量使用<code>-O0</code>. 这个可以在后面的例子里看到.</p>
</div></p>
<h2>实例: 越界赋值与内存泄漏</h2>
<h3>Fortran源码</h3>
<p>下面是一个Fortran程序例子<code>abf.f90</code>, 参考自Jason Blevins的<a href="https://jblevins.org/log/valgrind" target="_blank" rel="noopener">代码</a></p>
<p><figure class="highlight fortran"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">program</span></span> abc</span><br><span class="line">    <span class="keyword">integer</span> :: i</span><br><span class="line">    <span class="keyword">integer</span>, <span class="keyword">allocatable</span> :: <span class="keyword">data</span>(:)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">allocate</span>(<span class="keyword">data</span>(<span class="number">5</span>))</span><br><span class="line">    <span class="built_in">print</span>*, rank(<span class="keyword">data</span>), <span class="built_in">size</span>(<span class="keyword">data</span>), loc(<span class="keyword">data</span>)</span><br><span class="line">    <span class="keyword">do</span> i = <span class="number">1</span>, <span class="number">5</span></span><br><span class="line">        <span class="keyword">data</span>(i-<span class="number">1</span>) = i</span><br><span class="line">    <span class="keyword">end</span> <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">print</span>*, <span class="keyword">data</span>(<span class="number">1</span>)</span><br><span class="line">    <span class="built_in">print</span>*, rank(<span class="keyword">data</span>), <span class="built_in">size</span>(<span class="keyword">data</span>), loc(<span class="keyword">data</span>)</span><br><span class="line"><span class="keyword">end</span> <span class="function"><span class="keyword">program</span></span> abc</span><br></pre></td></tr></table></figure></p>
<p>做一点说明</p>
<ul>
<li>这个程序存在两个问题, 一是对<code>data(0)</code>赋值, 但Fortran分配数组时下标从1开始. 这是一个<a href="http://www.qnx.com/developers/docs/qnxcar2/index.jsp?topic=%2Fcom.qnx.doc.neutrino.prog%2Ftopic%2Fhat_OverrunErrors.html" target="_blank" rel="noopener">heap block overrun</a>问题. 二是没有对<code>data</code>数组进行<code>deallocate</code>内存释放</li>
<li><code>rank</code>, <code>size</code>和<code>loc</code>内建函数分别返回<code>data</code>的维度, 数组中确定类型的数的个数, 即所有维度上长度连乘, 以及array descriptor的位置.</li>
</ul>
<h3>编译和运行</h3>
<p>编译<code>abc.f90</code></p>
<p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">gfortran abc.f90 -o abc -g -O0</span><br></pre></td></tr></table></figure></p>
<p>为了不让程序直接报错, 没有加上debug需要的<code>-fbounds-check</code>.  运行Valgrind</p>
<p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">valgrind ./abc --leak-check=full</span><br></pre></td></tr></table></figure></p>
<h3>输出解读</h3>
<p>运行Valgrind给出的输出是</p>
<p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">==28740== Memcheck, a memory error detector</span><br><span class="line">==28740== Copyright (C) 2002-2017, and GNU GPL&apos;d, by Julian Seward et al.</span><br><span class="line">==28740== Using Valgrind-3.14.0 and LibVEX; rerun with -h for copyright info</span><br><span class="line">==28740== Command: ./abc --leak-check=full</span><br><span class="line">==28740==</span><br><span class="line">           1           5             97983168</span><br><span class="line">==28740== Invalid write of size 4</span><br><span class="line">==28740==    at 0x40098C: MAIN__ (abc.f90:8)</span><br><span class="line">==28740==    by 0x400A8F: main (abc.f90:12)</span><br><span class="line">==28740==  Address 0x5d71abc is 4 bytes before a block of size 20 alloc&apos;d</span><br><span class="line">==28740==    at 0x4C2CDCB: malloc (vg_replace_malloc.c:299)</span><br><span class="line">==28740==    by 0x400865: MAIN__ (abc.f90:5)</span><br><span class="line">==28740==    by 0x400A8F: main (abc.f90:12)</span><br><span class="line">==28740==</span><br><span class="line">           1           5             97983168</span><br><span class="line">==28740==</span><br><span class="line">==28740== HEAP SUMMARY:</span><br><span class="line">==28740==     in use at exit: 20 bytes in 1 blocks</span><br><span class="line">==28740==   total heap usage: 22 allocs, 21 frees, 13,516 bytes allocated</span><br><span class="line">==28740==</span><br><span class="line">==28740== LEAK SUMMARY:</span><br><span class="line">==28740==    definitely lost: 20 bytes in 1 blocks</span><br><span class="line">==28740==    indirectly lost: 0 bytes in 0 blocks</span><br><span class="line">==28740==      possibly lost: 0 bytes in 0 blocks</span><br><span class="line">==28740==    still reachable: 0 bytes in 0 blocks</span><br><span class="line">==28740==         suppressed: 0 bytes in 0 blocks</span><br><span class="line">==28740== Rerun with --leak-check=full to see details of leaked memory</span><br><span class="line">==28740==</span><br><span class="line">==28740== For counts of detected and suppressed errors, rerun with: -v</span><br><span class="line">==28740== ERROR SUMMARY: 1 errors from 1 contexts (suppressed: 0 from 0)</span><br></pre></td></tr></table></figure></p>
<p>对这些输出做一些说明</p>
<ul>
<li>运行<code>./abc</code>不会报错, 两个<code>print</code>均正常打印结果, 输出<code>data(1)</code>值为2. <code>loc</code>在赋值前后不变.</li>
<li>28740是运行任务的PID</li>
<li>Invalid write部分指出越界赋值的问题. <code>at 0x40098C: MAIN__ (abc.f90:8)</code>表示该write在<code>abc.f90</code>的第8行. 如果采用<code>-O1</code>优化, 这个错误会被隐藏起来.</li>
<li>HEAP SUMMARY给出占用内存的信息. 可以看到, 由于没有free掉整数类型(4 bytes)的data(5), 在退出时还有20 bytes被占用(in use at exit)</li>
</ul>
<h2>关于memory lost的类型</h2>
<p>LEAK SUMMARY给出内存泄漏的总结. 不同的lost对应的含义(总结于Valgrind <a href="http://valgrind.org/docs/manual/faq.html#faq.deflost" target="_blank" rel="noopener">FAQ</a>)</p>
<table>
<thead>
<tr>
<th style="text-align:left">类型</th>
<th style="text-align:left">解释</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">definitely lost</td>
<td style="text-align:left">程序有内存泄漏. 这些泄漏<strong>必须</strong>修正.</td>
</tr>
<tr>
<td style="text-align:left">indirectly lost</td>
<td style="text-align:left">程序的一个基于指针的结构里存在内存泄漏</td>
</tr>
<tr>
<td style="text-align:left">possibly lost</td>
<td style="text-align:left">程序存在内存泄漏, 除非做一些操作使得指针重新指向已分配的内存块.</td>
</tr>
<tr>
<td style="text-align:left">still reachable</td>
<td style="text-align:left">It didn’t free some memory it could have.</td>
</tr>
<tr>
<td style="text-align:left">suppressed</td>
<td style="text-align:left">存在内存泄漏, 但这些泄漏信息因为Valgrind设置的关系, 被抑制输出了</td>
</tr>
</tbody>
</table>
<p>做一点说明</p>
<ul>
<li>对于“indirectly lost”的解释是, 例如一个二叉树根节点definitely lost, 那么它的子节点就是indirectly lost. Indirectly lost通常在修复definitely lost后消失.</li>
<li>“still reachable”的含义还不是很清楚, 只是把FAQ原文抄录了, 因为自己还没有遇到, FAQ也说它是一个“常见和合理的错误”, 因此不做展开.</li>
</ul>
<h2>总结</h2>
<p>本文基于一个简单的Fortran程序, 从编译源代码开始, 展示了用Valgrind对程序内存调用进行检查的过程. 对Valgrind输出信息进行了初步解读.
&lt;div id=&quot;footnotes&quot;&gt;&lt;hr&gt;&lt;div id=&quot;footnotelist&quot;&gt;&lt;ol style=&quot;list-style: none; padding-left: 0; margin-left: 40px&quot;&gt;&lt;li id=&quot;fn:1&quot;&gt;&lt;span style=&quot;display: inline-block; vertical-align: top; padding-right: 10px; margin-left: -40px&quot;&gt;1.&lt;/span&gt;&lt;span style=&quot;display: inline-block; vertical-align: top; margin-left: 10px;&quot;&gt;Valhalla在老伊达(&lt;a href=&quot;https://en.wikipedia.org/wiki/Poetic_Edda&quot;&gt;The Poetic Edda&lt;/a&gt;)里有记录, 想起来之前读文史大纲的时候遇到过, 见&lt;a href=&quot;https://book.douban.com/subject/1203864/&quot;&gt;郑振铎全集&lt;/a&gt;第十卷P343.&lt;a href=&quot;#fnref:1&quot; rev=&quot;footnote&quot;&gt; ↩&lt;/a&gt;&lt;/span&gt;&lt;/li&gt;&lt;/ol&gt;&lt;/div&gt;&lt;/div&gt;</p>

	
	</div>
  <!-- categories -->
  <span style="font-size:90%">
  
  <i style="color:#bbb" class="fa fa-folder"></i> <a style="color:#bbb" href="/categories/Programming/">Programming</a>
  </span>
  &nbsp
  <!-- tags -->
  <span style="font-size:90%" >
  
  <a style="color:#bbb" href="/tags/Valgrind/">#Valgrind</a>
  </span>
  <!-- read more button -->
  <a type="button" href="/2019/03/23/valgrind-1/#more" class="pull-right btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->	
		<h3 class="title">
			<div class="date"> 2019-03-20 </div>
			<div class="article-title"><a href="/2019/03/20/vasp-set_indpw_full-error/" >解决运行VASP时set_indpw_full错误</a></div>						
		</h3>
	


			<div class="entry">
  <div class="row">
	
	
		<link rel="stylesheet" type="text/css" href="/css/hint.min.css"><p><div class="alert alert-success"><i class="fa fa-lightbulb-o  float-left"></i>  <p>通过恰当设置KPAR和NPAR, 解决VASP杂化泛函计算中出现的“set_indpw_full”错误.</p>
</div>
&lt;!-- more --&gt;</p>
<h2>问题描述</h2>
<p>用ACFDT-RPA计算Ne的EOS曲线, 在进行+8%体积的非自洽HF计算一步时, 标准输出中打印错误</p>
<p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">internal error in SET_INDPW_FULL: insufficient memory</span><br></pre></td></tr></table></figure></p>
<h2>解决过程</h2>
<p>谷歌该错误,  在<a href="https://cms.mpi.univie.ac.at/vasp-forum/viewtopic.php?t=17510" target="_blank" rel="noopener">第一条vasp forum链接</a>的最后, 楼主给出了解决方法:</p>
<ol>
<li>恰当设置KPAR和NPAR, 使得$\rm KPAR\times NPAR$等于总的核数.</li>
<li>关闭对称性, ISYM=0.</li>
</ol>
<p>我试着加上了KPAR=4, 因为总核数为16, NPAR=4, 不再报该错误, 计算顺利完成. 考虑到链接里的错误来自HSE计算, 因此这有可能是进行大体系的VASP杂化泛函计算时容易出现的错误.</p>

	
	</div>
  <!-- categories -->
  <span style="font-size:90%">
  
  <i style="color:#bbb" class="fa fa-folder"></i> <a style="color:#bbb" href="/categories/Software/">Software</a>
  </span>
  &nbsp
  <!-- tags -->
  <span style="font-size:90%" >
  
  <a style="color:#bbb" href="/tags/VASP/">#VASP</a>&nbsp&nbsp<a style="color:#bbb" href="/tags/Bugfix/">#Bugfix</a>&nbsp&nbsp<a style="color:#bbb" href="/tags/MPI/">#MPI</a>
  </span>
  <!-- read more button -->
  <a type="button" href="/2019/03/20/vasp-set_indpw_full-error/#more" class="pull-right btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->	
		<h3 class="title">
			<div class="date"> 2019-03-03 </div>
			<div class="article-title"><a href="/2019/03/03/numerov-on-log-grid/" >均匀格点与对数格点上的Numerov方法</a></div>						
		</h3>
	


			<div class="entry">
  <div class="row">
	
	
		<link rel="stylesheet" type="text/css" href="/css/hint.min.css"><p><div class="alert alert-success"><i class="fa fa-lightbulb-o  float-left"></i>  <p>在两种数值格点(均匀格点和对数格点)上推导了Numerov方法的递推方程, 给出了简单的Python实现.</p>
</div>
&lt;!-- more --&gt;</p>
<h2>背景</h2>
<p><a href="https://en.wikipedia.org/wiki/Numerov%27s_method" target="_blank" rel="noopener">Numerov方法</a>是数值求解常微分方程(ODE)的一种方法, 适用于不含一阶项的二阶ODE</p>
<p>$$\begin{equation}
y'' + f(r)y = s(r).
\end{equation}\label{eq:numerov-ode}
$$</p>
<p>在物理上有很多方程满足这种形式, 其中与我最为相关的是薛定谔方程(SE), 更确切的是三维有心势下的径向薛定谔方程(rSE). 原子单位下, rSE写成</p>
<p>$$
\left[-\frac{d^2}{d r^2} + \frac{l(l+1)}{r^2} + 2V(r)\right]R_l(r) = E_lR_l(r)
$$</p>
<p>其中$R_l$是定义在一维实空间$r$上的波函数$u_l$与矢径长$r$的积, $R_l(r)=ru_l(r)$, $E_l$是能量, $l$是角量子数. 这个方程满足Numerov方程要求的ODE形式</p>
<p>$$
\begin{cases}
f(r) = -\frac{l(l+1)}{r^2} - 2V(r) + E_l \
s(r) = 0
\end{cases}
$$</p>
<p>因此可以用该方法数值求解. 本文首先在两种格点方案, 均匀格点和对数格点上推导Numerov方法的核心方程, 即格点递推公式, 然后给出简单的Python实现.</p>
<h2>推导</h2>
<h3>均匀格点</h3>
<p>首先在均匀格点上推导一下Numerov方法. 在$r$点附近对函数$y$作Taylor展开</p>
<p>$$
\begin{equation}\label{eq:deriv-1}
y(r\pm h) = y(r) \pm hy'(r) + \frac{h^2}{2}y''(r) \pm \frac{h^3}{6}y'''(r) + \frac{h^4}{24}y''''(r) + \cdots
\end{equation}
$$</p>
<p>将正负两式相加</p>
<p>$$
\begin{equation}\label{eq:deriv-2}
y(r-h)+y(r+h) = 2y(r) + h^2y''(r) + \frac{h^4}{12}y''''(r) + \mathcal{O}(h^6)
\end{equation}
$$</p>
<p>由于</p>
<p>$$
y''''(r) = \frac{d^2}{d r^2}\left[f(r)y(r)-s(r)\right],
$$</p>
<p>定义$p(r):=f(r)y(r)-s(r), p=y'', p''=y''''$, 可以采用与式$\eqref{eq:deriv-1}\eqref{eq:deriv-2}$类似的办法处理$p$, 得到</p>
<p>$$
\begin{equation}\label{eq:deriv-3}
p(r-h)+p(r+h) = 2p(r) + h^2 p''(r) + \frac{h^4}{12}p''''(r) + \mathcal{O}(h^6).
\end{equation}
$$</p>
<p>把$p, p''$表达式$\eqref{eq:deriv-3}$回代到式$\eqref{eq:deriv-2}$中,</p>
<p>$$
y(r-h)+y(r+h) = 2y(r) + h^2p(r) + \frac{h^4}{12}\left[p(r-h)+p(r+h)-2p(r)\right] + \mathcal{O}(h^6).
$$</p>
<p>稍作整理, 得到</p>
<p>$$
\begin{aligned}
\left[1+\frac{h^2}{12}f(r-h)\right]y(r-h) +&amp; \left[1+\frac{h^2}{12}f(r+h)\right]y(r+h) = \
&amp;2\left[1+\frac{h^2}{12}f(r)\right]y(r) - h^2f(r)y(r) + \frac{h^2}{12}\left[s(r-h)+10s(r)+s(r+h)\right] + \mathcal{O}(h^6).
\end{aligned}
$$</p>
<p>这就是Numerov方法的一般方程. 特别的, 对于齐次方程, $s=0$, 式子可以化简成</p>
<p>$$
\left[1+\frac{h^2}{12}f(r+h)\right]y(r+h) = 2\left[1+\frac{h^2}{12}f(r)\right]y(r) - \left[1+\frac{h^2}{12}f(r-h)\right]y(r-h) - h^2f(r)y(r) + \mathcal{O}(h^6).
$$</p>
<p>取间距为$h$的均匀格点, 此时上式化成三点递推方程,</p>
<p>$$
(1+\frac{h^2}{12}f_{n+1})y_{n+1} = 2(1+\frac{h^2}{12}f_n)y_n - (1+\frac{h^2}{12}f_{n-1})y_{n-1} - h^2f_n y_n
$$</p>
<p>精确到步长的六次方. 实际应用当中, 我们需要先确定前两个格点上的值, 然后就可以用上式推出第三点及之后所有格点上的函数值.</p>
<h3>对数格点</h3>
<p>除了实空间均匀格点, 我们也可以使用对数均匀格点(logarithmic grid), 其上第n个实空间格点为</p>
<p>$$
r_n = r_0 e^{nh}
$$</p>
<p>上面的Numerov方法不能直接用于格点${r_n}$, 因为这种情况下格点$r$间距是变化的, 但是我们可以通过代数变换使之成为可能. 首先定义变量替换$x\mapsto r$</p>
<p>$$
r(x) = r_0e^x
$$</p>
<p>及定义$Y(x)$为</p>
<p>$$\begin{equation}
y(r) = r_0e^{x/2}Y(x).
\end{equation}\label{eq:log-trans-y}$$</p>
<p>从而</p>
<p>$$
\begin{aligned}
\frac{d^2}{d r^2}y(r) &amp;= \frac{1}{r_0e^x}\frac{d}{dx}\left[\frac{1}{e^x}\frac{d}{d x}\left(e^{x/2}Y(x)\right)\right] \
&amp;=\frac{1}{r_0e^x}\left[-\frac{1}{4}e^{-x/2}Y(x) + e^{-x/2}Y''(x)\right] \
\end{aligned}
$$</p>
<p>其中撇号代表对$x$求导而非$r$. 代回到式$\eqref{eq:numerov-ode}$的ODE中</p>
<p>$$
\begin{aligned}
\frac{1}{r_0}e^{-3x/2}\left[-\frac{1}{4}Y(x) + Y''(x)\right] + f(r)r_0e^{x/2}Y(x) &amp;= s(r)\
Y'' + \left[f(r)r^2_0e^{2x}-\frac{1}{4}\right]Y(x) &amp;= r_0e^{3x/2}s(r).
\end{aligned}
$$</p>
<p>令</p>
<p>$$\begin{equation}
\begin{aligned}
F(x):=&amp;f(r)r^2_0e^{2x}-\frac{1}{4}= f(r(x))r(x)^2-\frac{1}{4} \
S(x):=&amp;r_0e^{3x/2}s(r) = \sqrt{\frac{r(x)^3}{r_0}}s(r(x))
\end{aligned}
\end{equation}\label{eq:log-trans-f-s}$$</p>
<p>于是得到ODE</p>
<p>$$
Y''(x) + F(x)Y(x) = S(x)
$$</p>
<p>这与原始ODE$\eqref{eq:numerov-ode}$相似, 但它定义在变量$x$上而非实空间$r$上. 由于格点$x$是均匀的, 我们可以应用前面均匀格点的算法解出$Y(x)$, 然后再通过式$\eqref{eq:log-trans-y}$变换回$y(r)$.</p>
<h2>Python实现</h2>
<p>以下是忽略了s后, Numerov方法在均匀格点和对数格点上的Python实现. Numba装饰器用于编译优化.</p>
<p>首先是均匀格点上的实现<code>numerov</code>, 参考了<a href="https://www.physics.rutgers.edu/grad/509/src_prog/hmw/Hydrogen.html" target="_blank" rel="noopener">Kristjan Haule</a>的代码.</p>
<p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">@numba.njit</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">numerov</span><span class="params">(f, h, y0, dy0)</span>:</span></span><br><span class="line">    <span class="string">'''Solve y''(r) + f(r)y(r)=0 by Numerov method on a linear r grid</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        f (1d-array): f</span></span><br><span class="line"><span class="string">        h (float): the step size of linear grid</span></span><br><span class="line"><span class="string">        y0 (float): y value at the first grid point</span></span><br><span class="line"><span class="string">        dy0 (float): first-order derivaitve at the first grid point</span></span><br><span class="line"><span class="string">    '''</span></span><br><span class="line">    y = np.zeros(len(f))</span><br><span class="line">    y[<span class="number">0</span>] = y0</span><br><span class="line">    y[<span class="number">1</span>] = y0 + h * dy0</span><br><span class="line">    h2 = h**<span class="number">2</span></span><br><span class="line">    h2d12 = h2/<span class="number">12.0</span></span><br><span class="line">    w0 = y0 * (<span class="number">1</span> + h2d12 * f[<span class="number">0</span>])</span><br><span class="line">    w1 = y[<span class="number">1</span>] * (<span class="number">1</span> + h2d12 * f[<span class="number">1</span>])</span><br><span class="line">    yn = y[<span class="number">1</span>]</span><br><span class="line">    fn = f[<span class="number">1</span>]</span><br><span class="line">    <span class="keyword">for</span> n <span class="keyword">in</span> range(<span class="number">2</span>, len(f)):</span><br><span class="line">        w2 = <span class="number">2</span> * w1 - w0 - h2 * fn * yn</span><br><span class="line">        fn = f[n]</span><br><span class="line">        yn = w2 / (<span class="number">1</span> + h2d12 * fn)</span><br><span class="line">        y[n] = yn</span><br><span class="line">        w0, w1 = w1, w2</span><br><span class="line">    <span class="keyword">return</span> y</span><br></pre></td></tr></table></figure></p>
<p>然后是对数格点上的实现<code>numerov_log</code>:</p>
<p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">@numba.njit</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">numerov_log</span><span class="params">(r, f, y0, dy0)</span>:</span></span><br><span class="line">    <span class="string">'''Solve y''(r) + f(r)y(r) = 0 by Numerov method on an exponential r grid</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        r (1d-array): the logarithmic grid</span></span><br><span class="line"><span class="string">        f (1d-array)</span></span><br><span class="line"><span class="string">        y0 (float): y at the first grid</span></span><br><span class="line"><span class="string">        dy0 (float): first-order derivaitve at the first grid</span></span><br><span class="line"><span class="string">    '''</span></span><br><span class="line">    r0 = r[<span class="number">0</span>]</span><br><span class="line">    <span class="comment"># calculate F(x)</span></span><br><span class="line">    F = np.multiply(f, np.power(r, <span class="number">2</span>)) - <span class="number">0.25E0</span></span><br><span class="line">    x = np.log(r/r0)</span><br><span class="line">    <span class="comment"># step size in x</span></span><br><span class="line">    hx = x[<span class="number">1</span>] - x[<span class="number">0</span>]</span><br><span class="line">    <span class="comment"># convert boundary condition of y to Y</span></span><br><span class="line">    Y0 = y0 / r0</span><br><span class="line">    dY0 = - Y0/<span class="number">2</span> + dy0 * r0</span><br><span class="line">    <span class="comment"># call Numerov on linear grid x</span></span><br><span class="line">    Y = numerov(F, hx, Y0, dY0)</span><br><span class="line">    <span class="keyword">return</span> Y * np.sqrt(r * r0)</span><br></pre></td></tr></table></figure></p>

	
	</div>
  <!-- categories -->
  <span style="font-size:90%">
  
  <i style="color:#bbb" class="fa fa-folder"></i> <a style="color:#bbb" href="/categories/Algorithm/">Algorithm</a>
  </span>
  &nbsp
  <!-- tags -->
  <span style="font-size:90%" >
  
  <a style="color:#bbb" href="/tags/Grid-technique/">#Grid technique</a>&nbsp&nbsp<a style="color:#bbb" href="/tags/Numerical-method/">#Numerical method</a>
  </span>
  <!-- read more button -->
  <a type="button" href="/2019/03/03/numerov-on-log-grid/#more" class="pull-right btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->	
		<h3 class="title">
			<div class="date"> 2019-01-05 </div>
			<div class="article-title"><a href="/2019/01/05/panflute_practice/" >Pandoc笔记(二)——使用panflute编写过滤器</a></div>						
		</h3>
	


			<div class="entry">
  <div class="row">
	
	
		<link rel="stylesheet" type="text/css" href="/css/hint.min.css"><p><div class="alert alert-success"><i class="fa fa-lightbulb-o  float-left"></i>  <p>记录笔者学习通过panflute编写pandoc过滤器的过程, 实现了一个将<code>#anytag(date, mood)</code>转化为可用Bootstrap CSS渲染的HTML源码的过滤器.</p>
</div>
&lt;!-- more --&gt;</p>
<p>在<a href="/2019/01/02/pandoc-md-to-pdf/" title="Pandoc笔记(一)——转化Markdown为PDF">Pandoc笔记(一)——转化Markdown为PDF</a>一文里我尝试用HTML和LaTeX转化Markdown文本到PDF, 包括用CSS和LaTeX模板自定义PDF输出. 但有时我们需要在转化时对Markdown文本本身进行on-the-fly的修改. 这是仅仅修改样式无法完成的, 需要借助<a href="https://pandoc.org/filters.html" target="_blank" rel="noopener">pandoc过滤器</a>直接修改抽象语义树(abstract syntax tree, AST).</p>
<p>过滤器原则上需要用Haskell写. 对于不会写Haskell的开发人员, jgm老师提供了它的Python包装<a href="https://github.com/jgm/pandocfilters" target="_blank" rel="noopener">pandocfilters</a>. 它的一个替代品是<a href="http://scorreia.com/software/panflute/" target="_blank" rel="noopener">panflute</a>, 特点是提供了额外的帮助函数, 便于debug等等. 下面过滤器代码都是基于panflute的.</p>
<h2>学习简单例子</h2>
<h3>强调转删除线</h3>
<p>官网上一个将<code>*x*</code>强调文字换成<code>~~x~~</code>删除线文字</p>
<p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># filename: emph_so.py</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">Replace Emph elements with Strikeout elements</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="keyword">from</span> panflute <span class="keyword">import</span> Emph, Strikeout, run_filter</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">action</span><span class="params">(elem, doc)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> isinstance(elem, Emph):</span><br><span class="line">        <span class="keyword">return</span> Strikeout(*elem.content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">(doc=None)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> run_filter(action, doc=doc)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure></p>
<p>运行</p>
<p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">pandoc sometext.md --filter emph_so.py -t gfm -o filtered.md</span><br></pre></td></tr></table></figure></p>
<p>下面的文字可作为测试</p>
<p><figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line">这里有一句<span class="emphasis">*本来被强调的文字*</span>. 处理后会和这一段~~被删除的文字~~一样.</span><br></pre></td></tr></table></figure></p>
<h3>删除注释</h3>
<p>用的是Panflute GitHub repo里的例子<a href="https://github.com/sergiocorreia/panflute/blob/master/examples/panflute/comments.py" target="_blank" rel="noopener">comments.py</a>. 注意原链接17行(这里19行)应该是<code>el.format</code>, 而不是<code>doc.format</code>.</p>
<p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># filename: comments.py</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">Pandoc filter that causes everything between</span></span><br><span class="line"><span class="string">'&lt;!-- BEGIN COMMENT --&gt;' and '&lt;!-- END COMMENT --&gt;'</span></span><br><span class="line"><span class="string">to be ignored.  The comment lines must appear on</span></span><br><span class="line"><span class="string">lines by themselves, with blank lines surrounding</span></span><br><span class="line"><span class="string">them.</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> panflute <span class="keyword">as</span> pf</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">prepare</span><span class="params">(doc)</span>:</span></span><br><span class="line">    doc.ignore = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">comment</span><span class="params">(el, doc)</span>:</span></span><br><span class="line">    is_relevant = (type(el) == pf.RawBlock) <span class="keyword">and</span> (el.format == <span class="string">'html'</span>)</span><br><span class="line">    <span class="keyword">if</span> is_relevant <span class="keyword">and</span> re.search(<span class="string">"&lt;!-- BEGIN COMMENT --&gt;"</span>, el.text):</span><br><span class="line">        doc.ignore = <span class="literal">True</span></span><br><span class="line">    <span class="keyword">if</span> doc.ignore:</span><br><span class="line">        <span class="keyword">if</span> is_relevant <span class="keyword">and</span> re.search(<span class="string">"&lt;!-- END COMMENT --&gt;"</span>, el.text):</span><br><span class="line">            doc.ignore = <span class="literal">False</span></span><br><span class="line">        <span class="keyword">return</span> []</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    pf.toJSONFilter(comment, prepare=prepare)</span><br></pre></td></tr></table></figure></p>
<p>以下文字可供测试：</p>
<p><figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line"><span class="xml"><span class="comment">&lt;!-- BEGIN COMMENT --&gt;</span></span></span><br><span class="line"></span><br><span class="line">在这里的文字在经过comments.py过滤后会消失.</span><br><span class="line"></span><br><span class="line"><span class="xml"><span class="comment">&lt;!-- END COMMENT --&gt;</span></span></span><br></pre></td></tr></table></figure></p>
<h3>将所有标题上升一层</h3>
<p>自己的原始Markdown笔记都是以h1开始, 这样在LaTeX转化时可以正常转为section. 但Hexo博文正文标题是h2开始的, 因此将原始Markdown笔记转化为Hexo博文中需要修改标题层级结构</p>
<p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/local/bin/python3</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># filename: header-up.py</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">Set headers to 1 level higher.</span></span><br><span class="line"><span class="string">Remove h6, and add '.' at the end if there was no '.'</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> panflute <span class="keyword">import</span> Header, Para, run_filter, Block, Str</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">action</span><span class="params">(el, doc)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> isinstance(el, Header):</span><br><span class="line">        <span class="keyword">if</span> el.level &lt; <span class="number">6</span>:</span><br><span class="line">            el.level += <span class="number">1</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            _contents = el.content</span><br><span class="line">            _lastcont = _contents[<span class="number">-1</span>]</span><br><span class="line">            <span class="keyword">if</span> isinstance(_lastcont, Str):</span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">not</span> _lastcont.text.endswith(<span class="string">'.'</span>):</span><br><span class="line">                    _lastcont.text += <span class="string">'.'</span></span><br><span class="line">            <span class="keyword">return</span> Para(*el.content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">(doc=None)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> run_filter(action, doc=doc)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure></p>
<p>这段代码还处理了h6的特殊情况. 下面的文字可以作为测试</p>
<p><figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line"><span class="section"># was a level-1 header</span></span><br><span class="line"></span><br><span class="line"><span class="section">## was a level-2 header</span></span><br><span class="line"></span><br><span class="line"><span class="section">### was a level-3 header</span></span><br><span class="line"></span><br><span class="line"><span class="section">#### was a level-4 header</span></span><br><span class="line"></span><br><span class="line"><span class="section">##### was a level-5 header</span></span><br><span class="line"></span><br><span class="line"><span class="section">###### was a level-6 header</span></span><br></pre></td></tr></table></figure></p>
<h2>进阶尝试: 转换<code>&lt;badge /&gt;</code></h2>
<p>基于上面<a href="#%E5%88%A0%E9%99%A4%E6%B3%A8%E9%87%8A">删除注释</a>的例子, 写了一个这样的一个例子, 目的是将<code>&lt;badge id=id text=text /&gt;</code>形式的HTML文本转换为<code>&lt;span class=&quot;badge badge-id&quot;&gt;text&lt;/span&gt;</code>, 后者可以被Bootstrap CSS渲染. 代码如下</p>
<p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># filename: badge_span.py</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">Pandoc filter that turns the inline &lt;xxx id=id text=text /&gt;</span></span><br><span class="line"><span class="string">to &lt;span class="xxx xxx-id"&gt;text&lt;/span&gt;</span></span><br><span class="line"><span class="string">xxx equals to 'badge, label' currently</span></span><br><span class="line"><span class="string">text should have no space</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> panflute <span class="keyword">as</span> pf</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">extract_id_text</span><span class="params">(raw_inline)</span>:</span></span><br><span class="line">    <span class="string">'''return (id, string) tuple</span></span><br><span class="line"><span class="string">    '''</span></span><br><span class="line">    _ide = <span class="string">''</span></span><br><span class="line">    _str = <span class="string">''</span></span><br><span class="line">    iden = re.findall(<span class="string">'(id=[\"\']?\w+[\"\']?[ ]*[/&gt;]?)'</span>, raw_inline)</span><br><span class="line">    text = re.findall(<span class="string">'(text=[\"\']?\w+[\"\']?[ ]*[/&gt;]?)'</span>, raw_inline)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> len(iden) != <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">if</span> iden[<span class="number">0</span>] != <span class="string">''</span>:</span><br><span class="line">            _ide = iden[<span class="number">0</span>][<span class="number">3</span>:<span class="number">-1</span>].strip()</span><br><span class="line">    <span class="keyword">if</span> len(text) != <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">if</span> text[<span class="number">0</span>] != <span class="string">''</span>:</span><br><span class="line">            _str = text[<span class="number">0</span>][<span class="number">5</span>:<span class="number">-1</span>].strip()</span><br><span class="line"></span><br><span class="line">    _ret = [_ide, _str]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i, token <span class="keyword">in</span> enumerate(_ret):</span><br><span class="line">        <span class="keyword">if</span> token != <span class="string">''</span>:</span><br><span class="line">            <span class="keyword">if</span> token.startswith((<span class="string">"\'"</span>, <span class="string">"\""</span>)):</span><br><span class="line">                _ret[i] = _ret[i][<span class="number">1</span>:]</span><br><span class="line">            <span class="keyword">if</span> token.endswith((<span class="string">"\'"</span>, <span class="string">"\""</span>)):</span><br><span class="line">                _ret[i] = _ret[i][:<span class="number">-1</span>]</span><br><span class="line">    <span class="keyword">return</span> tuple(_ret)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">rawinline_label_badge</span><span class="params">(el, doc)</span>:</span></span><br><span class="line">    is_rawinline = isinstance(el, pf.RawInline) <span class="keyword">and</span> (el.format == <span class="string">'html'</span>)</span><br><span class="line">    <span class="keyword">if</span> is_rawinline:</span><br><span class="line">        <span class="keyword">if</span> re.match(<span class="string">"&lt;label"</span>, el.text) <span class="keyword">or</span> re.match(<span class="string">"&lt;badge"</span>, el.text):</span><br><span class="line">            __cls = re.findall(<span class="string">'(&lt;\w+)'</span>, el.text)</span><br><span class="line">            __cls[<span class="number">0</span>] = __cls[<span class="number">0</span>][<span class="number">1</span>:]</span><br><span class="line">            identi, text = extract_id_text(el.text)</span><br><span class="line">            <span class="keyword">if</span> identi != <span class="string">''</span>:</span><br><span class="line">                __cls.append(__cls[<span class="number">0</span>] + <span class="string">'-'</span> + identi)</span><br><span class="line">            <span class="keyword">return</span> pf.Span(pf.Str(text), classes=__cls)</span><br><span class="line">    <span class="keyword">return</span> el</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    pf.toJSONFilter(rawinline_label_badge)</span><br></pre></td></tr></table></figure></p>
<p>由于转化基于<code>RawInline</code>对象, 所以单独为一行的badge或者label是无法正常转化的. 例如</p>
<p><figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line">右侧两个是可以的 <span class="xml"><span class="tag">&lt;<span class="name">badge</span> <span class="attr">id</span>=<span class="string">"warn"</span> <span class="attr">text</span>=<span class="string">"badge-warn"</span>&gt;</span></span> <span class="xml"><span class="tag">&lt;<span class="name">badge</span> <span class="attr">id</span>=<span class="string">"info"</span> <span class="attr">text</span>=<span class="string">"badge-info"</span>&gt;</span></span></span><br></pre></td></tr></table></figure></p>
<p>下面有一个单独成行的<code>badge-danger</code>是在这个脚本下是渲染不出来的.</p>
<p><figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">badge</span> <span class="attr">id</span>=<span class="string">"danger"</span> <span class="attr">text</span>=<span class="string">"单独成行的badge-danger"</span>&gt;</span></span></span><br></pre></td></tr></table></figure></p>
<h2>过滤器调试</h2>
<p>直接用<code>--filter</code>选项套用过滤器比较难调试. 可以用以下方法来调试, 其中pandoc输出格式必须作为过滤器的第一个变量声明.</p>
<p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">pandoc -t json | ./filter.py latex | pandoc -f json -t latex</span><br></pre></td></tr></table></figure></p>
<p>等价于</p>
<p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">pandoc --filter./filter.py -f json -t latex</span><br></pre></td></tr></table></figure></p>
<p>也可以使用<code>convert_text</code>来检查自己对一段文字的AST的理解</p>
<p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> panflute <span class="keyword">import</span> *</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>tag1 = <span class="string">'Some #Tag(abc, cde)'</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>convert_text(tag1)</span><br><span class="line">[Para(Str(Some) Space Str(<span class="comment">#Tag(abc,) Space Str(cde)))]</span></span><br></pre></td></tr></table></figure></p>
<h2>实际例子: 转化行内带<code>#</code>的标签</h2>
<p>这个例子的目的是转化<code>#anytag(date, mood)</code>到HTML源码</p>
<p><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"badge badge-tag"</span>&gt;</span>#anytag(date, mood)<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>之所以想做这个转化是因为在笔记软件里会用<code>#tag</code>做笔记分类, 想在转化时把这个tag转化成bootstrap的徽章, 这样在借助HTML转化时就能用BS渲染标签.</p>
<p>在上面过滤器调试的<code>tag1</code>例子里, 我们看到如果<code>date</code>和<code>mod</code>之间如果有空格时, 上面的tag会转化成两个<code>[Str Space Str]</code>. 这个时候就要用到前面<code>comments.py</code>中的<code>doc.ignore</code>来判断一个标签是否完成, 以及处理中间出现的空间.</p>
<p>最后的代码如下</p>
<p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/local/bin/python3</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># filename: tag_span.py</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">Pandoc filter that turns</span></span><br><span class="line"><span class="string">   "#XXX(...)" to '&lt;span class="badge badge-warn"&gt;#XXX(...)&lt;/span&gt;'</span></span><br><span class="line"><span class="string">and</span></span><br><span class="line"><span class="string">   "@XXX(...)" to &lt;span class="badge badge-info"&gt;@XXX(...)&lt;/span&gt;</span></span><br><span class="line"><span class="string">letters, numbers, comas, underscore, hyphon and space are allowed in the parenthese</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> panflute <span class="keyword">as</span> pf</span><br><span class="line"></span><br><span class="line">str_to_replace = <span class="string">''</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">prepare</span><span class="params">(doc)</span>:</span></span><br><span class="line">    <span class="string">'''ignore represents whether in the tag/people environment</span></span><br><span class="line"><span class="string">    '''</span></span><br><span class="line">    doc.ignore = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">convert_tag_people</span><span class="params">(el, doc)</span>:</span></span><br><span class="line"></span><br><span class="line">    dict_tag_people = &#123;<span class="string">"#"</span>: <span class="string">"warn"</span>, <span class="string">"@"</span>: <span class="string">"info"</span>&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">global</span> str_to_replace</span><br><span class="line">    is_str = isinstance(el, pf.Str)</span><br><span class="line">    <span class="keyword">if</span> is_str:</span><br><span class="line">        _text = el.text</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> doc.ignore:</span><br><span class="line">            <span class="comment"># outside the tag/people, check if meet a tag/people</span></span><br><span class="line">            <span class="keyword">if</span> re.fullmatch(<span class="string">"[#@][\w-]+\([\w,-]*\)"</span>, _text):</span><br><span class="line">                <span class="comment"># direct return the span if the string has both left parenthese and right parenthese</span></span><br><span class="line">                str_to_replace = <span class="string">''</span></span><br><span class="line">                <span class="keyword">return</span> pf.Span(pf.Str(_text), \</span><br><span class="line">                        classes=[<span class="string">"badge"</span>, <span class="string">"badge"</span>+<span class="string">'-'</span>+dict_tag_people[_text[<span class="number">0</span>]]])</span><br><span class="line">            <span class="keyword">if</span> re.fullmatch(<span class="string">"[#@][\w-]+"</span>, _text):</span><br><span class="line">                <span class="comment"># direct return span if the string has noparenthese</span></span><br><span class="line">                str_to_replace = <span class="string">''</span></span><br><span class="line">                <span class="keyword">return</span> pf.Span(pf.Str(_text), \</span><br><span class="line">                        classes=[<span class="string">"badge"</span>, <span class="string">"badge"</span>+<span class="string">'-'</span>+dict_tag_people[_text[<span class="number">0</span>]]])</span><br><span class="line">            <span class="keyword">if</span> re.fullmatch(<span class="string">"[#@][\w-]+\([\w,-]*"</span>, _text):</span><br><span class="line">                <span class="comment"># string with left parenthese in it, but with no right parenthese</span></span><br><span class="line">                <span class="comment"># initialize the str_to_replace</span></span><br><span class="line">                str_to_replace = _text</span><br><span class="line">                doc.ignore = <span class="literal">True</span></span><br><span class="line">                <span class="keyword">return</span> []</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="comment"># inside the tag/people, check if the tag/people string ends.</span></span><br><span class="line">            <span class="comment"># Found right parenthese at the end, return the whole string</span></span><br><span class="line">            <span class="keyword">if</span> re.fullmatch(<span class="string">"[^#@][\w,-]+\)"</span>, _text):</span><br><span class="line">                doc.ignore = <span class="literal">False</span></span><br><span class="line">                str_to_replace += _text</span><br><span class="line">                new_Str = pf.Str(str_to_replace)</span><br><span class="line">                <span class="keyword">return</span> pf.Span(new_Str, \</span><br><span class="line">                        classes=[<span class="string">"badge"</span>, <span class="string">"badge"</span>+<span class="string">'-'</span>+dict_tag_people[str_to_replace[<span class="number">0</span>]]])</span><br><span class="line"></span><br><span class="line">            <span class="comment"># no right parenthese found, purge it to str_to_replace, return empty element</span></span><br><span class="line">            str_to_replace += _text</span><br><span class="line">            <span class="keyword">return</span> []</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="comment"># Not a normal string. If within the tag/people and is a space, add space to str_to_replace</span></span><br><span class="line">        <span class="comment"># otherwise, just give it back to AST</span></span><br><span class="line">        <span class="keyword">if</span> doc.ignore:</span><br><span class="line">            <span class="keyword">if</span> isinstance(el, pf.Space):</span><br><span class="line">                str_to_replace += <span class="string">' '</span></span><br><span class="line">            <span class="keyword">return</span> []</span><br><span class="line">    <span class="keyword">return</span> el</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    pf.toJSONFilter(convert_tag_people, prepare=prepare)</span><br></pre></td></tr></table></figure></p>
<p>这个脚本里还对<code>@</code>开头做进行了同样处理, 在Agenda里它用来代表人名. 尝试转化下面的文字:</p>
<p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Tags: #todo , #todo() , #todo(today) , #todo(today, tomorrow)</span><br><span class="line">People: @todo , @todo() , @todo(today) , @todo(today, tomorrow)</span><br></pre></td></tr></table></figure></p>
<p>转化结果</p>
<p><figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line">Tags: <span class="xml"><span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"badge badge-warn"</span>&gt;</span></span>\#todo<span class="xml"><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span> ,</span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"badge badge-warn"</span>&gt;</span></span>\#todo()<span class="xml"><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span> ,</span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"badge badge-warn"</span>&gt;</span></span>\#todo(today)<span class="xml"><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span> ,</span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"badge badge-warn"</span>&gt;</span></span>\#todo(today, tomorrow)<span class="xml"><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span></span><br><span class="line"></span><br><span class="line">People: <span class="xml"><span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"badge badge-info"</span>&gt;</span></span>@todo<span class="xml"><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span> ,</span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"badge badge-info"</span>&gt;</span></span>@todo<span class="xml"><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span>() ,</span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"badge badge-info"</span>&gt;</span></span>@todo<span class="xml"><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span>(today) ,</span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"badge badge-info"</span>&gt;</span></span>@todo<span class="xml"><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span>(today, tomorrow)</span><br></pre></td></tr></table></figure></p>
<p>可以看到以<code>#</code>为前缀的都正确转化了, 而以<code>@</code>前缀的, 含括号的字符串都没有正确转化.</p>
<p>由于在<code>re.fullmatch</code>中<code>#</code>和<code>@</code>是同样处理的, 出现这种情形只有可能是在<code>pf.Span</code>转化字符串时对<code>#</code>和<code>@</code>做了区别对待. 为了验证, 我们看一下<code>convert_text</code>的结果</p>
<p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>md2 = <span class="string">"@todo(today, tomorrow)"</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>convert_text(md2)</span><br><span class="line">[Para(Cite(Str(@todo)) Str((today,) Space Str(tomorrow)))]</span><br></pre></td></tr></table></figure></p>
<p>可见<code>Str</code>对象<code>@todo</code>是<code>Cite</code>对象的子对象, 跟括号所含字符串对应的<code>Str</code>完全分开了, 而我上面的代码没有考虑这个问题.</p>
<h2>总结</h2>
<p>本文基于panflute编写了几个pandoc过滤器, 用途包括将原始Markdown标题结构转化为适用于Hexo博文的, 将<code>#tag</code>形式的标签转化为可用Bootstrap CSS渲染的HTML源码.</p>

	
	</div>
  <!-- categories -->
  <span style="font-size:90%">
  
  <i style="color:#bbb" class="fa fa-folder"></i> <a style="color:#bbb" href="/categories/Software/">Software</a>
  </span>
  &nbsp
  <!-- tags -->
  <span style="font-size:90%" >
  
  <a style="color:#bbb" href="/tags/Pandoc/">#Pandoc</a>&nbsp&nbsp<a style="color:#bbb" href="/tags/Panflute/">#Panflute</a>&nbsp&nbsp<a style="color:#bbb" href="/tags/AST/">#AST</a>
  </span>
  <!-- read more button -->
  <a type="button" href="/2019/01/05/panflute_practice/#more" class="pull-right btn btn-default more">Read More</a>
</div>

		

		</div>

		<!-- pagination -->
		<div>
  		<center>
		<div class="pagination">
<ul class="pagination">
	 
		
    	<li class="prev"><a href="/page/5/" class="alignleft prev"><i class="fa fa-arrow-circle-o-left"></i> Prev</a></li>
  		

        <li><a href="/"><i class="fa fa-home"></i>Home</a></li>

		
		   <li class="next"> <a href="/page/7/" class="alignright next">Next<i class="fa fa-arrow-circle-o-right"></i></a> </li>          
        
	
</ul>
</div>

  		</center>
		</div>

		
		
	</div> <!-- col-md-9 -->

	
		<div class="col-md-3">
	<div id="sidebar">
	
			
  <div id="site_search">
   <div class="form-group">
    <input type="text" id="local-search-input" name="q" results="0" placeholder="Search" class="st-search-input st-default-search-input form-control"/>
   </div>  
  <div id="local-search-result"></div>
  </div>


		
			
	<div class="widget">
		<h4>Categories</h4>
		<ul class="tag_box inline list-unstyled">
		
			<li><a href="/categories/Algorithm/">Algorithm<span class="badge">2</span></a></li>
		
			<li><a href="/categories/Comment/">Comment<span class="badge">2</span></a></li>
		
			<li><a href="/categories/Programming/">Programming<span class="badge">7</span></a></li>
		
			<li><a href="/categories/Software/">Software<span class="badge">26</span></a></li>
		
		</ul>
	</div>


		
			




	<div class="widget">
		<h4>Tag Cloud</h4>
		<ul class="tag_box inline list-unstyled">		
		
			<li><a href="/tags/FFTW/">FFTW<span class="badge">1</span></a></li>
		
			<li><a href="/tags/Jupyter/">Jupyter<span class="badge">1</span></a></li>
		
			<li><a href="/tags/Tutorial/">Tutorial<span class="badge">1</span></a></li>
		
			<li><a href="/tags/GPAW/">GPAW<span class="badge">5</span></a></li>
		
			<li><a href="/tags/XmGrace/">XmGrace<span class="badge">1</span></a></li>
		
			<li><a href="/tags/pyecharts/">pyecharts<span class="badge">1</span></a></li>
		
			<li><a href="/tags/LIBXC/">LIBXC<span class="badge">1</span></a></li>
		
			<li><a href="/tags/Youtube/">Youtube<span class="badge">1</span></a></li>
		
			<li><a href="/tags/Grid-technique/">Grid technique<span class="badge">1</span></a></li>
		
			<li><a href="/tags/TaskPaper/">TaskPaper<span class="badge">1</span></a></li>
		
			<li><a href="/tags/regex/">regex<span class="badge">1</span></a></li>
		
			<li><a href="/tags/Make/">Make<span class="badge">1</span></a></li>
		
			<li><a href="/tags/Afloatx/">Afloatx<span class="badge">1</span></a></li>
		
			<li><a href="/tags/Blogging/">Blogging<span class="badge">1</span></a></li>
		
			<li><a href="/tags/SOC/">SOC<span class="badge">1</span></a></li>
		
			<li><a href="/tags/Panflute/">Panflute<span class="badge">1</span></a></li>
		
		
		   <li><a href="/tags">...<span class="badge">55</span></a></li>
		 
		</ul>
	</div>


		
			
<div class="widget">
	<h4>Links</h4>
	<ul class="blogroll list-unstyled">
	
		<li><i class="fa fa-github-square"></i><a href="https://github.com/minyez" title="My Github account." target="_blank"]);">Github-minyez</a></li>
	
		<li><i class="fa fa-book"></i><a href="https://www.douban.com/people/shigaro" title="My DouBan account" target="_blank"]);">DouBan - Shigaro</a></li>
	
		<li><i class="fa fa-book"></i><a href="https://bookmeter.com/users/1169010" title="My Bookmeter account" target="_blank"]);">読書メーター - minyez</a></li>
	
		<li><i class="fa fa-mail-forward"></i><a href="mailto:zmysmile0929@163.com" title="Send Email to me" target="_blank"]);">Email</a></li>
	
		<li><i class="fa fa-code"></i><a href="https://github.com/minyez/minyez.github.io/tree/hexo" title="Source codes of this site" target="_blank"]);">Site source</a></li>
	
		<li><i class="fa fa-rss"></i><a href="atom.xml" title="atom rss" target="_blank"]);"> RSS</a></li>
	
	</ul>
</div>


		
	</div> <!-- sidebar -->
</div> <!-- col-md-3 -->

	
	
</div> <!-- row-fluid -->

	</div>
  </div>
  <div class="container-narrow">
  <footer> <p>
  
  &copy; 2020 by <a href="http://shigaro.org"> minyez </a>
  
    | <a href="http://github.com/minyez/hexo-theme-freemind/">Theme</a> based on two Freemind themes by <a href="https://github.com/wzpan/hexo-theme-freemind/">wzpan</a> and <a href="https://github.com/PytLab/hexo-theme-freemind/">PytLab</a> 
    | Powered by <a href="https://github.com/hexojs/hexo">Hexo</a>
  
    <span id="busuanzi_container_site_uv">| <span id="busuanzi_value_site_uv"></span> visitors</span>
  
  
	| <span class="post-count">54.3k</span> words
  
</p>
 </footer>
</div> <!-- container-narrow -->
  


  
<a id="gotop" href="#">   
  <span>▲</span> 
</a>

<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/bootstrap.min.js"></script>
<script src="/js/main.js"></script>
<script src="/js/search.js"></script> 


<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>



   <script type="text/javascript">      
     var search_path = "search.xml";
	 if (search_path.length == 0) {
	 	search_path = "search.xml";
	 }
	 var path = "/" + search_path;
     searchFunc(path, 'local-search-input', 'local-search-result');
   </script>


<!-- Global site tag (gtag.js) - Google Analytics -->
<!--    added 2018-07-12 -->
<!-- modified 2019-05-10 -->

<script async src="https://www.googletagmanager.com/gtag/js?id=UA-111612868-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-111612868-1');
</script>


<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ["$","$"], ["\\(","\\)"] ],
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
            processEscapes: true
        },
        TeX: {equationNumbers: { autoNumber: "AMS" }}
    });
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax();
        for (var i = 0; i < all.length; ++i)
            all[i].SourceElement().parentNode.className += ' has-jax';
    });
</script>
<!--<script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>-->
<script type="text/javascript" async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

</body>
   </html>
