<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Page 2 | Shigaro</title>
  <meta name="author" content="minyez">
  
  <meta name="description" content="minyez&#39;s blog on life, science and programming">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  
  <meta property="og:site_name" content="Shigaro"/>

  
    <meta property="og:image" content=""/>
  

  
  
    <link href="/assets/images/favicon/icon.png" rel="icon">
  
  
  <link rel="stylesheet" href="/css/bootstrap.min.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/bootstrap.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/font-awesome.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/responsive.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/highlight.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/google-fonts.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

  <script src="/js/jquery-2.0.3.min.js"></script>

  <!-- analytics -->
  
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-111612868-1', 'auto');
  ga('send', 'pageview');
</script>





<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js">
</script>



</head>

 <body 
>
  <nav id="main-nav" class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <button type="button" class="navbar-header navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
      <span class="sr-only">Toggle navigation</span>
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
    </button>
    <a class="navbar-brand" href="/"></a>
    <div class="collapse navbar-collapse nav-menu">
      <ul class="nav navbar-nav">
        

        <!-- Categories -->
        
        <li>
          <a href="/" title="Shigaro's Home"
            style="font-weight: normal; font-family: Calibri,Arial; font-size: 18px">
            <i class="fa fa-bank"></i>Home
          </a>
        </li>
        
        

        <!-- Categories -->
        
        <!-- Archives -->
        <li>
          <a href="/archives" title="All the articles."
            style="font-weight: normal; font-family: Calibri,Arial; font-size:     18px">
            <i class="fa fa-archive"></i>Archives
          </a>
        </li>
        
        

        <!-- Categories -->
        
        <!-- Tags -->
        <li>
          <a href="/tags" title="All the tags."
            style="font-weight: normal; font-family: Calibri,Arial; font-size:     18px">
            <i class="fa fa-tags"></i>Tags
          </a>
        </li>
        
        

        <!-- Categories -->
        
        <li class="dropdown">
          <a href="/categories" class="dropdown-toggle" data-toggle="dropdown" title="All the categories."
            style="font-weight: normal; font-family: Calibri,Arial; font-size:     18px">
            <i class="fa fa-folder"></i>Categories
            <b class="caret"></b>
          </a>
          <ul class="dropdown-menu">
            <li class="divider"></li>
            <li><a href="/categories" style="font-size: 20px; font-family: 'Calibri Light',Arial">All
                Categories</a><span></span></li>
            <li class="divider"></li>
            
            <li><a href="/categories/Software/"
                style="font-size: 15px; font-family: 微软雅黑">Software<span></span></a></li>
            
            <li><a href="/categories/Programming/"
                style="font-size: 15px; font-family: 微软雅黑">Programming<span></span></a></li>
            
            <li><a href="/categories/Comment/"
                style="font-size: 15px; font-family: 微软雅黑">Comment<span></span></a></li>
            
            <li><a href="/categories/Algorithm/"
                style="font-size: 15px; font-family: 微软雅黑">Algorithm<span></span></a></li>
            
            <li class="divider"></li>
          </ul>
        </li>
        
        

        <!-- Categories -->
        
        <li>
          <a href="/about" title="About me."
            style="font-weight: normal; font-family: Calibri,Arial; font-size: 18px">
            <i class="fa fa-user"></i>About
          </a>
        </li>
        
        
      </ul>
    </div>
  </div> <!-- container -->
</nav>
<div class="clearfix"></div>
  <div class="container">
  	<div class="content">
    	 <div class="page-header">
  <h1 class="home-title">Shigaro</h1>
</div>

<div class="row page">

	
	<div class="col-md-9">
	

		<div class="slogan">
      <i class="fa fa-code"></i>
      朝日が昇る　私は旅する
</div>    

		<div id="top_search"></div>
		<div class="mypage">
		
		<!-- title and entry -->
		
			
	
	<!-- display as entry -->	
		<h3 class="title">
			<div class="date"> 2020-07-01 </div>
			<div class="article-title"><a href="/2020/07/01/emacs-1/" >Emacs 笔记 (一) —— 安装与配置 Doom Emacs</a></div>						
		</h3>
	


			<div class="entry">
  <div class="row">
	
	
		<link rel="stylesheet" type="text/css" href="/css/hint.min.css"><p><div class="alert alert-warning"><i class="fa fa-bell  float-left"></i>  <p>记录从零开始的 Emacs. 目标是熟练地使用 Org-roam 编辑个人维基!</p>
</div>
&lt;!-- more --&gt;</p>
<h2>前言</h2>
<p>因缘巧合, 今日我在搜索转化$\rm\LaTeX$到MathML的解决方案时, 偶然看到了<a href="https://github.com/org-roam/org-roam" target="_blank" rel="noopener">Org-roam</a>项目. 它的个人知识库构建和展示方式引起了我很大的兴趣.</p>
<p>Org-roam 基于 Emacs 的 Org-mode, 后者是 Emacs 中纯文本笔记管理+GTD+写作系统. &quot;Org&quot; 指代 organize, &quot;roam&quot; 则取自<a href="https://roamresearch.com/" target="_blank" rel="noopener">Roam Research</a>. Org-roam 采纳了 <a href="https://zettelkasten.de/" target="_blank" rel="noopener">Zettelkasten笔记法</a>的思想.&lt;sup id=&quot;fnref:1&quot;&gt;&lt;a href=&quot;#fn:1&quot; rel=&quot;footnote&quot;&gt;&lt;span class=&quot;hint--top hint--error hint--medium hint--rounded hint--bounce&quot; aria-label=&quot;Zettelkasten是一个德语词, 对应英语slip box, 类似于图书馆存放索引卡的盒子.&quot;&gt;[1]&lt;/span&gt;&lt;/a&gt;&lt;/sup&gt; 这种方法认为知识不是层级化的而是扁平化的, 重要的是知识之间的关联. 这种关联通过笔记中用<code>[[...]]</code>包围的关键词建立. Org-roam能对这种连接进行可视化.</p>
<p><figure class="null"><img src="org-roam-graph-demo.png" alt="Graph view, from Org-roam GitHub site"><figcaption>Graph view, from Org-roam GitHub site</figcaption></figure></p>
<p>相比较其他 Zettelkasten 实现, Org-roam 的特点是</p>
<ol>
<li>完全免费开源, 数据库本地存储而不是封存托管在企业云端数据库.</li>
<li>基于 Org-mode 纯文本系统, 可利用 Emacs 生态扩展.</li>
<li>配置复杂, 学习曲线陡峭.</li>
</ol>
<p>一直以来也接触过挺多笔记记录的方式, Agenda, Bear, OneNote, Notion, 甚至是本地文件夹, 但总是觉得不得劲. 现在又多了这样一种选择, 自然还是想试一下. 然而作为 Vim 用户, 第一个应该跨过的关卡应该是 Emacs 的基本使用. 现在就说道说道吧.</p>
<h2>安装</h2>
<h3>Doom Emacs</h3>
<p>从安装开始. 为免去 Emacs 基本设置, 在<a href="https://www.youtube.com/watch?v=Lg61ocfxk3c" target="_blank" rel="noopener">Matt Williams</a>的推荐下安装 <a href="https://github.com/d12frosted/homebrew-emacs-plus" target="_blank" rel="noopener">emacs-plus</a> 和 <a href="https://github.com/hlissner/doom-emacs" target="_blank" rel="noopener">Doom Emacs</a>. 通过 Homebrew 安装 Emacs</p>
<p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">brew tap d12frosted/emacs-plus</span><br><span class="line"><span class="meta">#</span><span class="bash"> 若出现403错误, 在前面加上all_proxy=socks5://127.0.0.1:1086</span></span><br><span class="line">brew install emacs-plus@27 --with-modern-icon-cg433n</span><br><span class="line">ln -s /usr/local/opt/emacs-plus/Emacs.app /Applications/Emacs.app</span><br></pre></td></tr></table></figure></p>
<p>完成后再从 GitHub 安装 Doom Emacs</p>
<p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">git clone --depth 1 https://github.com/hlissner/doom-emacs ~/.emacs.d</span><br><span class="line">~/.emacs.d/bin/doom install</span><br></pre></td></tr></table></figure></p>
<p>此时命令行打开 Emacs, 可以看到下面这样十分炫酷的界面. 这跟我印象里面一个大白框UI迥然不同.</p>
<p><figure class="null"><img src="doom-ui.png" alt="Doom Emacs UI"><figcaption>Doom Emacs UI</figcaption></figure></p>
<p>Doom Emacs 安装完后, 编辑 <code>~/.doom.d/</code> 下 <code>init.el</code> 文件, 打开或关闭一些 Doom 模块. 一些模块包含可选功能, 需要通过 <code>+</code> 指定, 例如打开 <a href="https://orgmode.org/" target="_blank" rel="noopener">Org-mode</a> 的可选功能</p>
<p><figure class="highlight lisp"><table><tr><td class="code"><pre><span class="line">(<span class="name">doom!</span> <span class="symbol">:lang</span></span><br><span class="line">  (<span class="name">org</span> +brain</span><br><span class="line">       +dragdrop</span><br><span class="line">       +gnuplot</span><br><span class="line">       +jupyter)      <span class="comment">; organize your plain life in plain text</span></span><br><span class="line">  )</span><br></pre></td></tr></table></figure></p>
<p>在 <code>~/.doom.d/packages.el</code> 下用 <code>package!</code> 命令指定安装 ELPA/MELPA 上的插件包,&lt;sup id=&quot;fnref:2&quot;&gt;&lt;a href=&quot;#fn:2&quot; rel=&quot;footnote&quot;&gt;&lt;span class=&quot;hint--top hint--error hint--medium hint--rounded hint--bounce&quot; aria-label=&quot;ELPA: 全称Emacs Lisp Package Archive, Emacs默认的软件包存储库. MELPA = Milkypostman ELPA&quot;&gt;[2]&lt;/span&gt;&lt;/a&gt;&lt;/sup&gt; 例如</p>
<p><figure class="highlight lisp"><table><tr><td class="code"><pre><span class="line"><span class="comment">;; 安装ELPA或者MELPA上的包</span></span><br><span class="line">(<span class="name">package!</span> markdown-mode)</span><br><span class="line"><span class="comment">;; 从GitHub仓库安装最新版markdown-mode</span></span><br><span class="line">(<span class="name">package!</span> markdown-mode</span><br><span class="line"> <span class="symbol">:recipe</span> (<span class="symbol">:host</span> github <span class="symbol">:repo</span> jrblevin/markdown-mode))</span><br></pre></td></tr></table></figure></p>
<p>设置完后运行</p>
<p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">~/.emacs.d/bin/doom sync</span><br></pre></td></tr></table></figure></p>
<p>以应用两个文件的变化. 如果遇到安装问题, 可在 <code>packages.el</code> 中注释掉对应代码, 命令行执行</p>
<p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">doom purge</span><br></pre></td></tr></table></figure></p>
<p>卸载程序包, 再反注释掉, 重新安装即可.</p>
<h3>Org-roam</h3>
<p>Org-roam 的安装可以采用 <code>+</code> 方式安装 (<a href="https://orgroam.slack.com/archives/CV160S8EL/p1590857012127400" target="_blank" rel="noopener">slack讨论</a>)</p>
<p><figure class="highlight lisp"><table><tr><td class="code"><pre><span class="line">(<span class="name">doom!</span> <span class="symbol">:lang</span></span><br><span class="line">  (<span class="name">org</span> +roam)</span><br><span class="line">  )</span><br></pre></td></tr></table></figure></p>
<p>也可以在 <code>packags.el</code> 中加入</p>
<p><figure class="highlight lisp"><table><tr><td class="code"><pre><span class="line">(<span class="name">package!</span> org-roam)</span><br><span class="line">(<span class="name">package!</span> company-org-roam) <span class="comment">;org-roam相关的代码补全</span></span><br></pre></td></tr></table></figure></p>
<p>安装. 随后在 <code>config.el</code> 中用 <code>use-package!</code> 函数配置</p>
<p><figure class="highlight lisp"><table><tr><td class="code"><pre><span class="line">(<span class="name">use-package!</span> org-roam</span><br><span class="line">  <span class="symbol">:commands</span> (<span class="name">org-roam-insert</span> org-roam-find-file org-roam)</span><br><span class="line">  <span class="symbol">:init</span></span><br><span class="line">  (<span class="name">setq</span> org-roam-directory <span class="string">"~/Documents/SelfDevelopment/org-roam/"</span>)</span><br><span class="line">  (<span class="name">setq</span> org-roam-graph-viewer <span class="string">"/usr/bin/open"</span>)</span><br><span class="line">  (<span class="name">map!</span> <span class="symbol">:leader</span></span><br><span class="line">  <span class="symbol">:prefix</span> <span class="string">"r"</span></span><br><span class="line">  <span class="symbol">:desc</span> <span class="string">"Org-Roam-Insert"</span> <span class="string">"i"</span> #'org-roam-insert</span><br><span class="line">  <span class="symbol">:desc</span> <span class="string">"Org-Roam-Find"</span>   <span class="string">"/"</span> #'org-roam-find-file</span><br><span class="line">  <span class="symbol">:desc</span> <span class="string">"Org-Roam-Buffer"</span> <span class="string">"r"</span> #'org-roam)</span><br><span class="line">  <span class="symbol">:config</span></span><br><span class="line">  (<span class="name">org-roam-mode</span> <span class="number">+1</span>))</span><br><span class="line">(<span class="name">add-hook</span> 'after-init-hook 'org-roam-mode)</span><br></pre></td></tr></table></figure></p>
<p>随后打开 Emacs, <code>M-x org-roam-find-file</code> 或 <code>SPC r /</code>, 会检查 <code>org-roam-directory</code> 下的所有 org 文件. 输出文件名进行编辑或者新建</p>
<p><figure class="null"><img src="first_file.png" alt=" "><figcaption> </figcaption></figure></p>
<p>编辑完后 <code>C-c C-c</code> 保存. 对于 config 中不了解的函数, 可以输入 <code>SPC(空格) h f</code> 来查询.</p>
<p>更进一步的 Org-mode, Org-roam 配置和使用将会在今后的文章中记录. 在本文接下来部分中仅涉及 Emacs 编辑和指令的基本使用.</p>
<h2>Emacs使用</h2>
<p><a href="https://www.youtube.com/watch?v=rCMh7srOqvw&amp;list=PLhXZp00uXBk4np17N39WvB80zgxlZfVwj" target="_blank" rel="noopener">Zaiste</a> 制作了一系列非常好的 Youtube 视频介绍 Doom Emacs 和 Org-mode 的使用, 这里的记录基本上是练习他的 Doom 视频内容的整理.</p>
<h3>文件操作</h3>
<p>Dired 模式下可以对文件夹与文件进行操作.</p>
<table>
<thead>
<tr>
<th>Key</th>
<th>功能</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>-</code>/<code>RET</code></td>
<td>进入上层/子文件夹</td>
</tr>
<tr>
<td><code>+</code></td>
<td>新建文件夹</td>
</tr>
<tr>
<td><code>d x</code></td>
<td>标记要删除的文件(夹), 执行删除</td>
</tr>
<tr>
<td><code>o</code></td>
<td>排序</td>
</tr>
<tr>
<td><code>M</code></td>
<td>修改文件权限</td>
</tr>
<tr>
<td><code>O</code></td>
<td>修改文件owner</td>
</tr>
<tr>
<td><code>m</code>/<code>u</code></td>
<td>选择/取消选择文件</td>
</tr>
<tr>
<td><code>U</code></td>
<td>取消所有选择</td>
</tr>
<tr>
<td><code>R</code></td>
<td>重命名/移动文件</td>
</tr>
<tr>
<td><code>C</code></td>
<td>复制文件</td>
</tr>
<tr>
<td><code>c</code></td>
<td>压缩选中文件</td>
</tr>
</tbody>
</table>
<h3>常用键位和命令</h3>
<table>
<thead>
<tr>
<th>Key</th>
<th>功能</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>SPC .</code></td>
<td>打开或创建文件 (在文本编辑模式下直接回车, 相当于Vim的<code>:q</code>)</td>
</tr>
<tr>
<td><code>SPC f r</code></td>
<td>打开最近文件</td>
</tr>
<tr>
<td><code>SPC o i</code></td>
<td>在iTerm中打开当前文件夹</td>
</tr>
<tr>
<td>修饰键<code>C</code></td>
<td>Mac上为Ctrl键</td>
</tr>
<tr>
<td>修饰键<code>M</code></td>
<td>Mac上为Alt键 (在Doom中如果是第一个输入, CMD键也可以)</td>
</tr>
<tr>
<td>修饰键<code>s</code></td>
<td>Mac上为CMD键</td>
</tr>
<tr>
<td><code>M-x shell</code></td>
<td>在Emacs中打开shell(全屏)</td>
</tr>
<tr>
<td><code>SPC o T</code></td>
<td>在Emacs中打开vterm(全屏)</td>
</tr>
<tr>
<td><code>SPC o t</code></td>
<td>在Emacs中弹出vterm小窗</td>
</tr>
</tbody>
</table>
<p>如果想将vterm的默认shell设为zsh需要在<code>config.el</code>中加入</p>
<p><figure class="highlight lisp"><table><tr><td class="code"><pre><span class="line"><span class="comment">;; set zsh to default shell of vterm</span></span><br><span class="line">(<span class="name">use-package!</span> vterm</span><br><span class="line">  <span class="symbol">:config</span></span><br><span class="line">  (<span class="name">setq</span> vterm-shell <span class="string">"zsh"</span>))</span><br></pre></td></tr></table></figure></p>
<p>此时可以用 <code>SPC o T</code> 打开 vterm, 使用的是 zsh.</p>
<h3>缓冲区和窗口操作</h3>
<p>和 Vim 类似, 打开文件时, Emacs 会打开一个缓冲区 (buffer), 载入当前文件的所有内容. 所有编辑都在 buffer 中进行. 但 buffer 不必一定是文件, 它也可以是 shell, 或者 Dired 文件树等等.</p>
<table>
<thead>
<tr>
<th>Key</th>
<th>功能</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>SPC b N</code> 或 <code>CMD-n</code></td>
<td>新建缓冲区</td>
</tr>
<tr>
<td><code>SPC b k</code> 或 <code>CMD-k</code></td>
<td>杀死当前缓冲区</td>
</tr>
<tr>
<td><code>SPC b b</code> 或 <code>SPC ,</code></td>
<td>切换工作区缓冲区</td>
</tr>
<tr>
<td><code>SPC b B</code> 或 <code>SPC &lt;</code></td>
<td>切换全局缓冲区</td>
</tr>
<tr>
<td><code>C-w v</code></td>
<td>水平复制缓冲区到新窗口</td>
</tr>
<tr>
<td><code>C-w s</code></td>
<td>垂直复制缓冲区到新窗口</td>
</tr>
<tr>
<td><code>C-w w</code></td>
<td>转到下一个缓冲区窗口</td>
</tr>
<tr>
<td><code>C-w h/j/k/l</code></td>
<td>Vi式窗口转移</td>
</tr>
<tr>
<td><code>C-w q</code></td>
<td>关闭窗口</td>
</tr>
<tr>
<td><code>C-w &gt;/&lt;</code></td>
<td>向右/左扩展窗口</td>
</tr>
<tr>
<td><code>C-w +/-</code></td>
<td>向上/下扩展窗口</td>
</tr>
<tr>
<td><code>C-w =</code></td>
<td>使所有窗口等宽等高</td>
</tr>
</tbody>
</table>
<h3>文本编辑命令</h3>
<p>这里文本编辑想表达的是类似 Vim 中文本操作键位和 command mode 下的命令(<code>:</code>). 好在 Doom Emacs 将许多 Vim 与 Emacs 命令绑定在了一起, 省去了学习 Emacs原生编辑操作的麻烦. 同时 Domm Emacs 额外提供了许多方便的编辑命令</p>
<table>
<thead>
<tr>
<th>Key</th>
<th>功能</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>C-x k</code></td>
<td>关闭buffer但不保存, 类似Vim <code>:q!</code>. 如果直接输入<code>:q</code>将会关闭整个Emacs</td>
</tr>
<tr>
<td><code>g s SPC STR</code></td>
<td>Avy搜索<code>STR</code>所在位置, 跳转</td>
</tr>
<tr>
<td><code>g s SPC STR x</code></td>
<td>Avy搜索<code>STR</code>所在位置, 跳转并剪切</td>
</tr>
<tr>
<td><code>g s SPC STR i</code></td>
<td>Avy搜索<code>STR</code>所在位置, 跳转并提供ispell修改意见</td>
</tr>
</tbody>
</table>
<h3>Markdown编辑和预览</h3>
<p>Markdown 文件的文本渲染和快速编辑可以使用 <a href="https://jblevins.org/projects/markdown-mode/" target="_blank" rel="noopener">markdown-mode</a>. <a href="https://blog.bitsandbobs.net/blog/emacs-markdown-live-preview/" target="_blank" rel="noopener">Markus Opitz</a> 基于 <code>simple-httpd</code> 包实现了一个 HTTP 服务器实时预览的功能. 编辑命令可参考这个 <a href="https://cheatography.com/xaon/cheat-sheets/emacs-markdown-mode/" target="_blank" rel="noopener">Cheatsheet</a>.</p>
<h2>Troubleshooting</h2>
<h3>GitHub图标显示不正常</h3>
<p>安装完后打开 Doom Emacs, 首页上的 GitHub 图标显示有可能<a href="https://github.com/hlissner/doom-emacs/issues/724" target="_blank" rel="noopener">不正常</a>, 此时需要在 Emacs 下安装<code>all-the-icons</code>.</p>
<p><figure class="highlight lisp"><table><tr><td class="code"><pre><span class="line">M-x all-the-icons-install-fonts</span><br></pre></td></tr></table></figure></p>
<p>如果出现 403 错误, 可以用 <a href="https://blog.fazero.me/2015/08/31/%E5%88%A9%E7%94%A8proxychains%E5%9C%A8%E7%BB%88%E7%AB%AF%E4%BD%BF%E7%94%A8socks5%E4%BB%A3%E7%90%86/" target="_blank" rel="noopener">proxychains-ng</a>和 SS 解决</p>
<p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">proxychains4 emacs</span><br></pre></td></tr></table></figure></p>
<h3><code>Package cl is deprecated</code> 警告</h3>
<p>在打开 Doom Emacs 后底部会出现这一警告. 原因是在 Emacs 24 后 <code>cl</code> 程序包已经被 <code>cl-lib</code> 取代, 而部分依赖于 <code>cl</code> 的包 (如 <a href="https://github.com/jrblevin/deft/issues/77#issue-616735753" target="_blank" rel="noopener">deft</a>) 未相应更新. 目前除了等待源码更新外, 没有好的解决办法.</p>
<h3>新建文档时安装 PDF-tools 出错</h3>
<p>首次用 <code>M-X org-roam-find-file</code> 创建新文件, 会弹出 build epdfinfo 的请求, 确定后自动安装 pdf-tools. 此时出现了 build failed 的情况, 主要错误信息是</p>
<p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">configure: error: cannot find necessary  poppler-private header (see README.org)</span><br><span class="line">Build failed.  ;o(</span><br></pre></td></tr></table></figure></p>
<p>解决办法参考这个 <a href="https://github.com/politza/pdf-tools/issues/480#issuecomment-472223334" target="_blank" rel="noopener">issue comment</a>, 从 Homebrew 安装 pdf-tools</p>
<p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">brew tap dunn/homebrew-emacs</span><br><span class="line">brew install --HEAD pdf-tools</span><br></pre></td></tr></table></figure></p>
<p>然后在 <code>packages.el</code> 中加入</p>
<p><figure class="highlight lisp"><table><tr><td class="code"><pre><span class="line">(<span class="name">package!</span> pdf-tools)</span><br></pre></td></tr></table></figure></p>
<p>重新打开 Emacs 新建文件, 不需要重新 build epdfinfo了.</p>
<h2>参考资料</h2>
<p>Master Emacs in 21 Days: <a href="http://book.emacs-china.org/" target="_blank" rel="noopener">http://book.emacs-china.org/</a></p>
<p>Emacs Key Bindings: <a href="https://caiorss.github.io/Emacs-Elisp-Programming/Keybindings.html" target="_blank" rel="noopener">https://caiorss.github.io/Emacs-Elisp-Programming/Keybindings.html</a></p>
<p><a href="http://emacslife.com/read-lisp-tweak-emacs/beginner-3-make-things-more-convenient.html" target="_blank" rel="noopener">How can I customize Emacs to make things more convenient?</a></p>
<p>Using Emacs Series: <a href="https://cestlaz.github.io/stories/emacs/" target="_blank" rel="noopener">https://cestlaz.github.io/stories/emacs/</a>
&lt;div id=&quot;footnotes&quot;&gt;&lt;hr&gt;&lt;div id=&quot;footnotelist&quot;&gt;&lt;ol style=&quot;list-style: none; padding-left: 0; margin-left: 40px&quot;&gt;&lt;li id=&quot;fn:1&quot;&gt;&lt;span style=&quot;display: inline-block; vertical-align: top; padding-right: 10px; margin-left: -40px&quot;&gt;1.&lt;/span&gt;&lt;span style=&quot;display: inline-block; vertical-align: top; margin-left: 10px;&quot;&gt;Zettelkasten是一个德语词, 对应英语slip box, 类似于图书馆存放索引卡的盒子.&lt;a href=&quot;#fnref:1&quot; rev=&quot;footnote&quot;&gt; ↩&lt;/a&gt;&lt;/span&gt;&lt;/li&gt;&lt;li id=&quot;fn:2&quot;&gt;&lt;span style=&quot;display: inline-block; vertical-align: top; padding-right: 10px; margin-left: -40px&quot;&gt;2.&lt;/span&gt;&lt;span style=&quot;display: inline-block; vertical-align: top; margin-left: 10px;&quot;&gt;ELPA: 全称Emacs Lisp Package Archive, Emacs默认的软件包存储库. MELPA = Milkypostman ELPA&lt;a href=&quot;#fnref:2&quot; rev=&quot;footnote&quot;&gt; ↩&lt;/a&gt;&lt;/span&gt;&lt;/li&gt;&lt;/ol&gt;&lt;/div&gt;&lt;/div&gt;</p>

	
	</div>
  <!-- categories -->
  <span style="font-size:90%">
  
  <i style="color:#bbb" class="fa fa-folder"></i> <a style="color:#bbb" href="/categories/Software/">Software</a>
  </span>
  &nbsp
  <!-- tags -->
  <span style="font-size:90%" >
  
  <a style="color:#bbb" href="/tags/macOS/">#macOS</a>&nbsp&nbsp<a style="color:#bbb" href="/tags/Emacs/">#Emacs</a>&nbsp&nbsp<a style="color:#bbb" href="/tags/Org-roam/">#Org-roam</a>
  </span>
  <!-- read more button -->
  <a type="button" href="/2020/07/01/emacs-1/#more" class="pull-right btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->	
		<h3 class="title">
			<div class="date"> 2020-06-30 </div>
			<div class="article-title"><a href="/2020/06/30/hexo-2-update-time/" >Hexo笔记(二)——显示博文修改时间等</a></div>						
		</h3>
	


			<div class="entry">
  <div class="row">
	
	
		<link rel="stylesheet" type="text/css" href="/css/hint.min.css"><p><div class="alert alert-success"><i class="fa fa-lightbulb-o  float-left"></i>  <p>给Freemind主题增加显示博文修改时间的功能. 用hexo-browsersync实现server模式实时预览.</p>
</div>
&lt;!-- more --&gt;</p>
<h2>背景</h2>
<p>在网上浏览博文的时候, 经常可以看到一些Hexo生成的站点文章有最后修改时间的属性, 所以一直以来都想给自己的博文增加这样的功能. 可惜拖着拖着到现在才想着实践. 原本想着只要在front matter上增加类似<code>update</code>属性, 然后修改ejs让它像<code>date</code>一样在边栏显示就可以了. 但是这样想的时候出现了一点问题, 因为直接从front matter提取的<code>update</code>是字符串, 没有<code>format</code>方法, 也不能传给<code>date()</code>函数. 在看了一些文章后才知道需要先将其转换为<code>moment</code>对象. 那么问题就变成了找到<code>date</code>是在哪里变成<code>moment</code>对象的即可. 另外还想实现的需求是: 如果front matter有<code>updated</code>属性, 则以<code>updated</code>为最后修改时间; 如果没有, 则获取文件的最后修改时间.</p>
<h2>搜索date moment对象化代码</h2>
<p>采用正则表达式, <code>find</code>和<code>grep</code>搜索js文件, 寻找<code>date</code>属性的<code>moment</code>实例化</p>
<p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> find . -regex <span class="string">".*\.js"</span> | xargs grep -E <span class="string">"moment\(.*date)"</span> --color -RnH</span></span><br><span class="line">./node_modules/hexo/lib/plugins/helper/date.js:9:  if (!isMoment(date)) date = moment(isDate(date) ? date : new Date(date));</span><br><span class="line">./node_modules/hexo/lib/hexo/post.js:40:  data.date = data.date ? moment(data.date) : moment();</span><br></pre></td></tr></table></figure></p>
<p>可以看到<code>date</code>实例化在<code>post.js</code>的40行. 接下来在<code>post.js</code>中加入如下代码使data获得moment对象<code>updated</code>.</p>
<p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (data.updated) &#123;</span><br><span class="line">      data.updated = moment(data.updated);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></p>
<p>但这样还不能满足我们的要求, 即要求<code>updated</code>属性不存在时获取文件最后修改时间, 作为文章最后修改时间. 根据参考资料1, 为获取文件路径, 除了<code>post.js</code>中已经引入的<code>path</code>外, 需要引入<code>child_process</code>库来调用系统的date命令.</p>
<p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> execSync = <span class="built_in">require</span>(<span class="string">'child_process'</span>).execSync;</span><br></pre></td></tr></table></figure></p>
<p>于是修改上一步中的实例化if语句</p>
<p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> lastMod = <span class="string">''</span>;</span><br><span class="line"><span class="keyword">if</span> (data.updated) &#123;</span><br><span class="line">    data.updated = moment(data.updated);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="comment">// 对data.source进行判断, 否则在新建post时会报错</span></span><br><span class="line">  <span class="keyword">if</span> (data.source) &#123;</span><br><span class="line">    fp = pathFn.resolve(config.source_dir, data.source);</span><br><span class="line">    lastMod = execSync(<span class="string">`date -r <span class="subst">$&#123;fp&#125;</span> "+%Y-%m-%d %H:%M:%S"`</span>).toString().trim();</span><br><span class="line">    data.updated = moment(lastMod);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    data.updated = data.date;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这样就使得每一个post对象获得了<code>updated</code>属性.</p>
<h2>修改meta.ejs</h2>
<p>得到<code>updated</code>属性后, 只要简单修改<code>layout/_partial/post</code>下的<code>meta.ejs</code>文件即可</p>
<p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">&lt;!-- date --&gt;</span><br><span class="line">&lt;% <span class="keyword">if</span> (item.date) &#123; %&gt;</span><br><span class="line">&lt;div <span class="class"><span class="keyword">class</span></span>=<span class="string">"meta-widget"</span>&gt;</span><br><span class="line">&lt;i <span class="class"><span class="keyword">class</span></span>=<span class="string">"fa fa-clock-o"</span>&gt;&lt;<span class="regexp">/i&gt;</span></span><br><span class="line"><span class="regexp">&lt;%= item.date.format(config.date_format) %&gt; created</span></span><br><span class="line"><span class="regexp">&lt;/</span>div&gt;</span><br><span class="line">&lt;% <span class="keyword">if</span> (item.updated) &#123; %&gt;</span><br><span class="line"> &lt;% <span class="keyword">if</span> (date(item.date) != date(item.updated)) &#123; %&gt;</span><br><span class="line">    &lt;div <span class="class"><span class="keyword">class</span></span>=<span class="string">"meta-widget"</span>&gt;</span><br><span class="line">    &lt;i <span class="class"><span class="keyword">class</span></span>=<span class="string">"fa fa-pencil"</span>&gt;&lt;<span class="regexp">/i&gt;</span></span><br><span class="line"><span class="regexp">    &lt;%= item.updated.format(config.date_format) %&gt; last modified</span></span><br><span class="line"><span class="regexp">    &lt;/</span>div&gt;</span><br><span class="line">    &lt;% &#125; %&gt;</span><br><span class="line">   &lt;% &#125; %&gt;</span><br><span class="line">&lt;% &#125; %&gt;</span><br></pre></td></tr></table></figure></p>
<p>这里额外要求只有当<code>date</code>和<code>updated</code>两者日期不同时, 才显示<code>updated</code>的时间. 效果如下图所示</p>
<p><figure class="null"><img src="update_time_result.png" alt=" "><figcaption> </figcaption></figure></p>
<p>完工 (ง •̀_•́)ง</p>
<h2>Server模式实时预览</h2>
<p>每次修改博文都要重新hexo generate再server挺麻烦的. 原来用的<a href="https://github.com/hexojs/hexo-livereload" target="_blank" rel="noopener">hexo-livereload</a>已被归档, 现在可以用<a href="https://github.com/hexojs/hexo-browsersync" target="_blank" rel="noopener">hexo-browsersync</a></p>
<p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">npm install -g browsersync</span><br><span class="line">npm install hexo-browsersync --save</span><br></pre></td></tr></table></figure></p>
<p>之后再运行server模式. 当md文件有改动时, localhost页面会自动更新.</p>
<h2>相关文章</h2>
<p><a href="/2018/02/15/Hexo-1/" title="Hexo笔记(一)——安装, Markdown写作与主题">Hexo笔记(一)——安装, Markdown写作与主题</a></p>
<h2>参考资料</h2>
<ol>
<li><a href="https://github.com/xcatliu/hexo-filter-date-from-git/blob/master/index.js" target="_blank" rel="noopener">hexo-filter-date-from-git/index.js</a></li>
<li><a href="https://stackoverflow.com/a/20807343" target="_blank" rel="noopener">SO - Print a file's last modified date in Bash</a></li>
<li><a href="https://blog.csdn.net/dengxu11/article/details/6947078?utm_source=blogxgwz0" target="_blank" rel="noopener">grep 递归指定文件遍历方法</a></li>
<li><a href="https://blog.singee.me/2018/05/16/hexo/hexo-auto-refresh/" target="_blank" rel="noopener">Hexo利用browsersync进行自动刷新</a></li>
</ol>

	
	</div>
  <!-- categories -->
  <span style="font-size:90%">
  
  <i style="color:#bbb" class="fa fa-folder"></i> <a style="color:#bbb" href="/categories/Software/">Software</a>
  </span>
  &nbsp
  <!-- tags -->
  <span style="font-size:90%" >
  
  <a style="color:#bbb" href="/tags/Hexo/">#Hexo</a>&nbsp&nbsp<a style="color:#bbb" href="/tags/Freemind/">#Freemind</a>&nbsp&nbsp<a style="color:#bbb" href="/tags/JavaScript/">#JavaScript</a>
  </span>
  <!-- read more button -->
  <a type="button" href="/2020/06/30/hexo-2-update-time/#more" class="pull-right btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->	
		<h3 class="title">
			<div class="date"> 2020-05-09 </div>
			<div class="article-title"><a href="/2020/05/09/macos-script-runvasp/" >解决macOS上脚本中运行VASP时动态库未载入问题</a></div>						
		</h3>
	


			<div class="entry">
  <div class="row">
	
	
		<link rel="stylesheet" type="text/css" href="/css/hint.min.css"><p><div class="alert alert-success"><i class="fa fa-lightbulb-o  float-left"></i>  <p>解决macOS上脚本中运行程序遇到dyld: Library not loaded报错.</p>
</div>
&lt;!-- more --&gt;</p>
<h2>背景</h2>
<p>疫情在家工mo作yu期间, 准备在自己macOS上用VASP做点小的测试. 因为懒得重复输入命令, 于是写了一个最基本的shell脚本</p>
<p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/usr/bin/env bash</span></span><br><span class="line">module load vasp/5.4.4-common-intel-2018.0.1</span><br><span class="line">mpirun -np 4 vasp_std</span><br></pre></td></tr></table></figure></p>
<p>第一步载入的是事先写好的VASP相关环境变量. 执行, 结果报错</p>
<p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">dyld: Library not loaded: @rpath/libmkl_intel_lp64.dylib</span><br><span class="line">  Referenced from: /Users/stevezhang/software/sci/vasp/vasp.5.4.4-intel-2018.0.1/common/bin/vasp_std</span><br><span class="line">  Reason: image not found</span><br></pre></td></tr></table></figure></p>
<p>也即<code>libmkl_intel_lp64.dylib</code>没有加到<code>DYLD_LIBRARY_PATH</code>中. 可比较奇怪的是, 在命令行里echo <code>DYLD_LIBRARY_PATH</code>, 返回的是预期结果.</p>
<h2>探索与解决</h2>
<p>写一个非常简单的脚本，检查脚本执行过程中的环境变量.</p>
<p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/usr/bin/env bash</span></span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$DYLD_LIBRARY_PATH</span></span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$LIBRARY_PATH</span></span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$PATH</span></span><br><span class="line"></span><br><span class="line">module load intel/2018.1</span><br><span class="line">module load mpich/3.2.1-intel-2018.0.1</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$DYLD_LIBRARY_PATH</span></span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$LIBRARY_PATH</span></span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$PATH</span></span><br></pre></td></tr></table></figure></p>
<p>运行前线载入<code>intel/2018.1</code>模块. 运行脚本发现:</p>
<ul>
<li>在module load前后, <code>LIBRARY_PATH</code>和<code>PATH</code>同echo的预期结果相同.</li>
<li>在module load前, <code>DYLD_LIBRARY_PATH</code>是空的.</li>
<li>在load后, 只有未在zshrc里载入的MPICH里定义的库路径被加入到<code>DYLD_LIBRARY_PATH</code>中.</li>
</ul>
<p>搜索后找到几个帖子描述类似问题:</p>
<p><a href="https://stackoverflow.com/questions/35568122/why-isnt-dyld-library-path-being-propagated-here" target="_blank" rel="noopener">https://stackoverflow.com/questions/35568122/why-isnt-dyld-library-path-being-propagated-here</a>
<a href="https://apple.stackexchange.com/questions/212945/unable-to-set-dyld-fallback-library-path-in-shell-on-osx-10-11-1" target="_blank" rel="noopener">https://apple.stackexchange.com/questions/212945/unable-to-set-dyld-fallback-library-path-in-shell-on-osx-10-11-1</a></p>
<p>问题原因是，从El Captian开始, macOS引入了系统完整性保护(system integrity protection, SIP), 在调用系统提供的解释器时，所有<code>DYLD_</code>环境变量会被重设. 在使用module管理环境时, 因为intel模块事先被载入过, 因此脚本里面载入intel模块的行为会被module无视, 因此只有MPICH中的变量加入到<code>DYLD_LIBRARY_PATH</code>中.</p>
<p>一种解决办法是, 在最开始的shell脚本里面手动设置<code>DYLD_LIBRARY_PATH</code>, 缺点是不容易复用bashrc或zshrc里的内容. 更方便的做法是在shell脚本里load完所有module后reload一下，</p>
<p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/usr/bin/env bash</span></span><br><span class="line">module load vasp/5.4.4-common-intel-2018.0.1</span><br><span class="line">module reload</span><br><span class="line"></span><br><span class="line">mpirun -np 4 vasp_std <span class="comment"># success</span></span><br></pre></td></tr></table></figure></p>
<p>另一种可能的办法是<a href="https://blog.csdn.net/qq285744011/article/details/82219340" target="_blank" rel="noopener">关闭SIP</a>, 不过因为reload完全解决了我的需求, 所以就没有尝试这种稍微麻烦些的办法.</p>

	
	</div>
  <!-- categories -->
  <span style="font-size:90%">
  
  <i style="color:#bbb" class="fa fa-folder"></i> <a style="color:#bbb" href="/categories/Software/">Software</a>
  </span>
  &nbsp
  <!-- tags -->
  <span style="font-size:90%" >
  
  <a style="color:#bbb" href="/tags/VASP/">#VASP</a>&nbsp&nbsp<a style="color:#bbb" href="/tags/macOS/">#macOS</a>
  </span>
  <!-- read more button -->
  <a type="button" href="/2020/05/09/macos-script-runvasp/#more" class="pull-right btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->	
		<h3 class="title">
			<div class="date"> 2019-10-28 </div>
			<div class="article-title"><a href="/2019/10/28/mathpix-ocr/" >Python笔记(四)——使用MathpixOCR API进行LaTeX公式识别</a></div>						
		</h3>
	


			<div class="entry">
  <div class="row">
	
	
		<link rel="stylesheet" type="text/css" href="/css/hint.min.css"><p><div class="alert alert-success"><i class="fa fa-lightbulb-o  float-left"></i>  <p>编写MathpixOCR API的Python包装器和简单的Automator workflow, 模拟Mathpix Snip Tool的公式识别体验.</p>
</div>
&lt;!-- more --&gt;</p>
<h2>前言</h2>
<p>用LaTeX准备文献报告时一个比较头疼的问题是输入文献中包含复杂符号的长公式. <a href="https://mathpix.com/" target="_blank" rel="noopener">Mathpix Snip Tool</a> (MST)提供了方便的光学字符识别功能, 可以将包含公式的截图转化为LaTeX代码. 今年MST从完全免费的1.0版本升级到了2.0, 自此个人用户每月只能免费识别50次, 这对于苦逼PhD显然是不够用的.</p>
<p>好在作为MST底层的MathpixOCR服务, API每月可免费调用1000次, 所得结果和MST相同, 只是没有MST方便的截图和GUI功能. 归根结底, 我们想实现的无非是识别剪贴板中的公式图片, 转化图片到LaTeX代码并复制到剪贴板而已. 这可以通过将OCR与OS命令包装在一起来实现. 官方提供了简单的<a href="https://github.com/Mathpix/api-examples/tree/master/python" target="_blank" rel="noopener">例子</a>供我们学习OCR API的使用, 而OS API可以通过Python包和CLI命令调用. 这篇文章是学习包装器编写的记录.</p>
<p>最终脚本已上传到<a href="https://github.com/minyez/mathpixocr_wrapper" target="_blank" rel="noopener">GitHub仓库</a>, 欢迎下载使用.</p>
<h2>API包装</h2>
<h3>获取API密钥</h3>
<p>首先需要在Mathpix上注册用户并填写信用卡信息, 注册后获得<code>app_key</code>和<code>app_id</code>作为API密钥. 脚本采用了两种从外部获取密钥的方式, 一种是环境变量, 另一种是从同路径下JSON读取.</p>
<h3>从系统剪贴板获取图片</h3>
<p>使用pillow包中的<code>ImageGrab.grabclipboard</code>获取剪贴版中的图片, 并产生<code>Image</code>对象. 注意, 此后剪贴板中的临时文件会被删除, 无法再直接通过路径获得</p>
<p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> PIL <span class="keyword">import</span> ImageGrab</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>im = ImageGrab.grabclipboard()</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>os.path.isfile(im.filename)</span><br><span class="line"><span class="literal">False</span></span><br></pre></td></tr></table></figure></p>
<p>因此需要先把图片保存下来才能在后续继续使用</p>
<p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">im = ImageGrab.grabclipboard()</span><br><span class="line">fn = <span class="string">".temp_eq.png"</span></span><br><span class="line">im.save(fn, <span class="string">"PNG"</span>)</span><br></pre></td></tr></table></figure></p>
<h3>base64编码</h3>
<p>OCR要求图片编码为base64. 编码转换可以参考官方例子</p>
<p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">image_uri</span><span class="params">(fn)</span>:</span></span><br><span class="line">  image_data = open(fn, <span class="string">"rb"</span>).read()</span><br><span class="line">  <span class="keyword">return</span> <span class="string">"data:image/jpg;base64,"</span> + base64.b64encode(image_data).decode()</span><br></pre></td></tr></table></figure></p>
<p><code>b64encode</code>使用Base64规则将一串类字节字符串进行编码, <code>decode</code>方法返回编码后的普通字符串.</p>
<p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>ec = base64.b64encode(<span class="string">b"abcdefg"</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>ec</span><br><span class="line"><span class="string">b'YWJjZGVmZw=='</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>ec.decode()</span><br><span class="line"><span class="string">'YWJjZGVmZw=='</span></span><br></pre></td></tr></table></figure></p>
<h3>调用API</h3>
<p>通过<code>requests</code>包与OCR API进行通信. 通信数据要求为JSON, 它至少需要包含<code>src</code>和<code>format</code>两个键. <code>src</code>值就是base64编码后的图片字符串, <code>format</code>值为一个列表, 成员为所想要转换的格式, 支持的转化格式包括下面几种.</p>
<table>
<thead>
<tr>
<th style="text-align:left"><code>format</code>值</th>
<th style="text-align:left">转化格式</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left"><code>text</code></td>
<td style="text-align:left">普通文本</td>
</tr>
<tr>
<td style="text-align:left"><code>wolfram</code></td>
<td style="text-align:left">Mathematica</td>
</tr>
<tr>
<td style="text-align:left"><code>latex_simplified</code></td>
<td style="text-align:left">简化的latex代码, 括号不包含left或right</td>
</tr>
<tr>
<td style="text-align:left"><code>latex_styled</code></td>
<td style="text-align:left">left/right控制的latex代码</td>
</tr>
</tbody>
</table>
<p>利用<code>json</code>包将字典转化成JSON字符串, 用<code>requests</code>发送API请求到<code>v3/latex</code>端点</p>
<p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">data = json.dump(&#123;<span class="string">"src"</span>: img_base64, <span class="string">"format"</span>: [<span class="string">"latex_simplified"</span>,]&#125;)</span><br><span class="line">headers = &#123;</span><br><span class="line">  <span class="string">'Content-type'</span>: <span class="string">'application/json'</span>,</span><br><span class="line">  <span class="string">'app_key'</span>: your_app_key,</span><br><span class="line">  <span class="string">'app_id'</span>: your_app_id,</span><br><span class="line">  &#125;</span><br><span class="line">r = requests.post(<span class="string">'https://api.mathpix.com/v3/latex'</span>,</span><br><span class="line">                  data=data, headers=headers)</span><br></pre></td></tr></table></figure></p>
<p>通信返回的<code>r.text</code>是一个JSON字符串. 如果OCR识别成功, 则它包含<code>latex_simplified</code>键, 对应值为识别号的简化LaTeX代码. 如果识别失败, 则包含<code>error</code>键, 给出具体错误信息. 更复杂的API调用参考<a href="https://docs.mathpix.com/" target="_blank" rel="noopener">官方文档</a>.</p>
<p><div class="alert alert-info"><i class="fa fa-info  float-left"></i>  <p><code>v3/latex</code>端点目前是旧端点. 官方推荐使用<code>v/3text</code>, 通信所需的JSON关键词有些许不同, 但变化不是很大, 读者可自行参考文档修改. (2020-06-29)</p>
</div></p>
<h3>拷贝转化好的LaTeX到系统剪贴板</h3>
<p>参考了<a href="https://gist.github.com/luqmaan/d8bc61e746207bb12f11" target="_blank" rel="noopener">这个GIST</a>, 使用macOS上的<code>pbcopy</code>将字符串拷贝到系统剪贴板. 另一种办法是直接打印到标准输出, 然后用Automator服务中的功能拷贝到剪贴板.</p>
<h3>附加功能</h3>
<p>比如每月API调用统计以及历史记录, 都保存在JSON文件中. 实现说起来比较琐碎, 就不赘述了.</p>
<h2>Automator服务</h2>
<p>把写好的包装器放到<code>~/bin</code>下, 编写简单的工作流<code>Mathpix Snip OCR API</code></p>
<p><figure class="null"><img src="automator_workflow.png" alt=" "><figcaption> </figcaption></figure></p>
<p>然后在系统设置-键盘-快捷键设置服务的快捷键</p>
<p><figure class="null"><img src="shortcut.png" alt=" "><figcaption> </figcaption></figure></p>
<p>如此一来, <code>cmd+shift+4</code>将公式截屏到剪贴板后<code>cmd+shift+M</code>, 等待片刻即可从剪贴板黏贴转换好的公式. 大功告成!</p>
<h2>黏贴到到Word公式中</h2>
<h2>参考资料</h2>
<p>使用pillow包来获取剪贴板图片: <a href="https://zhuanlan.zhihu.com/p/83678942" target="_blank" rel="noopener">Mathpix收费了？快使用API吧，一个月免费识别1000次！</a></p>

	
	</div>
  <!-- categories -->
  <span style="font-size:90%">
  
  <i style="color:#bbb" class="fa fa-folder"></i> <a style="color:#bbb" href="/categories/Software/">Software</a>
  </span>
  &nbsp
  <!-- tags -->
  <span style="font-size:90%" >
  
  <a style="color:#bbb" href="/tags/LaTeX/">#LaTeX</a>&nbsp&nbsp<a style="color:#bbb" href="/tags/MathpixOCR/">#MathpixOCR</a>
  </span>
  <!-- read more button -->
  <a type="button" href="/2019/10/28/mathpix-ocr/#more" class="pull-right btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->	
		<h3 class="title">
			<div class="date"> 2019-10-20 </div>
			<div class="article-title"><a href="/2019/10/20/speaker-map/" >Python笔记(三)——用pyecharts制作统计地图</a></div>						
		</h3>
	


			<div class="entry">
  <div class="row">
	
	
		<link rel="stylesheet" type="text/css" href="/css/hint.min.css"><p><div class="alert alert-success"><i class="fa fa-lightbulb-o  float-left"></i>  <p>以会议报告人所在机构的分布为例, 介绍如何基于pyecharts制作地理分布图.</p>
</div>
&lt;!-- more --&gt;</p>
<h2>前言</h2>
<p>前段时间去深圳参加一个研究方向有关的会议, 国内做实验和理论研究的老师都来了, 于是心血来潮想有没有可能做一个统计来看看老师们所在机构的地理分布. 虽然报告人并不多, 但应该也能提供一些定性的信息, 也算是学习一种图片制作和数据展示技巧.
经过一番搜索, 决定采用Python包<code>pyecharts</code>中的地理图标<code>Geo</code>类来制作. 使用Python版本为3.7.1, pyecharts版本为1.5.1.</p>
<h2>准备</h2>
<p>首先通过pip安装pyecharts</p>
<p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">pip install pyecharts</span><br></pre></td></tr></table></figure></p>
<p>同时安装中国省市地图包</p>
<p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">pip echarts-china-provinces-pypkg echarts-china-cities-pypkg</span><br></pre></td></tr></table></figure></p>
<p>为方便直接输出图片, 安装<code>snapshot_selenium</code>或者<code>snapshot_phantomjs</code></p>
<p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">pip snapshot_selenium snapshot_phantomjs</span><br></pre></td></tr></table></figure></p>
<h2>初步尝试</h2>
<p>简化一下存放在<code>site-packages/example</code>里的<code>geo_example.py</code>, 得到下面的代码</p>
<p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">from</span> pyecharts <span class="keyword">import</span> options <span class="keyword">as</span> opts</span><br><span class="line"><span class="keyword">from</span> pyecharts.charts <span class="keyword">import</span> Geo, Page</span><br><span class="line"><span class="keyword">from</span> pyecharts.faker <span class="keyword">import</span> Collector</span><br><span class="line"><span class="keyword">from</span> pyecharts.render <span class="keyword">import</span> make_snapshot</span><br><span class="line"><span class="comment">#from snapshot_selenium import snapshot</span></span><br><span class="line"><span class="keyword">from</span> snapshot_phantomjs <span class="keyword">import</span> snapshot</span><br><span class="line"></span><br><span class="line"><span class="comment"># speaker.json存储了以speaker老师名字为key的字典</span></span><br><span class="line"><span class="comment"># 包含"省份"和"方向"两个key-value.</span></span><br><span class="line"><span class="keyword">with</span> open(<span class="string">"speaker.json"</span>, <span class="string">'r'</span>) <span class="keyword">as</span> h:</span><br><span class="line">    speaker = json.load(h)</span><br><span class="line">provs = [s[<span class="string">"省份"</span>] <span class="keyword">for</span> s <span class="keyword">in</span> speaker.values()]</span><br><span class="line">data = [[p, provs.count(p)] <span class="keyword">for</span> p <span class="keyword">in</span> set(provs)]</span><br><span class="line"></span><br><span class="line">C = Collector</span><br><span class="line"></span><br><span class="line"><span class="meta">@C.funcs</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">geo_speakermap</span><span class="params">()</span> -&gt; Geo:</span></span><br><span class="line">    c = (</span><br><span class="line">        Geo()</span><br><span class="line">        .add_schema(maptype=<span class="string">"china"</span>)</span><br><span class="line">        .add(<span class="string">""</span>, data)</span><br><span class="line">        .set_series_opts(label_opts=opts.LabelOpts(is_show=<span class="literal">False</span>))</span><br><span class="line">        .set_global_opts(</span><br><span class="line">            visualmap_opts=opts.VisualMapOpts(min_=<span class="number">0</span>, max_=<span class="number">15</span>, type_=<span class="string">"size"</span>),</span><br><span class="line">            title_opts=opts.TitleOpts(title=<span class="string">"报告人分布"</span>),</span><br><span class="line">        )</span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">return</span> c</span><br><span class="line"></span><br><span class="line">make_snapshot(snapshot, Page().add(*[fn() <span class="keyword">for</span> fn, _ <span class="keyword">in</span> C.charts]).render(),</span><br><span class="line">              <span class="string">"speakermap.png"</span>, browser=<span class="string">'Safari'</span>)</span><br></pre></td></tr></table></figure></p>
<p>得到分布图如下</p>
<p><figure class="null"><img src="speakermap.png" alt=" "><figcaption> </figcaption></figure></p>
<p>报告人主要分布在沿海城市的大学和研究所, 除了bug的帝都. 下面就作图涉及的几个点具体说明一下</p>
<h3>Collector类</h3>
<p><code>Collector</code>是pyechart提供的一个convenient function, 源码很短, 提供了一个列表属性和一个静态方法用<code>Collector.funcs</code>装饰后, 函数返回的<code>Geo</code>实例会加入到列表<code>Collector.charts</code>中.</p>
<p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Collector</span>:</span></span><br><span class="line">    charts = []</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">funcs</span><span class="params">(fn)</span>:</span></span><br><span class="line">        Collector.charts.append((fn, fn.__name__))</span><br></pre></td></tr></table></figure></p>
<p><code>Geo</code>类及其方法的调用利用了方法链语法, 不需要换行符来强制换行.</p>
<h3>全局变量控制</h3>
<p>用<code>set_global_opts</code>方法调整echarts图片的全局设置. 这个方法继承自<code>Chart</code>类.
参数<code>visualmap_opts</code>控制左下角标尺, 需要以<code>pyecharts.options.VisualMapOpts</code>实例作为输入.
这里因为总人数比较少, 所以调整了最大范围为15, 并用图标尺寸而非颜色来表示数值大小(<code>type_</code>), 加强对比.
其他全局变量设置可以参考<a href="https://pyecharts.org/#/zh-cn/global_options" target="_blank" rel="noopener">官网</a>.</p>
<h3>图片生成</h3>
<p><code>pyecharts.render.snapshot</code>提供了<code>make_snapshot</code>函数. <code>make_snapshot</code>实际是selenium或phantomjs的<code>snapshot</code>同名函数的包装.</p>
<p>这里用phantomjs直接渲染更快一些, 且不会跳出Safari.</p>
<h2>总结</h2>
<p>本文基于pyecharts的<code>Geo</code>类制作了报告人所在机构的地理分布. 文中所描述的图片制作是一些简单尝试, 还有很多应该可以调教的地方, 比如标记的颜色, 标尺和主图的相对位置. 不过统计数据太少, 机构地点还只限制在省级, 所得到的结论比较trivial.</p>
<p>echarts还提供了包括全球和国内省市地图在内的其他地图以及word cloud等不同类型的图片呈现方式, 并有现成的例子可供参考, 为地理数据统计和展示提供了一种方便的选择.</p>
<h2>参考资料</h2>
<p><a href="https://zhuanlan.zhihu.com/p/45202403" target="_blank" rel="noopener">知乎 - Python绘制中国地图</a>: 引导我使用pyecharts. 但是这个教程及其中链接的官方网站的API不适用于1.5.1版本.</p>
<p><a href="https://pyecharts.org/#/zh-cn/intro" target="_blank" rel="noopener">pyecharts官网</a></p>
<p><a href="https://ramiro.org/notebook/geopandas-choropleth/" target="_blank" rel="noopener">Creating a Choropleth Map of the World in Python using GeoPandas</a>: 做全球数据统计看上去很不错</p>

	
	</div>
  <!-- categories -->
  <span style="font-size:90%">
  
  <i style="color:#bbb" class="fa fa-folder"></i> <a style="color:#bbb" href="/categories/Programming/">Programming</a>
  </span>
  &nbsp
  <!-- tags -->
  <span style="font-size:90%" >
  
  <a style="color:#bbb" href="/tags/Python/">#Python</a>&nbsp&nbsp<a style="color:#bbb" href="/tags/pyecharts/">#pyecharts</a>&nbsp&nbsp<a style="color:#bbb" href="/tags/map/">#map</a>
  </span>
  <!-- read more button -->
  <a type="button" href="/2019/10/20/speaker-map/#more" class="pull-right btn btn-default more">Read More</a>
</div>

		

		</div>

		<!-- pagination -->
		<div>
  		<center>
		<div class="pagination">
<ul class="pagination">
	 
		
    	<li class="prev"><a href="/" class="alignleft prev"><i class="fa fa-arrow-circle-o-left"></i> Prev</a></li>
  		

        <li><a href="/"><i class="fa fa-home"></i>Home</a></li>

		
		   <li class="next"> <a href="/page/3/" class="alignright next">Next<i class="fa fa-arrow-circle-o-right"></i></a> </li>          
        
	
</ul>
</div>

  		</center>
		</div>

		
		
	</div> <!-- col-md-9 -->

	
		<div class="col-md-3">
	<div id="sidebar">
	
			
  <div id="site_search">
   <div class="form-group">
    <input type="text" id="local-search-input" name="q" results="0" placeholder="Search" class="st-search-input st-default-search-input form-control"/>
   </div>  
  <div id="local-search-result"></div>
  </div>


		
			
	<div class="widget">
		<h4>Categories</h4>
		<ul class="tag_box inline list-unstyled">
		
			<li><a href="/categories/Algorithm/">Algorithm<span class="badge">2</span></a></li>
		
			<li><a href="/categories/Comment/">Comment<span class="badge">2</span></a></li>
		
			<li><a href="/categories/Programming/">Programming<span class="badge">7</span></a></li>
		
			<li><a href="/categories/Software/">Software<span class="badge">26</span></a></li>
		
		</ul>
	</div>


		
			




	<div class="widget">
		<h4>Tag Cloud</h4>
		<ul class="tag_box inline list-unstyled">		
		
			<li><a href="/tags/map/">map<span class="badge">1</span></a></li>
		
			<li><a href="/tags/Tutorial/">Tutorial<span class="badge">1</span></a></li>
		
			<li><a href="/tags/Jupyter/">Jupyter<span class="badge">1</span></a></li>
		
			<li><a href="/tags/WIEN2k/">WIEN2k<span class="badge">5</span></a></li>
		
			<li><a href="/tags/keyboard/">keyboard<span class="badge">1</span></a></li>
		
			<li><a href="/tags/bilibili/">bilibili<span class="badge">1</span></a></li>
		
			<li><a href="/tags/Numerical-method/">Numerical method<span class="badge">2</span></a></li>
		
			<li><a href="/tags/MathpixOCR/">MathpixOCR<span class="badge">1</span></a></li>
		
			<li><a href="/tags/Valgrind/">Valgrind<span class="badge">3</span></a></li>
		
			<li><a href="/tags/Call-graph/">Call graph<span class="badge">1</span></a></li>
		
			<li><a href="/tags/Hexo/">Hexo<span class="badge">4</span></a></li>
		
			<li><a href="/tags/macOS/">macOS<span class="badge">5</span></a></li>
		
			<li><a href="/tags/VASP/">VASP<span class="badge">3</span></a></li>
		
			<li><a href="/tags/pyecharts/">pyecharts<span class="badge">1</span></a></li>
		
			<li><a href="/tags/XmGrace/">XmGrace<span class="badge">1</span></a></li>
		
			<li><a href="/tags/Python/">Python<span class="badge">3</span></a></li>
		
		
		   <li><a href="/tags">...<span class="badge">55</span></a></li>
		 
		</ul>
	</div>


		
			
<div class="widget">
	<h4>Links</h4>
	<ul class="blogroll list-unstyled">
	
		<li><i class="fa fa-github-square"></i><a href="https://github.com/minyez" title="My Github account." target="_blank"]);">Github-minyez</a></li>
	
		<li><i class="fa fa-book"></i><a href="https://www.douban.com/people/shigaro" title="My DouBan account" target="_blank"]);">DouBan - Shigaro</a></li>
	
		<li><i class="fa fa-book"></i><a href="https://bookmeter.com/users/1169010" title="My Bookmeter account" target="_blank"]);">読書メーター - minyez</a></li>
	
		<li><i class="fa fa-mail-forward"></i><a href="mailto:zmysmile0929@163.com" title="Send Email to me" target="_blank"]);">Email</a></li>
	
		<li><i class="fa fa-code"></i><a href="https://github.com/minyez/minyez.github.io/tree/hexo" title="Source codes of this site" target="_blank"]);">Site source</a></li>
	
		<li><i class="fa fa-rss"></i><a href="atom.xml" title="atom rss" target="_blank"]);"> RSS</a></li>
	
	</ul>
</div>


		
	</div> <!-- sidebar -->
</div> <!-- col-md-3 -->

	
	
</div> <!-- row-fluid -->

	</div>
  </div>
  <div class="container-narrow">
  <footer> <p>
  
  &copy; 2020 by <a href="http://shigaro.org"> minyez </a>
  
    | <a href="http://github.com/minyez/hexo-theme-freemind/">Theme</a> based on two Freemind themes by <a href="https://github.com/wzpan/hexo-theme-freemind/">wzpan</a> and <a href="https://github.com/PytLab/hexo-theme-freemind/">PytLab</a> 
    | Powered by <a href="https://github.com/hexojs/hexo">Hexo</a>
  
    <span id="busuanzi_container_site_uv">| <span id="busuanzi_value_site_uv"></span> visitors</span>
  
  
	| <span class="post-count">54.3k</span> words
  
</p>
 </footer>
</div> <!-- container-narrow -->
  


  
<a id="gotop" href="#">   
  <span>▲</span> 
</a>

<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/bootstrap.min.js"></script>
<script src="/js/main.js"></script>
<script src="/js/search.js"></script> 


<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>



   <script type="text/javascript">      
     var search_path = "search.xml";
	 if (search_path.length == 0) {
	 	search_path = "search.xml";
	 }
	 var path = "/" + search_path;
     searchFunc(path, 'local-search-input', 'local-search-result');
   </script>


<!-- Global site tag (gtag.js) - Google Analytics -->
<!--    added 2018-07-12 -->
<!-- modified 2019-05-10 -->

<script async src="https://www.googletagmanager.com/gtag/js?id=UA-111612868-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-111612868-1');
</script>


<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ["$","$"], ["\\(","\\)"] ],
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
            processEscapes: true
        },
        TeX: {equationNumbers: { autoNumber: "AMS" }}
    });
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax();
        for (var i = 0; i < all.length; ++i)
            all[i].SourceElement().parentNode.className += ' has-jax';
    });
</script>
<!--<script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>-->
<script type="text/javascript" async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

</body>
   </html>
