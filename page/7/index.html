<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Page 7 | Shigaro</title>
  <meta name="author" content="minyez">
  
  <meta name="description" content="minyez&#39;s blog on life, science and programming">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  
  <meta property="og:site_name" content="Shigaro"/>

  
    <meta property="og:image" content=""/>
  

  
  
    <link href="/assets/images/favicon/icon.png" rel="icon">
  
  
  <link rel="stylesheet" href="/css/bootstrap.min.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/bootstrap.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/font-awesome.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/responsive.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/highlight.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/google-fonts.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

  <script src="/js/jquery-2.0.3.min.js"></script>

  <!-- analytics -->
  
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-111612868-1', 'auto');
  ga('send', 'pageview');
</script>





<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js">
</script>



</head>

 <body 
>
  <nav id="main-nav" class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <button type="button" class="navbar-header navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
      <span class="sr-only">Toggle navigation</span>
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
    </button>
    <a class="navbar-brand" href="/"></a>
    <div class="collapse navbar-collapse nav-menu">
      <ul class="nav navbar-nav">
        

        <!-- Categories -->
        
        <li>
          <a href="/" title="Shigaro's Home"
            style="font-weight: normal; font-family: Calibri,Arial; font-size: 18px">
            <i class="fa fa-bank"></i>Home
          </a>
        </li>
        
        

        <!-- Categories -->
        
        <!-- Archives -->
        <li>
          <a href="/archives" title="All the articles."
            style="font-weight: normal; font-family: Calibri,Arial; font-size:     18px">
            <i class="fa fa-archive"></i>Archives
          </a>
        </li>
        
        

        <!-- Categories -->
        
        <!-- Tags -->
        <li>
          <a href="/tags" title="All the tags."
            style="font-weight: normal; font-family: Calibri,Arial; font-size:     18px">
            <i class="fa fa-tags"></i>Tags
          </a>
        </li>
        
        

        <!-- Categories -->
        
        <li class="dropdown">
          <a href="/categories" class="dropdown-toggle" data-toggle="dropdown" title="All the categories."
            style="font-weight: normal; font-family: Calibri,Arial; font-size:     18px">
            <i class="fa fa-folder"></i>Categories
            <b class="caret"></b>
          </a>
          <ul class="dropdown-menu">
            <li class="divider"></li>
            <li><a href="/categories" style="font-size: 20px; font-family: 'Calibri Light',Arial">All
                Categories</a><span></span></li>
            <li class="divider"></li>
            
            <li><a href="/categories/Software/"
                style="font-size: 15px; font-family: 微软雅黑">Software<span></span></a></li>
            
            <li><a href="/categories/Programming/"
                style="font-size: 15px; font-family: 微软雅黑">Programming<span></span></a></li>
            
            <li><a href="/categories/Comment/"
                style="font-size: 15px; font-family: 微软雅黑">Comment<span></span></a></li>
            
            <li><a href="/categories/Algorithm/"
                style="font-size: 15px; font-family: 微软雅黑">Algorithm<span></span></a></li>
            
            <li class="divider"></li>
          </ul>
        </li>
        
        

        <!-- Categories -->
        
        <li>
          <a href="/about" title="About me."
            style="font-weight: normal; font-family: Calibri,Arial; font-size: 18px">
            <i class="fa fa-user"></i>About
          </a>
        </li>
        
        
      </ul>
    </div>
  </div> <!-- container -->
</nav>
<div class="clearfix"></div>
  <div class="container">
  	<div class="content">
    	 <div class="page-header">
  <h1 class="home-title">Shigaro</h1>
</div>

<div class="row page">

	
	<div class="col-md-9">
	

		<div class="slogan">
      <i class="fa fa-code"></i>
      朝日が昇る　私は旅する
</div>    

		<div id="top_search"></div>
		<div class="mypage">
		
		<!-- title and entry -->
		
			
	
	<!-- display as entry -->	
		<h3 class="title">
			<div class="date"> 2019-01-02 </div>
			<div class="article-title"><a href="/2019/01/02/pandoc-md-to-pdf/" >Pandoc笔记(一)——转化Markdown为PDF</a></div>						
		</h3>
	


			<div class="entry">
  <div class="row">
	
	
		<link rel="stylesheet" type="text/css" href="/css/hint.min.css"><p><div class="alert alert-success"><i class="fa fa-lightbulb-o  float-left"></i>  <p>本文介绍了使用pandoc工具将markdown文件转化为PDF文件的方法, 讨论了HTML和LaTeX两种转换中介. 由于LaTeX对学术写作有着更好的支持, 笔者将重点放在了后者上. 文中总结了一些模板变量的用法和注意事项, 最后以转换demo.md为例, 用Makefile展示了markdown+pandoc+xelatex+bibtex的一整条工具链.</p>
</div>
&lt;!-- more --&gt;</p>
<p>需求之一来自于最近开始将读文献和看日语原版漫画时遇到的单词和用例记录在一个markdown笔记里. 在电脑上阅读这些markdown笔记完全没有问题, 但是在移动端中阅读就比较困难, 每次在Typora里手动导出也很麻烦, 于是就想着能不能把markdown转化成pdf的过程自动化. 自然就想到了在文件格式转换中非常有名的<a href="https://pandoc.org/" target="_blank" rel="noopener">pandoc</a>.</p>
<h2>初步尝试</h2>
<p>从Homebrew安装pandoc</p>
<p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">brew install pandoc</span><br></pre></td></tr></table></figure></p>
<p>然后用pandoc转换一个包含中文释义的笔记demo.md(见<a href="demo.tar.gz">压缩包</a>)</p>
<p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">pandoc demo.md -o demo.pdf</span><br></pre></td></tr></table></figure></p>
<p>返回错误</p>
<p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Error producing PDF.</span><br><span class="line">! Package inputenc Error: Unicode character 因 (U+56E0)</span><br><span class="line">(inputenc)                not set up for use with LaTeX.</span><br><span class="line">...</span><br><span class="line">Try running pandoc with --pdf-engine=xelatex.</span><br></pre></td></tr></table></figure></p>
<p>照错误信息换用<code>xelatex</code>则出现了一大堆中文字符的<code>Missing character</code>警告</p>
<p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[WARNING] Missing character: There is no 因 in font [lmroman10-regular]:mapping=tex-text;!</span><br><span class="line">[WARNING] ...</span><br></pre></td></tr></table></figure></p>
<p>生成的PDF里这些中文字符都消失了, 只有孤零零的英文. 看来事情没这么简单.</p>
<h2>基于HTML向PDF转化</h2>
<p>一开始转化单词笔记的时候就是想转成GitHub Favored Markdown风格的PDF, 于是第一反应是找了一个类似GFM的<a href="https://gist.github.com/killercup/5917178" target="_blank" rel="noopener">CSS</a>, 下载为<code>gfm.css</code>, 和md存放在一个文件夹下, 运行</p>
<p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># wrong command</span></span><br><span class="line">pandoc note.md -o note.pdf --css gfm.css</span><br></pre></td></tr></table></figure></p>
<p>进行转化, 但这样仍然会报最开始的错误. 其原因是pandoc默认使用LaTeX作为PDF生成引擎, 在这种情况css显然是没有效果的.</p>
<p>HTML转到PDF的转换引擎的一种选择是开源工具<a href="https://wkhtmltopdf.org/" target="_blank" rel="noopener">wkhtmltopdf</a>, 用Homebrew安装后, 执行</p>
<p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">pandoc note.md -o note.pdf --css gfm.css --pdf-engine wkhtmltopdf -t html5</span><br></pre></td></tr></table></figure></p>
<p>就能正常转换了！上面去掉<code>-t html5</code>也可以正常运行. 除了<a href="https://wkhtmltopdf.org/" target="_blank" rel="noopener">wkhtmltopdf</a>外也可以用<a href="http://www.princexml.com/" target="_blank" rel="noopener">prince</a>, 但它太贵了…</p>
<p><code>gfm.css</code>对自己来说不是特别好看, 尤其没有GitHub那样的浅蓝色代码背景以及对行间代码的渲染, 所以对css稍微做了一些修改. <code>pre code</code>部分参考了这个<a href="https://github.com/sindresorhus/github-markdown-css" target="_blank" rel="noopener">CSS</a>, 但它其他样式做得不好看, 也是后来才发现它的, 所以没从它出发_(xз」∠)_</p>
<p><figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* 在一级标题前面加上朝右的蓝色三角 */</span></span><br><span class="line"><span class="selector-tag">h1</span><span class="selector-pseudo">:before</span> &#123;</span><br><span class="line">  <span class="attribute">content</span>: <span class="string">"\25B6\2005"</span>;</span><br><span class="line">  <span class="attribute">color</span>: <span class="number">#0645ad</span>;</span><br><span class="line">  <span class="attribute">font-size</span>: <span class="number">60%</span>;</span><br><span class="line">  <span class="attribute">vertical-align</span>: middle;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-tag">pre</span> &#123;</span><br><span class="line">  <span class="attribute">padding</span>: <span class="number">16px</span>;</span><br><span class="line">  <span class="attribute">overflow</span>: auto;</span><br><span class="line">  <span class="attribute">line-height</span>: <span class="number">1.45</span>;</span><br><span class="line">  <span class="attribute">background-color</span>: <span class="number">#f6f8fa</span>;</span><br><span class="line">  <span class="attribute">border-radius</span>: <span class="number">3px</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-tag">code</span> &#123;</span><br><span class="line">  <span class="attribute">padding</span>: <span class="number">0.2em</span> <span class="number">0.4em</span>;</span><br><span class="line">  <span class="attribute">margin</span>: <span class="number">0</span>;</span><br><span class="line">  <span class="attribute">background-color</span>: <span class="built_in">rgba</span>(<span class="number">27</span>,<span class="number">31</span>,<span class="number">35</span>,<span class="number">0.05</span>);</span><br><span class="line">  <span class="attribute">border-radius</span>: <span class="number">3px</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-tag">pre</span>&gt;<span class="selector-tag">code</span> &#123;</span><br><span class="line">  <span class="attribute">display</span>: inline;</span><br><span class="line">  <span class="attribute">max-width</span>: auto;</span><br><span class="line">  <span class="attribute">padding</span>: <span class="number">0</span>;</span><br><span class="line">  <span class="attribute">margin</span>: <span class="number">0</span>;</span><br><span class="line">  <span class="attribute">overflow</span>: visible;</span><br><span class="line">  <span class="attribute">line-height</span>: inherit;</span><br><span class="line">  <span class="attribute">word-wrap</span>: normal;</span><br><span class="line">  <span class="attribute">background-color</span>: transparent;</span><br><span class="line">  <span class="attribute">border</span>: <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>2019-04-30补充: 后来又陆续做了其他改进, 转化了北大超算的使用教程, 最终效果大概是下面这样</p>
<p><figure class="null"><img src="pandoc-html-pdf.png" alt="pandoc-html-pdf"><figcaption>pandoc-html-pdf</figcaption></figure></p>
<h2>借助模板的基于LaTeX的转化</h2>
<p>如果markdown只是写一些代码片断和非常简单的数学公式, 那么上面的HTML转换完全足够了. 但在markdown里写复杂的LaTeX公式仍然非常要命, 有如下两个原因</p>
<ul>
<li>在编辑多次出现的复杂记号上有困难. 最简单的例如算符矩阵元尖括号环境, Bloch函数(<code>\varphi_{n\mathbf{k}}(\mathbf{r})</code>), 还有其他上下标特别多的记号. 这种情况下显然没有在tex里直接调<code>physics</code>包和<code>\newcommand</code>自定义来得方便好用, 而重复写很长的LaTeX源码显然使得Markdown失去了它原有的便携性.</li>
<li>用HTML作为中介产生包含数学公式的PDF需要使用诸如MathJax、MathML或者KaTeX来渲染, 而这些工具的渲染效果在应对复杂公式方面远远不及原生LaTeX.</li>
</ul>
<p>所以对于公式密集的笔记还是得用LaTeX作为PDF引擎.</p>
<h3>使用模板</h3>
<p>在通过LaTeX进行PDF格式转化时, 为了使得转化的tex能够正常编译, 需要用<code>--template</code>选项套用模板. 不借助模板转化得到的tex是无法正常编译的, 例如</p>
<p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">pandoc.note.md -o note_no_template.tex <span class="comment"># unable to compile</span></span><br><span class="line">pandoc note.md -o note.tex --template default <span class="comment"># compile ok</span></span><br></pre></td></tr></table></figure></p>
<p>其中<code>default</code>表示使用默认templates文件夹下后缀对应输出格式、文件名为<code>default</code>的文件作为模板. 默认模板文件的位置(macOS)在<code>share/x86_64-osx-ghc-8.4.4/pandoc-2.4/data/templates/</code>. 在那里可以看到一个<code>default.latex</code>, 就是第二行命令所用的模板. 除LaTeX外, 有其他输出格式的默认模板.</p>
<p>通过修改模板, 加入想要的LaTeX指令, 可以将markdown转成包含合适的<code>tex</code>文件, 进而得到目标的PDF输出. 要利用编辑好的自定义模板<code>abc.latex</code>有两种办法</p>
<ol>
<li>把它放在和<code>note.md</code>同一文件夹下, 将<code>default</code>改为<code>./abc.latex</code>.</li>
<li>把<code>abc.latex</code>移动到默认templates文件夹下, 将<code>default</code>改为<code>abc</code>.</li>
</ol>
<h3>编辑模板</h3>
<p>接下来的问题就是怎么写出自己想要的模板. 默认的模板很复杂(至少对我来说), 而且它同不少LaTeX的高级指令有关, 直接看模板会晕. 所以还是从pandoc的<a href="https://pandoc.org/MANUAL.html#templates" target="_blank" rel="noopener">templates手册</a>开始.</p>
<p>LaTeX模板主要包含序言部分和<code>document</code>环境. 比如我想在序言里包含<code>amsmath</code>包, 那就在模板中序言部分加一句</p>
<p><figure class="highlight tex"><table><tr><td class="code"><pre><span class="line"><span class="tag">\<span class="name">usepackage</span><span class="string">&#123;amsmath&#125;</span></span></span><br></pre></td></tr></table></figure></p>
<p>那它就会出现在被转换的<code>tex</code>文件里.</p>
<h3>文件元数据控制</h3>
<p>为了应对多种情境(handout, slides, book, thesis), 默认模板里通常包含许多pandoc变量. 由这些变量值和一些条件语法, 可以在产生对应于情境的添加文本, 这样就可以用一个模板通吃了. (然而通吃又好用的模板很难维护. )</p>
<p>这些变量值都可以在一个遵循YAML语法的元数据块(metadata block)中定义. YAML块可以以<code>---</code>开头、<code>...</code>或<code>---</code>结尾的形式写在被转化的文档里(对于md来说这和Hexo一样), 也可以写在一个单独的<code>.yaml</code>文件里, 转化时一并作为输入.</p>
<p>Pandoc所利用的文件元数据可以在YAML元数据块中定义如下(从manual改编)</p>
<p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">title:</span> <span class="string">A</span> <span class="string">Fake</span> <span class="string">Thesis</span></span><br><span class="line"><span class="attr">author:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Aristotle</span></span><br><span class="line">  <span class="attr">affiliation:</span> <span class="string">The</span> <span class="string">Academy</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">minyez</span></span><br><span class="line">  <span class="attr">affiliation:</span> <span class="string">PKU</span></span><br><span class="line"><span class="attr">date:</span> <span class="number">2019</span><span class="number">-01</span><span class="number">-02</span></span><br><span class="line"><span class="attr">subtitle:</span> <span class="string">a</span> <span class="string">Pandoc</span> <span class="string">Template</span> <span class="string">Example</span></span><br><span class="line"><span class="attr">abstract:</span> <span class="string">|</span></span><br><span class="line">  <span class="string">Just</span> <span class="string">a</span> <span class="string">non-existing</span> <span class="string">thesis</span> <span class="string">for</span> <span class="string">pandoc</span> <span class="string">test.</span></span><br><span class="line">  <span class="string">The</span> <span class="string">abstract</span> <span class="string">can</span> <span class="string">have</span> <span class="string">multiple</span> <span class="string">lines.</span></span><br><span class="line">  </span><br><span class="line">  <span class="string">Also</span> <span class="string">can</span> <span class="string">have</span> <span class="string">multiple</span> <span class="string">paragraphs.</span></span><br><span class="line"><span class="attr">keywords:</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">pandoc</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">markdown</span></span><br><span class="line"><span class="meta">---</span></span><br></pre></td></tr></table></figure></p>
<p>做一点解释</p>
<ul>
<li>若用如上<code>author</code>写法, 在模板中使用时需要用<code>author.name</code>和<code>author.affiliation</code>来获取对应的姓名和单位, 并对<code>author</code>遍历. 否则这么写是不会在tex中正确产生author的.</li>
<li><code>abstract</code>可以有多行和多段.</li>
</ul>
<p>这些元数据会被包含在生成的PDF元数据中. 下面几节总结一些其他常用的Pandoc变量.</p>
<h3>TOC和文档首尾</h3>
<p>可以用<code>toc</code>变量产生目录页</p>
<p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">toc:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">toc-title:</span> <span class="string">"Custom TOC title"</span></span><br><span class="line"><span class="attr">include-before:</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">"In default template, "</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">"we are in the document part, "</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">"right after abstract and before TOC"</span></span><br><span class="line"><span class="attr">include-after:</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">"we are next to the end of the document."</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">"Yep."</span></span><br><span class="line"><span class="meta">---</span></span><br></pre></td></tr></table></figure></p>
<p>一些解释</p>
<ul>
<li>
<p><code>toc</code>只需要是一个非空值, 就可以显示目录.</p>
</li>
<li>
<p><code>include-before</code>和<code>include-after</code>的内容会出现document环境内.</p>
</li>
<li>
<p>有<code>header-includes</code>, 可用来在元数据块中定义序言命令. 需要使用LaTeX的源代码环境标记起来, 否则会被当作markdown代码进行转换. 实际使用的时候肯定是把需要的宏包和自定义命令都写在template里面, 比较少用<code>header-includes</code>来定义, 这里就不展开了.</p>
</li>
</ul>
<h3>语言</h3>
<p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">lang:</span> <span class="string">en</span></span><br><span class="line"><span class="attr">dir:</span> <span class="string">ltr</span></span><br><span class="line"><span class="meta">---</span></span><br></pre></td></tr></table></figure></p>
<p><code>lang</code>标识文档的主要语言, 语言代码符合<a href="https://tools.ietf.org/html/bcp47" target="_blank" rel="noopener">BCP 47</a>(BCP: Best Current Practices). 虽说要符合, 但是这个网站并没有直接给出所有可用的语言标签. 暂时只用英语en.</p>
<p><code>dir</code>控制文字从左向右(ltr)还是从右向左(rtl). 只有<code>xelatex</code>作为PDF引擎使才能完全支持<code>dir</code>. 测试发现rtl在<code>--pdf-engine=pdflatex</code>下不会报错, 但也没有效果.</p>
<h3>可用的LaTeX变量</h3>
<p>这一节总结一些针对LaTeX转换的pandoc变量, 按照用途不同做了简单分类.</p>
<h4>排版布局</h4>
<table>
<thead>
<tr>
<th>变量名</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>papersize</code></td>
<td>纸张大小, <code>letter</code>,<code>a4</code></td>
</tr>
<tr>
<td><code>fontsize</code></td>
<td>字体大小</td>
</tr>
<tr>
<td><code>documentclass</code></td>
<td>文档类型, <code>article</code>, <code>report</code>, <code>book</code>, <code>memoir</code></td>
</tr>
<tr>
<td><code>beameroption</code></td>
<td>beamer选项</td>
</tr>
<tr>
<td><code>geometry</code></td>
<td>设置geometry包的选项, 可设多个值</td>
</tr>
<tr>
<td><code>linestretch</code></td>
<td>使用<code>setspace</code>包调节行间距</td>
</tr>
<tr>
<td><code>subparagraph</code></td>
<td>禁用LaTeX模板中将段落重定义为节的行为</td>
</tr>
<tr>
<td><code>lof</code>,<code>lot</code></td>
<td>包含图和表的列表</td>
</tr>
<tr>
<td><code>thanks</code></td>
<td>在标题后添加致谢内容</td>
</tr>
</tbody>
</table>
<p>使用<code>ctexart</code>文档类型可以解决字体问题, 因为这个宏包中包含了字体设置</p>
<p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">documentclass:</span> <span class="string">ctexart</span></span><br><span class="line"><span class="meta">---</span></span><br></pre></td></tr></table></figure></p>
<p>也可以通过改变下面的字体变量手动调节.</p>
<h4>字体</h4>
<table>
<thead>
<tr>
<th>变量名</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>fontfamily</code></td>
<td>设置<code>pdflatex</code>使用的字体包, 默认为Latin Modern (lm).</td>
</tr>
<tr>
<td><code>fontfamilyoption</code></td>
<td>对应<code>fontfamily</code>的选项</td>
</tr>
<tr>
<td><code>mainfont</code>等</td>
<td><code>xelatex</code>使用的字体. 利用<code>fontspec</code>包, 可使用系统字体.</td>
</tr>
<tr>
<td><code>mainfontoption</code>等</td>
<td>对应于<code>mainfont</code>等的字体选项</td>
</tr>
<tr>
<td><code>fontenc</code></td>
<td>字体编码. 默认<code>T1</code>应该够用.</td>
</tr>
</tbody>
</table>
<p><code>mainfont</code>等中包含字体变量<code>mainfont</code>, <code>romanfont</code>, <code>sansfont</code>, <code>monofont</code>,<code>mathfont</code>和<code>CJKmainfont</code>. <code>CJKmainfont</code>的使用需要有<code>xecjk</code>包. 每一个都对应一个<code>fontoption</code>字体选项变量. 系统中可用的中文字体可通过<code>fc-list:lang=zh-cn</code>查看. 日语字体用<code>:lang=ja</code>.</p>
<p>做以下改动</p>
<p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">CJKmainfont:</span> <span class="string">Songti</span> <span class="string">SC</span></span><br><span class="line"><span class="attr">mainfont:</span> <span class="string">Times</span> <span class="string">New</span> <span class="string">Roman</span></span><br><span class="line"><span class="meta">---</span></span><br></pre></td></tr></table></figure></p>
<p>将<code>CJKmainfont</code>设为<code>Songti SC</code>后上面的字体缺失Warning就没有了. 如果直接把<code>mainfont</code>改成<code>Songti SC</code>也可以解决问题, 但如此一来英文字体也会应用宋体, 看上去就会比较奇怪(用Word应该很有体验). <a href="https://github.com/jgm/pandoc/wiki/Pandoc-With-Chinese-(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87)" target="_blank" rel="noopener">Pandoc Wiki</a>上说用应该把<code>mainfont</code>设为中文字体, 我觉得并不必要.</p>
<h4>颜色</h4>
<table>
<thead>
<tr>
<th>变量名</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>colorlinks</code></td>
<td>链接颜色开关</td>
</tr>
<tr>
<td><code>linkcolor</code></td>
<td>内链颜色</td>
</tr>
<tr>
<td><code>filecolor</code></td>
<td>外链颜色</td>
</tr>
<tr>
<td><code>citecolor</code></td>
<td>引用颜色</td>
</tr>
<tr>
<td><code>urlcolor</code></td>
<td>URL链接颜色</td>
</tr>
<tr>
<td><code>toccolor</code></td>
<td>TOC链接颜色</td>
</tr>
</tbody>
</table>
<p>颜色选项由<code>xcolor</code>提供, 链接颜色由<code>hyperref</code>包及<code>\hypersetup{}</code>命令设置. <code>xcolor</code>手册Section 4中给出了基本颜色和通过<code>dvipsnames</code>,<code>svgnames</code>,<code>x11names</code>选项可用的颜色名字. 比如</p>
<p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">colorlinks:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">linkcolor:</span> <span class="string">red</span></span><br><span class="line"><span class="attr">filecolor:</span> <span class="string">Cyan</span></span><br><span class="line"><span class="attr">urlcolor:</span> <span class="string">Navy</span></span><br><span class="line"><span class="attr">toccolor:</span> <span class="string">Ivory3</span></span><br><span class="line"><span class="meta">---</span></span><br></pre></td></tr></table></figure></p>
<p>Navy和Ivory3分别是svgnames和x11names里的颜色名字. 使用svgnames和x11names里的颜色时, 由于默认模板里关于xcolor的语句是</p>
<p><figure class="highlight tex"><table><tr><td class="code"><pre><span class="line"><span class="tag">\<span class="name">usepackage</span><span class="string">[dvipsnames,svgnames*,x11names*]</span><span class="string">&#123;xcolor&#125;</span></span></span><br></pre></td></tr></table></figure></p>
<p>此时要使用这两种颜色必须用<code>\definecolors{}</code>事先激活. 比如在模板里xcolor包后添加</p>
<p><figure class="highlight tex"><table><tr><td class="code"><pre><span class="line"><span class="tag">\<span class="name">definecolors</span><span class="string">&#123;Navy&#125;</span></span></span><br><span class="line"><span class="tag">\<span class="name">definecolors</span><span class="string">&#123;Ivory3&#125;</span></span></span><br></pre></td></tr></table></figure></p>
<p>否则会报错</p>
<p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">! Package xcolor Error: Undefined color `Navy&apos;.</span><br></pre></td></tr></table></figure></p>
<p>用相对路径、<code>file://</code>加相对路径或直接绝对路径的本地文件和URL链接都是Navy色. 用<code>run:</code>可以产生Cyan色的文件链接(file link), 但是这样的链接对markdown没有意义.</p>
<h4>参考文献</h4>
<p>因为暂时还不会考虑加入参考文献(目前至多考虑脚注), 而且想要用markdown+模板达到和用期刊模板一样的参考文献效果似乎不是那么简单, 所以暂不做深入讨论, 可以参考最后的例子和其他网络资源.</p>
<table>
<thead>
<tr>
<th>变量名</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>bibliograph</code></td>
<td>包含参考文献的bib文件</td>
</tr>
<tr>
<td><code>biblio-style</code></td>
<td>参考文献风格</td>
</tr>
<tr>
<td><code>biblio-title</code></td>
<td>参考文献标题</td>
</tr>
<tr>
<td><code>biblatexoptions</code></td>
<td>biblatex选项</td>
</tr>
<tr>
<td><code>natbiboptions</code></td>
<td>natbib选项</td>
</tr>
<tr>
<td><code>csl</code></td>
<td>引用和参考文献风格文件</td>
</tr>
</tbody>
</table>
<p>使用<code>--filter pandoc-citeproc</code>工具来处理文献时, 会从bib文件中根据markdown提取所需要的参考文献, 再通过CSL文件进行剪裁后加入. 引用的语法为<code>[@bibkey]</code>. 如果脚注上出现引用, 选择. 另外还有一个比较重要的问题是, 直接用<code>pandoc-citeproc</code>无法建立到文献的链接.</p>
<p>另一种做法是使用<code>--biblatex</code>, 但pandoc manual上注明它不是面向直接转化为PDF的, 而是在产生tex文件后手动编译tex. 为了确认这一点, 我尝试直接输出到PDF, 发现尽管<code>[@bibkey]</code>引用可以正常转化成<code>\cite{bibkey}</code>, 但实际在文档里只显示出加粗的<code>[bibkey]</code>,且<code>\printbibliography</code>指令也打印不出参考文献, 跟<a href="https://tex.stackexchange.com/questions/135484/still-biblatex-will-not-print-bibliography" target="_blank" rel="noopener">这个链接描述的现象</a>一模一样. 这是由于交叉引用需要执行一整套工具链, 而pandoc只运行一步latex.</p>
<p><code>biblatex</code>默认使用<code>biber</code>为后端, 若使用<code>bibtex</code>来处理参考文献, 需要在元数据块中添加</p>
<p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">biblatexoptions:</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">backend=bibtex</span></span><br><span class="line"><span class="meta">---</span></span><br></pre></td></tr></table></figure></p>
<p>这个选项只会在<code>--biblatex</code>开启时有用. 另外<a href="https://pandoc.org/MANUAL.html#citations" target="_blank" rel="noopener">手册指出</a>, 在<code>--bibliography</code>选项中使用<code>.bibtex</code>扩展名的文件时会强制使用<code>bibtex</code>(force bibtex), 但不应该误解: 这里我仍然用的是biblatex, 只是用bibtex而不是biber作为其后端.</p>
<p>参考文献和引用格式可以通过<code>biblio-style</code>变量设定, 比如<code>-M biblio-style=nature</code>选择nature引用风格. 查看<a href="https://www.ctan.org/tex-archive/macros/latex/exptl/biblatex-contrib" target="_blank" rel="noopener">CTAN的biblatex-contrib</a>查看有哪些可用的风格, 或者在Tex Live Utility搜索biblatex, 查看每个相关包的说明, 又或者查看这个overleaf链接<a href="https://www.overleaf.com/learn/latex/Biblatex_citation_styles" target="_blank" rel="noopener">Biblatex citation styles</a>.</p>
<h3>插入图表</h3>
<p>除了直接用makrdown语法插入图片外, Pandoc支持属性和名称引用, 包含在花括号<code>{}</code>内</p>
<p><figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line">![<span class="string">This is my website logo.</span>](<span class="link">icon.jpg</span>)&#123;width=50% #fig:favicon&#125;</span><br></pre></td></tr></table></figure></p>
<p>可在正文中插入<code>+@fig:favicon</code>以引用. 为了得到正确的交叉引用链接, 需要安装<a href="https://github.com/tomduck/pandoc-fignos" target="_blank" rel="noopener">pandoc-fignos</a>作为过滤器.</p>
<p>在制作表格时, pandoc支持单元格含多行文字的表格, 也能非常方便的调整列的对齐方式, 比如以下三列分别是左中右对齐的.</p>
<p><figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line">| left | center | right |</span><br><span class="line">| :--- | :----: | ----: |</span><br><span class="line">| l    |   c    |     r |</span><br><span class="line"></span><br><span class="line">Table: demo left-center-right table &#123;#tbl:demo-tbl&#125;</span><br></pre></td></tr></table></figure></p>
<table>
<thead>
<tr>
<th style="text-align:left">left</th>
<th style="text-align:center">center</th>
<th style="text-align:right">right</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">l</td>
<td style="text-align:center">c</td>
<td style="text-align:right">r</td>
</tr>
</tbody>
</table>
<p>在正文中插入<code>+@tbl:demo-tbl</code>以引用. 类似的, 转化时用<a href="https://github.com/tomduck/pandoc-tablenos" target="_blank" rel="noopener">pandoc-tablenos</a>过滤后才能得到正确的交叉引用链接.</p>
<h2>实例: 转换<code>demo.md</code>到<code>demo.pdf</code></h2>
<p>最后放一个用<code>markdown+pandoc+xelatex+bibtex</code>的实际例子, 所需文件都在<a href="demo.tar.gz">压缩包</a>里, 欢迎下载. <code>make</code>编译需要有pandoc和TeXLive等LaTeX发行版.</p>
<ul>
<li><code>demo.md</code>：Markdown源文件</li>
<li><code>Makefile</code>: 产生需要的<code>template.tex</code>和<code>HW.md</code>, 执行LaTeX工具链</li>
<li><code>demo.bib</code>: 用到的参考文献</li>
<li><code>icon.jpg</code>: 要插的图片, 就是我的网站图标啦.</li>
</ul>
<p>作为参考, 在<a href="https://gist.github.com/maxogden/97190db73ac19fc6c1d9beee1a6e4fc8" target="_blank" rel="noopener">这个gist</a>里作者也详细介绍了如何将markdown转化成paper. 但对于其中的pizza图片, markdown下用的<code>![It's a pizza]</code>作为图片注释, 转化到PDF后图片注释却变成了<code>Figure 1</code>. 我这里倒是没有这个问题.</p>
<p>另外, 由于用HTML的转化比较直接, 所需要的就是找个喜欢的CSS, 就不展示了 :P</p>
<h2>总结</h2>
<p>本文整理了笔者在第一次尝试用pandoc转化markdown文件为PDF的过程中学到的技巧, 并提供了一个简单的pandoc+latex转换PDF的样例输入.</p>

	
	</div>
  <!-- categories -->
  <span style="font-size:90%">
  
  <i style="color:#bbb" class="fa fa-folder"></i> <a style="color:#bbb" href="/categories/Software/">Software</a>
  </span>
  &nbsp
  <!-- tags -->
  <span style="font-size:90%" >
  
  <a style="color:#bbb" href="/tags/Pandoc/">#Pandoc</a>&nbsp&nbsp<a style="color:#bbb" href="/tags/Markdown/">#Markdown</a>&nbsp&nbsp<a style="color:#bbb" href="/tags/LaTeX/">#LaTeX</a>
  </span>
  <!-- read more button -->
  <a type="button" href="/2019/01/02/pandoc-md-to-pdf/#more" class="pull-right btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->	
		<h3 class="title">
			<div class="date"> 2018-07-20 </div>
			<div class="article-title"><a href="/2018/07/20/gpaw-1/" >GPAW笔记(一)——安装及测试</a></div>						
		</h3>
	


			<div class="entry">
  <div class="row">
	
	
		<link rel="stylesheet" type="text/css" href="/css/hint.min.css"><p><div class="alert alert-success"><i class="fa fa-lightbulb-o  float-left"></i>  <p>本系列将介绍如何使用第一性原理电子结构计算Python包<a href="https://wiki.fysik.dtu.dk/gpaw/index.html" target="_blank" rel="noopener">GPAW</a>，进行材料的电子结构模拟，包括最基本的DFT基态计算以及更高级的准粒子<em>GW</em>和BSE的光谱性质计算。本文作为该系列的第一篇文章，对GPAW在本地和集群上的安装、样例测试进行介绍，总结了这一过程中遇到的问题和解决方案。</p>
</div>
&lt;!-- more --&gt;</p>
<p>a</p>
<h2>背景</h2>
<p>相比较VASP、WIEN2k、QE等主流材料几何和电子结构计算程序，GPAW具有的最大特点就是它是一个Python模块，而不是一个独立的程序。你可以像读其他Python模块代码一样读它，查看它属性和docstring，函数依赖参数明确。GPAW中体系构筑依赖于<a href="https://wiki.fysik.dtu.dk/ase" target="_blank" rel="noopener">ASE</a>，一个集成度很高的原子模拟函数模块，作为各种DFT calculator的接口和数据处理及可视化模块被广泛使用。事实上GPAW和ASE都是DTU Thygesen课题组开发维护，因此可以把GPAW看成是ASE自己的first-principles calculator。GPAW中一些performance-critical组件由NumPy或自编的C扩展实现，因此GPAW的计算效率也是有保证的。</p>
<p>我对GPAW的了解始于对低维体系准粒子能带结构的研究，在这方面Thygesen课题组做了很多重要的工作，这些自然是在GPAW中进行的代码实现，包括参数收敛测试和analytical correction to long wavelength limit，尤其后者是我们希望在LAPW框架下实现的。在读懂代码之前，总应该先熟悉它的使用吧。于是想到了做这个系列。这一回从编译安装开始。</p>
<p>GPAW安装基于Python模块ASE、NumPy，线性代数库BLAS/LAPACK以及交换关联泛函库LIBXC。快速傅里叶变换可以通过链接FFTW3加速，并行计算可(大规模并行时必须)链接ScaLAPACK。本文将利用以上所有的库，其中线性代数库和ScaLAPACK用Intel MKL代替。</p>
<p>以下过程所用的<code>python</code>均为在<a href="https://hpc.pku.edu.cn" target="_blank" rel="noopener">北京大学高性能计算平台</a>上anaconda/2-4.4.0.1模块[<code>anaconda (version 1.6.3)</code>]内的<code>python 2.7.15</code>，C扩展的编译器为Intel 2017 update 1的<code>mpiicc</code>，FFTW3(3.3.4)和LIBXC(4.2.3)均由该版本Intel编译器编译。</p>
<h2>正文</h2>
<p>作为Python模块，GPAW在<a href="https://pypi.org/" target="_blank" rel="noopener">Python Package Index</a>有项目记录，因此可以使用</p>
<p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">pip install gpaw --user</span><br></pre></td></tr></table></figure></p>
<p>将其安装到本地用户目录。但这种安装方式不容易控制和自定义外部库的链接，因此我们采用从源码手动安装的方式。主要分以下几步进行。</p>
<h3>依赖的安装</h3>
<h4>NumPy</h4>
<p>载入<code>anaconda</code>环境中已经预装了NumPy环境</p>
<h4>ASE</h4>
<p>使用<code>pip</code>安装</p>
<p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">pip install ase --user</span><br></pre></td></tr></table></figure></p>
<h4>FFTW3</h4>
<p>留待补充，可先参考官方文档。</p>
<h4>LIBXC</h4>
<p>留待补充，可先参考官方文档。</p>
<h3>下载源码</h3>
<p>登录GPAW的<a href="https://gitlab.com/gpaw/gpaw/tags" target="_blank" rel="noopener">GitLab-tags</a>，或者在<a href="https://wiki.fysik.dtu.dk/gpaw/install.html#getting-the-source-code" target="_blank" rel="noopener">这里</a>获取最新版本GPAW的tarball, 解压缩得到文件夹<code>gpaw-x.x.x</code>，其中<code>x.x.x</code>为版本号。该文件夹的结构如下</p>
<p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">.</span><br><span class="line">├── c/                 # C扩展源码</span><br><span class="line">├── CHANGELOG.rst</span><br><span class="line">├── config.py</span><br><span class="line">├── configuration.log</span><br><span class="line">├── CONTRIBUTING.rst</span><br><span class="line">├── COPYING</span><br><span class="line">├── customize.py       # 自定义文件</span><br><span class="line">├── gpaw/              # Python源码</span><br><span class="line">├── LICENSE</span><br><span class="line">├── MANIFEST.in</span><br><span class="line">├── PKG-INFO</span><br><span class="line">├── README.rst</span><br><span class="line">├── setup.py</span><br><span class="line">└── tools/             # 可执行程序，包括并行解释器gpaw-python</span><br></pre></td></tr></table></figure></p>
<p>我们暂时将其放在家目录下，即<code>~/gpaw-x.x.x</code>，之后我们将称其为GPAW家目录。</p>
<h3>修改<code>customize.py</code></h3>
<p>经过各种标准的和愚蠢的试错，一个可行的自定义文件写法为</p>
<p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line">compiler = <span class="string">'mpiicc -fPIC'</span></span><br><span class="line">mpicompiler = <span class="string">'mpiicc -fPIC'</span>  <span class="comment"># use None if you don't want to build a gpaw-python</span></span><br><span class="line">mpilinker = mpicompiler</span><br><span class="line"></span><br><span class="line"><span class="comment"># the following variables should be defined according to your own environment</span></span><br><span class="line">FFTW3_HOME = <span class="string">'/path/to/FFTW3'</span></span><br><span class="line">MKLROOT    = <span class="string">'/path/to/mkl'</span></span><br><span class="line">LIBXC_HOME = <span class="string">'/path/to/libxc'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># the order is adapted from Intel MKL link advisor</span></span><br><span class="line">libraries = [</span><br><span class="line">              <span class="string">'mkl_scalapack_lp64'</span>,</span><br><span class="line">              <span class="string">'mkl_intel_lp64'</span> ,<span class="string">'mkl_sequential'</span> ,<span class="string">'mkl_core'</span>,</span><br><span class="line">              <span class="string">'mkl_blacs_intelmpi_lp64'</span>,</span><br><span class="line">              <span class="string">'pthread'</span>,<span class="string">'m'</span>,<span class="string">'dl'</span>,</span><br><span class="line">            ]</span><br><span class="line">mpi_libraries = []</span><br><span class="line"></span><br><span class="line">library_dirs = [ MKLROOT+<span class="string">'/lib/intel64/'</span> , FFTW3_HOME+<span class="string">'/lib/'</span>]</span><br><span class="line"><span class="comment"># include numpy header to use array object</span></span><br><span class="line">include_dirs += [np.get_include(), MKLROOT+<span class="string">'/include/'</span>, FFTW3_HOME+<span class="string">'/include/'</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># switch on ScaLAPACK</span></span><br><span class="line">scalapack = <span class="literal">True</span></span><br><span class="line"><span class="keyword">if</span> scalapack:</span><br><span class="line">    define_macros += [(<span class="string">'GPAW_NO_UNDERSCORE_CBLACS'</span>, <span class="string">'1'</span>)]</span><br><span class="line">    define_macros += [(<span class="string">'GPAW_NO_UNDERSCORE_CSCALAPACK'</span>, <span class="string">'1'</span>)]</span><br><span class="line"></span><br><span class="line"><span class="comment"># - dynamic linking LIBXC (requires rpath or setting LD_LIBRARY_PATH at runtime):</span></span><br><span class="line"><span class="keyword">if</span> <span class="literal">True</span>:</span><br><span class="line">    include_dirs += [LIBXC_HOME+<span class="string">'/include'</span>]</span><br><span class="line">    library_dirs += [LIBXC_HOME+<span class="string">'/lib'</span>]</span><br><span class="line">    <span class="comment"># You can use rpath to avoid changing LD_LIBRARY_PATH:</span></span><br><span class="line">    extra_link_args += [<span class="string">'-Wl,-rpath=%s/lib'</span> % LIBXC_HOME]</span><br><span class="line">    <span class="keyword">if</span> <span class="string">'xc'</span> <span class="keyword">not</span> <span class="keyword">in</span> libraries:</span><br><span class="line">        libraries.append(<span class="string">'xc'</span>)</span><br></pre></td></tr></table></figure></p>
<p><span class="label label-danger">问题</span> 之前在这里遇到过一个问题是，当设置<code>compiler=icc</code>时，尽管可以编译通过，但在运行测试时会报错</p>
<p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">libmkl_blacs_intelmpi_lp64.so: undefined symbol 'MPI_Finalize'</span><br></pre></td></tr></table></figure></p>
<p><span class="label label-success">解决</span>事实上<code>MPI_Finalize</code>本就不是在BLACS里定义的符号，而是MPI库中<code>libmpi.so.12</code>中定义的。这个错误的原因在于<code>libraries</code>是由<code>compiler</code>和<code>mpicompiler</code>公用的链接选项，尽管<code>mpiicc</code>会自动链接<code>libmpi.so</code>，但<code>icc</code>不会，所以会缺少MPI符号定义。将<code>compiler=icc</code>改成<code>compiler=mpiicc</code>即可解决问题。另一种办法是在<code>libraries</code>中增加成员<code>mpi</code>，同时在<code>library_dirs</code>和<code>library_include</code>中分别增加MPI库的lib和include，但这就比较繁琐了。</p>
<p><span class="label label-info">其他尝试</span> 在出现上面错误的时候，我也尝试了不链接ScaLAPACK和BLACS的办法(<code>scalapack=False</code>)，可以正常通过所有串行和并行测试，但在做Diamond (两原子) <em>GW</em>的全节点32核并行计算时报错</p>
<p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">AttributeError: BLACS is unavailable. GPAW must be compiled with BLACS/ScaLAPACK, and must run in MPI-enabled interpreter (gpaw-python)</span><br></pre></td></tr></table></figure></p>
<p>所以看来在做大规模并行时，GPAW要求BLACS/ScaLAPACK是必须的，从计算的经济性角度上来看也是可以理解的，帮用户省些钱。我也尝试了用GCC(4.8.5)编译依赖和GPAW，但在链接ScaLAPACK时遇到了问题，要求我用<code>-fPIC</code>选项重新编译所有静态库，但其实我在编译时一直带着该选项。在此注明。</p>
<h3>开始编译</h3>
<p>在GPAW根目录下，输入</p>
<p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">python setup.py install --user</span><br></pre></td></tr></table></figure></p>
<p>开始编译。C扩展的编译过程会创建<code>build</code>文件夹，编译结束后会将<code>gpaw</code>文件夹和编译产生的C扩展库<code>_gpaw.so</code>复制到<code>~/.local/lib/python2.7/site-packages/</code>下，复制<code>gpaw</code>等可执行程序到<code>~/.local/bin</code>下。</p>
<h3>安装PAW集测试</h3>
<p>测试前需要将<code>~/.local/bin</code>添加到<code>PATH</code>下。此时还仍然无法进行计算，因为GPAW依赖于赝势和PAW数据集，而下载的源代码中并不包含这一部分。此时需要执行(例如在GPAW根目录下)</p>
<p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">gpaw install-data pawdir</span><br></pre></td></tr></table></figure></p>
<p>让GPAW下载PAW数据集(需要联网，PKUHPC上请使用<code>connect</code>命令，见<a href="https://its.pku.edu.cn/download_ipgwclient.jsp" target="_blank" rel="noopener">pku-its-download</a>)。下载完成后，GPAW会将<code>pawdir</code>绝对路径添加到<code>~/.gpaw/rc.py</code>中，以作为赝势PAW搜索路径。</p>
<p>结束以上步骤后即可进行测试，四核独立串行测试</p>
<p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">gpaw test -j 4</span><br></pre></td></tr></table></figure></p>
<p>四核并行测试</p>
<p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">gpaw -P 4 test</span><br></pre></td></tr></table></figure></p>
<p>或</p>
<p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">mpiexec -np 4 gpaw-python -m gpaw test</span><br></pre></td></tr></table></figure></p>
<p><div class="alert alert-warning"><i class="fa fa-bell  float-left"></i>  <p>用上面的<code>customize.py</code>做并行测试时会在<code>parallel/augment_grid.py</code>报<code>MPI_Barrier</code>错误从而无法全部通过, 但可以使用32核跑官网Tutorial<a href="https://wiki.fysik.dtu.dk/gpaw/tutorials/gw_tutorial/gw_tutorial.html" target="_blank" rel="noopener">准粒子计算</a>的例子<a href="https://wiki.fysik.dtu.dk/gpaw/tutorials/gw_tutorial/gw_tutorial.html#convergence-with-respect-to-cutoff-energy-and-number-of-k-points" target="_blank" rel="noopener">C_ecut_k_conv_GW.py</a></p>
</div></p>
<h3>实际计算</h3>
<p>测试通过(Hopefully)！可以做具体计算啦。如果写好了名为<code>runscript.py</code>的GPAW并行计算脚本，那么在添加可执行权限后，可以按照如下指令在本地或登录节点执行计算</p>
<p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">mpiexec -np 4 gpaw-python runscript.py</span><br></pre></td></tr></table></figure></p>
<p>而<code>runscript.py</code>具体要怎么写，就是后面教程要做的事情了。</p>
<h2>总结</h2>
<p>经过了一段比较挣扎和丢人的编译历程，总算将GPAW编译成功并能用PKUHPC上一整个节点的核心并行计算官方算例。</p>

	
	</div>
  <!-- categories -->
  <span style="font-size:90%">
  
  <i style="color:#bbb" class="fa fa-folder"></i> <a style="color:#bbb" href="/categories/Software/">Software</a>
  </span>
  &nbsp
  <!-- tags -->
  <span style="font-size:90%" >
  
  <a style="color:#bbb" href="/tags/Compilation/">#Compilation</a>&nbsp&nbsp<a style="color:#bbb" href="/tags/Intel/">#Intel</a>&nbsp&nbsp<a style="color:#bbb" href="/tags/GPAW/">#GPAW</a>
  </span>
  <!-- read more button -->
  <a type="button" href="/2018/07/20/gpaw-1/#more" class="pull-right btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->	
		<h3 class="title">
			<div class="date"> 2018-05-15 </div>
			<div class="article-title"><a href="/2018/05/15/f2py-1/" >Python笔记(一)——利用F2PY调用Fortran函数或子程序</a></div>						
		</h3>
	


			<div class="entry">
  <div class="row">
	
	
		<link rel="stylesheet" type="text/css" href="/css/hint.min.css"><p><div class="alert alert-success"><i class="fa fa-lightbulb-o  float-left"></i>  <p>介绍如何在Python脚本中，通过引入Fortran动态库调用Fortran子程序，加速Python中的数值计算。以矩阵乘法为例，比较了调用Python中NumPy和SciPy包的方法和使用Fortran子程序两种方式在计算效率上的差别。</p>
</div>
&lt;!-- more --&gt;</p>
<p>Python作为一种动态的解释型编译器，尽管具有新手友好、直观易读、适用范围广的特点，但比起静态的编译型语言Fortran/C，在数值计算方面的表现要差许多，这是由于Python没有被预先编译到机器语言层面。目前流行的Python数值计算包<a href="http://www.numpy.org/" target="_blank" rel="noopener">NumPy</a>和<a href="https://www.scipy.org/scipylib/index.html" target="_blank" rel="noopener">SciPy</a>提供了大量数值计算相关的函数和方法，在很大程度上弥补了Python这一缺点，但仍然无法满足数值计算的全部需求，特别是难以链接一些尚未Python模块化的数学库和工具库。</p>
<p>作为老牌数值计算语言，Fortran拥有许多高效的数学库，我们很容易在Fortran程序中使用他们，但要把他们用到Python中则并不是那么容易。一种解决方案是使用<a href="https://docs.scipy.org/doc/numpy/f2py/" target="_blank" rel="noopener">F2PY</a>产生Python接口，它是NumPy项目的一部分。基于F2PY，在Python中调用Fortran函数的基本流程是</p>
<ol>
<li>编写使用了数学库的Fortran代码</li>
<li>在恰当的编译选项下使用<code>f2py</code>编译Fortran代码，产生可供引入的动态库</li>
<li>在Python中通过<code>import</code>引入动态库</li>
</ol>
<p>这样就能像调用Python包一样使用Fortran代码中定义的子程序和函数了。下面先简单介绍如何使用<code>f2py</code>，再以矩阵乘法作为例子做说明。</p>
<h2>使用F2PY产生供Python引入的动态库</h2>
<h3>聪明的方法: 创建署名文件</h3>
<p><code>f2py</code>安装就不多说了, 直接上用法.</p>
<p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">f2py mysubr.F90 -m mysubr -h mysubr.pyf</span><br></pre></td></tr></table></figure></p>
<p>其中产生的<code>.pyf</code>就是所谓的署名文件(signature file)。其中定义了Python模块<code>mysubr</code>，它包含一个接口，<code>mysubr.F90</code>中所有函数和子程序都被声明在该接口中。每个声明中包含函数所需参量的类型和维度具体信息。具体可参照<a href="https://docs.scipy.org/doc/numpy/f2py/getting-started.html#the-smart-way" target="_blank" rel="noopener">官方文档</a>。产生<code>.pyf</code>文件后，可用下面的命令</p>
<p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">f2py -c mysub.pyf mysubr.F90</span><br></pre></td></tr></table></figure></p>
<p>产生动态库。编译时链接外部函数库(MKL或者FFTW)和一般的编译器相同</p>
<p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># link mysubr against libabc.a in /lib/dir/</span></span><br><span class="line">f2py -c mysub.pyf mysubr.F90 -L/lib/dir/ -labc</span><br></pre></td></tr></table></figure></p>
<p>所有<code>f2py</code>命令可以用<code>python -m numpy.f2py</code>等价替换, 这样做的好处是f2py版本总是与python版本兼容.</p>
<h2>举例: 矩阵乘法</h2>
<h3>矩阵生成</h3>
<p>在进行矩阵乘法前，首先利用<code>random</code>模块产生<code>ndarray</code>类型的矩阵，这里取100维的方阵进行测试。具体代码如下所示:</p>
<p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">from</span> random <span class="keyword">import</span> seed, random</span><br><span class="line"></span><br><span class="line"><span class="comment"># set the dimensions</span></span><br><span class="line">m = <span class="number">100</span></span><br><span class="line">k = <span class="number">100</span></span><br><span class="line">n = <span class="number">100</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># create mat1(m,k) and mat2(k,n) matrices</span></span><br><span class="line">seed()</span><br><span class="line">mat1 = np.array([[random() <span class="keyword">for</span> col <span class="keyword">in</span> range(k)] <span class="keyword">for</span> row <span class="keyword">in</span> range(m)], \</span><br><span class="line">                order=<span class="string">'F'</span>, dtype=<span class="string">'float64'</span>)</span><br><span class="line">seed()</span><br><span class="line">mat2 = np.array([[random() <span class="keyword">for</span> col <span class="keyword">in</span> range(n)] <span class="keyword">for</span> row <span class="keyword">in</span> range(k)], \</span><br><span class="line">                order=<span class="string">'F'</span>, dtype=<span class="string">'float64'</span>)</span><br></pre></td></tr></table></figure></p>
<p><code>order='F'</code>使用Fortran的数据存储方式。为保证计算效率，必须<strong>手动设置该值</strong>。</p>
<p><div class="alert alert-danger"><i class="fa fa-bug  float-left"></i>  <p>order默认为C。如果不覆盖默认值，Fortran代码的运算效率将下降很多。</p>
</div></p>
<h3>执行矩阵乘法</h3>
<p>我们比较四种不同的矩阵乘法实现</p>
<ol>
<li>
<p>NumPy的<code>matmul</code>函数</p>
<p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">mat3 = np.matmul(mat1, mat2)</span><br></pre></td></tr></table></figure></p>
</li>
<li>
<p>SciPy的<code>linalg.blas.dgemm</code>函数</p>
<p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> scipy <span class="keyword">import</span> linalg</span><br><span class="line">mat3 = linalg.blas.dgemm(<span class="number">1.0</span>, mat1, mat2)</span><br></pre></td></tr></table></figure></p>
</li>
<li>
<p>Fortran的<code>matmul</code>函数</p>
<p><figure class="highlight fortran"><table><tr><td class="code"><pre><span class="line"><span class="comment">! file: f_matmul.F90</span></span><br><span class="line"><span class="function"><span class="keyword">subroutine</span></span> f_matmul(m, n, k, mat1, mat2, mat3)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">integer</span>, <span class="keyword">intent</span>(<span class="keyword">in</span>)  :: m, n, k</span><br><span class="line">    <span class="keyword">real</span>(<span class="number">8</span>), <span class="keyword">intent</span>(<span class="keyword">in</span>)  :: mat1(m,k), mat2(k,n)</span><br><span class="line">    <span class="keyword">real</span>(<span class="number">8</span>), <span class="keyword">intent</span>(<span class="keyword">out</span>) :: mat3(m,n)</span><br><span class="line"></span><br><span class="line">    mat3 = <span class="built_in">matmul</span>(mat1, mat2)</span><br><span class="line"></span><br><span class="line"><span class="keyword">end</span> <span class="function"><span class="keyword">subroutine</span></span> f_matmul</span><br></pre></td></tr></table></figure></p>
<p><code>m,n,k</code>用于确定矩阵<code>mat1,mat2,mat3</code>的维度，这在纯Fortran中是必须声明的参数，但<code>f2py</code>会将其转化为可选参数，矩阵规模由从Python输入的<code>mat1,mat2</code>确定。在对应Python文件中加入</p>
<p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> f_matmul <span class="keyword">import</span> f_matmul</span><br></pre></td></tr></table></figure></p>
<p>即可调用.</p>
</li>
<li>
<p>Intel MKL的<code>dgemm</code>子程序</p>
<p>将上面Fortran代码中的<code>matmul</code>行替换为</p>
<p><figure class="highlight fortran"><table><tr><td class="code"><pre><span class="line"><span class="comment">! file: f_dgemm.F90</span></span><br><span class="line"><span class="function"><span class="keyword">subroutine</span></span> f_dgemm(m, n, k, mat1, mat2, mat3)</span><br><span class="line"><span class="comment">!...</span></span><br><span class="line">    <span class="keyword">call</span> dgemm(<span class="string">'N'</span>, <span class="string">'N'</span>, m, n, k, <span class="number">1.0D0</span>, mat1, m, mat2, k, <span class="number">0.0D0</span>, mat3, m)</span><br><span class="line"></span><br><span class="line"><span class="keyword">end</span> <span class="function"><span class="keyword">subroutine</span></span> f_dgemm</span><br></pre></td></tr></table></figure></p>
<p>此时编译需要链接MKL库，编译命令为</p>
<p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">f2py -c f_dgemm.pyf --fcompiler=intelem --compiler=intelem -L<span class="variable">$MKLROOT</span>/lib/intel64/ -lmkl_rt f_dgemm.F90</span><br></pre></td></tr></table></figure></p>
<p>在对应Python文件中加入</p>
<p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> f_dgemm <span class="keyword">import</span> f_dgemm</span><br></pre></td></tr></table></figure></p>
</li>
</ol>
<p>所有源码和编译用Makefile打包在这个<a href="f2py-1.tar.gz">压缩包</a>里了, 方便取用.</p>
<h3>测试结果</h3>
<p>测试结果如下</p>
<table>
<thead>
<tr>
<th>Dimension</th>
<th>3000 (o=C)</th>
<th>5000 (o=C)</th>
<th>3000</th>
<th>5000</th>
<th>10000</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>np.matmul</code></td>
<td>1.1611</td>
<td>5.2340</td>
<td>1.1611</td>
<td>5.2404</td>
<td>41.8116</td>
</tr>
<tr>
<td>SciPy <code>dgemm</code></td>
<td>1.3578</td>
<td>5.8640</td>
<td>1.1568</td>
<td>5.2255</td>
<td>41.4386</td>
</tr>
<tr>
<td>Fortran <code>matmul</code></td>
<td>1.4907</td>
<td>6.5730</td>
<td>1.3204</td>
<td>5.9488</td>
<td>48.3035</td>
</tr>
<tr>
<td>Intel MKL <code>dgemm</code></td>
<td>1.2586</td>
<td>5.4831</td>
<td>1.0553</td>
<td>4.8380</td>
<td>38.9050</td>
</tr>
</tbody>
</table>
<p>其中<code>o=C</code>表示使用C存储方式, 不注明则是用Fortran。通过比较可以得到下面的一些结论</p>
<ul>
<li>在Fortran order下，计算效率顺序为Fortran <code>matmul</code>&lt;<code>np.matmul</code>&lt;<code>scipy.linalg.blas.dgemm</code>&lt; Intel MKL <code>dgemm</code>。</li>
<li><code>np.array</code>在内存中的存储方式(<code>order='C'|'F'</code>)显著影响Fortran <code>matmul</code>, <code>scipy.linalg.blas.dgemm</code>和Intel MKL <code>dgemm</code>的计算效率，<code>order='F'</code>要比<code>'C'</code>快约10%。</li>
<li>不合理的存储方式(<code>'C'</code>)导致MKL效率低于<code>np.matmul</code>。</li>
<li>存储方式对<code>np.matmul</code>没有显著影响。</li>
</ul>
<h2>总结</h2>
<p>本文介绍了使用F2PY工具将Fortran代码编译为可供Python调用的动态库，并以矩阵乘法为例进行演示。同时，比较了流行的Python数值计算模块NumPy和SciPy中的实现与Fortran语言下<code>matmul</code>和MKL<code>dgemm</code>实现的计算效率。测试结果发现，在高维情况下，Intel MKL具有最高的效率。产生<code>ndarray</code>时的存储方式(<code>order=F</code>)对Fortran库中函数计算效率有显著影响。</p>
<h2>备注</h2>
<p>使用MKL的DGEMM时，用<code>f2py</code>链接MKL库编译后执行<code>test_mm.py</code>，报错</p>
<p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">Intel MKL FATAL ERROR: Cannot load libmkl_avx2.so or libmkl_def.so</span><br></pre></td></tr></table></figure></p>
<p>解决方法是在编译前preload几个核心的Intel库</p>
<p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">export</span> LD_PRELOAD=<span class="string">"<span class="variable">$MKLROOT</span>/lib/intel64/libmkl_def.so:<span class="variable">$MKLROOT</span>/lib/intel64/libmkl_sequential.so:<span class="variable">$MKLROOT</span>/lib/intel64/libmkl_core.so"</span></span><br></pre></td></tr></table></figure></p>
<p>必须按顺序全部预载入，否则<code>ld</code>会报错。</p>
<h2>更新</h2>
<h3>2019-05-02</h3>
<ol>
<li>
<p>时隔一年各类包都有更新, 原来的代码运行各种问题, 包括在<code>import f_matmul</code>时出现</p>
<p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ImportError: dynamic module does not define module export function (PyInit_f_matmul)</span><br></pre></td></tr></table></figure></p>
<p>这一条<a href="https://github.com/pytorch/ELF/issues/98" target="_blank" rel="noopener">pytorch issue</a>陈述了类似的问题, 我的理解是由于f2py和python<a href="https://github.com/numpy/numpy/issues/7769" target="_blank" rel="noopener">版本不兼容</a>所致. 用<code>python -m numpy.f2py</code>替代<code>f2py</code>即解决了这一问题.</p>
</li>
<li>
<p><code>order='Fortran'</code>替换为<code>order='F'</code>.</p>
</li>
<li>
<p>为方便测试, 将所有源码和Makefile<a href="f2py-1.tar.gz">打包</a>.</p>
</li>
</ol>
<p>修改后, Fedora 27下运行正常, 但macOS 10.14.4下会报错误</p>
<p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ImportError: dlopen(f_matmul.cpython-37m-darwin.so, 2): __dyld section not supported in f_matmul.cpython-37m-darwin.so</span><br></pre></td></tr></table></figure></p>
<p>根据<a href="https://software.intel.com/zh-cn/forums/intel-fortran-compiler-for-linux-and-mac-os-x/topic/799102" target="_blank" rel="noopener">这条18年10月的Intel Forum帖</a>, 这个问题似乎跟Xcode版本有关. 因为要赶ddl所以暂时没有考虑macOS, 如果有人知道如何解决的话麻烦指点我一下 :)</p>

	
	</div>
  <!-- categories -->
  <span style="font-size:90%">
  
  <i style="color:#bbb" class="fa fa-folder"></i> <a style="color:#bbb" href="/categories/Programming/">Programming</a>
  </span>
  &nbsp
  <!-- tags -->
  <span style="font-size:90%" >
  
  <a style="color:#bbb" href="/tags/Python/">#Python</a>&nbsp&nbsp<a style="color:#bbb" href="/tags/Fortran/">#Fortran</a>&nbsp&nbsp<a style="color:#bbb" href="/tags/F2PY/">#F2PY</a>&nbsp&nbsp<a style="color:#bbb" href="/tags/MKL/">#MKL</a>
  </span>
  <!-- read more button -->
  <a type="button" href="/2018/05/15/f2py-1/#more" class="pull-right btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->	
		<h3 class="title">
			<div class="date"> 2018-02-15 </div>
			<div class="article-title"><a href="/2018/02/15/Hexo-1/" >Hexo笔记(一)——安装, Markdown写作与主题</a></div>						
		</h3>
	


			<div class="entry">
  <div class="row">
	
	
		<link rel="stylesheet" type="text/css" href="/css/hint.min.css"><p><div class="alert alert-success"><i class="fa fa-lightbulb-o  float-left"></i>  <p>介绍使用Hexo配置本博客和用Markdown进行博文写作的基本方法和技巧，为撰写排版更好更清晰的技术文本作准备。</p>
</div>
&lt;!-- more --&gt;</p>
<h2>前言</h2>
<p>之前代码从来都是习惯在组里LinuxPC或者学校HPC上写的，但时常会因为不在随手可及的地方觉得不安。年前从学长手中购入MBP作为自己今后的代码生产主力，同时跑一点简单的科学代码，也想着把Linux和原笔记本上的一些代码项目移到Mac上。这自然就包括了这个Hexo博客。
尽管技术写作和笔记并没有停滞，但是一直处于比较粗浅的笔记状态，就没有敢上传到这里(还是希望比较成型后再传)。更主要的一个原因是觉得这个博客的界面配置还始终是未完成状态，自己不甚满意，平时也没有时间好好研究JavaScript和Nodejs代码，最后就没有上传笔记的动力了，导致这个个人域名完全处于浪费钱的状态。于是想趁着春节假期把博客框架好好整一整。
这篇文章内所有命令均在macOS High Sierra (10.13)或Mojave (10.14)下执行。默认Homebrew基本配置完成，包括本文所涉及的Git和Nodejs开发环境等，执行命令前需要拥有GitHub账户并完成Git全局配置。</p>
<h2>基本配置</h2>
<h3>GitHub Pages</h3>
<p>个人博客服务端使用<a href="https://pages.github.com" target="_blank" rel="noopener">Git Pages</a>，它是GitHub专为个人、组织用户和代码项目提供的页面服务，通过Git将本地HTML和CSS文件结构部署(deploy)到Page仓库master分支来实现。创建个人页面的方法是</p>
<ol>
<li>类似于一般代码仓库，在GitHub主页上创建名为<code>username@github.io</code>的仓库。以自己为例的话就是<code>minyez@github.io</code>的仓库。个人主页必须以此种方式命名。</li>
<li>进入新建的仓库，点击Setting标签，在<code>Options</code>下翻到<code>GitHub Pages</code>标签，可以看到这一部分处于激活模式。可与你的其他一般仓库(没有制作<code>doc</code>分支用于文档网站)进行对比。一般代码仓库也可以通过<code>Setting-&gt;Options-&gt;GitHub Pages</code>配置项目文档页面，需要选择<code>doc</code>分支承载HTML文件结构。</li>
<li>回到Code标签，新建<code>hexo</code>分支，并将其设为默认分支。之后<code>master</code>分支用来存储静态网页，<code>hexo</code>分支存储博文和主题的源文件。</li>
</ol>
<h3>安装Hexo和Git部署模块</h3>
<p>Hexo是一个模块集成的HTML和CSS文件结构生成程序，用户可以把精力集中在博文内容上，而让Hexo管理界面风格和样式。通过node包管理器<code>npm</code>安装<code>hexo</code></p>
<p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">npm hexo install</span><br></pre></td></tr></table></figure></p>
<p>安装完成后，在某路径下，创建本地Hexo文件夹并初始化。以<code>my-hexo-dir</code>为例</p>
<p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">mkdir my-hexo-dir</span><br><span class="line">cd my-hexo-dir</span><br><span class="line">hexo init</span><br></pre></td></tr></table></figure></p>
<p>初始化后，文件夹内结构为</p>
<p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">.</span><br><span class="line">├── _config.yml</span><br><span class="line">├── node_modules</span><br><span class="line">├── package-lock.json</span><br><span class="line">├── package.json</span><br><span class="line">├── scaffolds</span><br><span class="line">├── source</span><br><span class="line">└── themes</span><br></pre></td></tr></table></figure></p>
<p><code>node_modules</code>内包含在搭建网站时可能需要的模块，比如数学渲染模块<code>hexo-renderer-mathjax</code>和Git部署模块<code>hexo-deployer-git</code>，后者是我们通过Git部署GitHub Pages所必须的。安装模块通过<code>npm</code>完成，如</p>
<p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">npm install hexo-deployer-git --save</span><br></pre></td></tr></table></figure></p>
<p>加入<code>save</code>选项会更新<code>package.json</code>内的包依赖。 <code>--save</code>和<code>--save-dev</code>选项的比较可见这篇<a href="http://pwcong.me/2017/01/05/npm%E5%BC%95%E5%85%A5%E6%A8%A1%E5%9D%97%E6%97%B6--save-%E4%B8%8E--save-dev-%E7%9A%84%E5%8C%BA%E5%88%AB/" target="_blank" rel="noopener">文章</a>。</p>
<p>修改<code>_config.yml</code>中网络链接和与部署方法相关的代码块以启用<code>git</code>部署</p>
<p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># URL</span></span><br><span class="line"><span class="attr">url:</span> <span class="string">http://minyez.github.io</span></span><br><span class="line"><span class="comment"># deploy method. By Git</span></span><br><span class="line"><span class="attr">deploy:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">git</span></span><br><span class="line">    <span class="attr">repo:</span> <span class="string">https://github.com/minyez/minyez.github.io.git</span></span><br><span class="line">    <span class="attr">branch:</span> <span class="string">master</span></span><br></pre></td></tr></table></figure></p>
<p>这样一来，通过Hexo发布自己个人GitHub Pages博客的必要准备已经完成了。在<code>my-hexo-dir</code>下键入以下命令生成静态博客</p>
<p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">hexo g         <span class="comment"># 使用Hexo生成HTML</span></span><br><span class="line">hexo s -p 4000 <span class="comment"># 生成本地网址，端口为4000</span></span><br></pre></td></tr></table></figure></p>
<p>在浏览器访问<code>https://localhost:4000</code> 即可看到生成的Hexo博客。通过</p>
<p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">hexo d</span><br></pre></td></tr></table></figure></p>
<p>可以将静态页面推送到GitHub Pages中, 此时就能在username.github.io上看到博客了.</p>
<h3>主题选择</h3>
<p>本博客使用的是从<a href="https://github.com/PytLab/hexo-theme-freemind" target="_blank" rel="noopener">PytLab</a>处Fork来的<a href="https://github.com/minyez/hexo-theme-freemind" target="_blank" rel="noopener">Freemind</a>主题。首先将仓库下载到本地<code>themes</code>文件夹内</p>
<p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cd</span> themes</span><br><span class="line">git <span class="built_in">clone</span> https://github.com/minyez/hexo-theme-freemind freemind</span><br></pre></td></tr></table></figure></p>
<p>下载完成后，修改根目录下<code>_config.yml</code>文件中的<code>theme</code>标签以启用Freemind</p>
<p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">theme:</span> <span class="string">freemind</span></span><br></pre></td></tr></table></figure></p>
<p>若对其他主题感兴趣，可自行google并通过类似的方法架设。此时重新生成并访问，可以发现博客已经从Landscape变为Freemind主题。</p>
<h3>开始写作: 从模板新建</h3>
<p>在基本设置完成以后，我们就可以开始写作博客了。通过Hexo内建指令<code>new</code>创建新的博文</p>
<p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">hexo new post pname</span><br></pre></td></tr></table></figure></p>
<p>这会在<code>source/_posts</code>下创建Markdown文件<code>pname.md</code>和文件夹<code>pname</code>，后者用于存放md内引用的图片或代码文件。新建文件名的默认格式可通过修改<code>_config.yml</code>中的<code>new_post_name</code>来调整，例如</p>
<p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">new_post_name:</span> <span class="string">:year-:month-:day-:title.md</span> <span class="comment"># yyyy-mm-dd-pname</span></span><br></pre></td></tr></table></figure></p>
<p>此时按上面指令新建<code>pname</code>将得到<code>2018-02-21-pname.md</code>和文件夹<code>2018-02-21-pname</code>。如果文章本身未成型，想先写一个草稿，用</p>
<p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">hexo new draft dname</span><br></pre></td></tr></table></figure></p>
<p>会在<code>source/_draft</code>下创建<code>dname.md</code>文件和<code>dname</code>文件夹。草稿写作完成后可用命令</p>
<p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">hexo publish dname</span><br></pre></td></tr></table></figure></p>
<p>发布，此时Hexo会将<code>dname.md</code>和<code>dname</code>按照<code>new_post_name</code>的格式重命名后，移动到<code>source/_post</code>文件夹下，不需要自己手动改名。</p>
<h2>Hexo写作</h2>
<p>Hexo博客正文写作基于Markdown语法，网络上已经有非常多的教程和帮助文档，例如我现在在<a href="https://kapeli.com/dash" target="_blank" rel="noopener">Dash</a>中使用的<a href="http://daringfireball.net/projects/markdown/syntax#" target="_blank" rel="noopener">cheat sheet</a>。对于Hexo比较特别的是，为了识别博文的基本信息，我们需要一个front matter。另外，除了基本Markdown语法以外，我们还可以使用开源作者编写的Hexo渲染器及主题允许的各种特性，来丰富我们的写作手段。</p>
<h3>Front matter</h3>
<p>~~对任一篇Hexo博文，文件夹非必须，但一定会有对应的<code>.md</code>文件。~~Hexo要求博文的<code>.md</code>文件开头需要有一个YAML格式的front matter。根据该front matter，Hexo可识别博文的标题、创建日期、标签、分类等各种特征以及需要用到的渲染器。Front matter的基本格式为</p>
<p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">title:</span> <span class="string">pname</span>              <span class="comment"># 标题</span></span><br><span class="line"><span class="attr">date:</span> <span class="number">2018</span><span class="number">-02</span><span class="number">-21</span> <span class="number">16</span><span class="string">:58:25</span> <span class="comment"># 创建时间</span></span><br><span class="line"><span class="attr">tags:</span>                     <span class="comment"># 标签. 不止一个时写成[tag1, tag2]格式</span></span><br><span class="line"><span class="attr">categories:</span>               <span class="comment"># 分类</span></span><br><span class="line"><span class="meta">---</span></span><br></pre></td></tr></table></figure></p>
<p>利用<code>hexo new post</code>产生的博文，front matter会套用<code>scaffold</code>中的<code>post.md</code>，相当于post的初始化模板</p>
<p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">title:</span> <span class="string">&#123;&#123;</span> <span class="string">title</span> <span class="string">&#125;&#125;</span></span><br><span class="line"><span class="attr">date:</span> <span class="string">&#123;&#123;</span> <span class="string">date</span> <span class="string">&#125;&#125;</span></span><br><span class="line"><span class="attr">tags:</span></span><br><span class="line"><span class="meta">---</span></span><br></pre></td></tr></table></figure></p>
<p>可根据自己需要修改模板，如增加目录<code>toc</code>、归类<code>categories</code>以及首页图片<code>feature</code>。当存在与md文件名一致的文件夹时，md中图片和代码引用会在该文件夹中搜索，只需要把欲引用的图片代码放入文件夹，将引用路径设为文件名即可。</p>
<h3>基于MathJax的数学公式插入</h3>
<p>由于专业原因，可以预想到很多时候需要插入大量的公式，实现方法是使用浏览器公式引擎<a href="https://www.mathjax.org/" target="_blank" rel="noopener">MathJax</a>。推荐使用<a href="https://github.com/phoenixcw/hexo-renderer-mathjax" target="_blank" rel="noopener">hexo-renderer-mathjax</a>，安装很方便，对<code>_config.yml</code>的改动量也很小。通过npm安装</p>
<p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">npm install hexo-renderer-mathjax --save</span><br></pre></td></tr></table></figure></p>
<p>安装完就可以正常使用。如果出现无法渲染的情况，在<code>_config.yml</code>中加入:</p>
<p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">Plugins:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">hexo-renderer-mathjax</span></span><br></pre></td></tr></table></figure></p>
<p>输入行内公式可使用<code>$math$</code>，例如</p>
<p><figure class="highlight tex"><table><tr><td class="code"><pre><span class="line"><span class="formula">$P=iGG, G=<span class="tag">\<span class="name">frac</span><span class="string">&#123;1&#125;</span><span class="string">&#123;\omega - \hat&#123;H&#125;</span></span>_&#123;<span class="tag">\<span class="name">text</span><span class="string">&#123;KS&#125;</span></span>&#125;&#125;$</span></span><br></pre></td></tr></table></figure></p>
<p>效果：$P=iGG, G=\frac{1}{\omega - \hat{H}_{\text{KS}}}$</p>
<p>输入公式块可使用<code>$$mathblock$$</code>，例如</p>
<p><figure class="highlight tex"><table><tr><td class="code"><pre><span class="line"><span class="formula">$$ <span class="tag">\<span class="name">nabla</span></span>^2 <span class="tag">\<span class="name">phi</span> = </span>-<span class="tag">\<span class="name">rho</span></span> $$</span></span><br></pre></td></tr></table></figure></p>
<p>效果：</p>
<p>$$\nabla^2 \phi = -\rho$$</p>
<p>此外还可以使用<code>\begin{equation}\end{equation}</code>来产生带编号的公式，但需要对hexo-renderer-mathjax包的内容进行修改。将<code>node_modules/hexo-renderer-mathjax/mathjax.html</code>中间<code>MathJax.Hub.Config</code>函数改为</p>
<p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">MathJax.Hub.Config(&#123;</span><br><span class="line">    tex2jax: &#123;</span><br><span class="line">        inlineMath: [ [<span class="string">"$"</span>,<span class="string">"$"</span>], [<span class="string">"\\("</span>,<span class="string">"\\)"</span>] ],</span><br><span class="line">        skipTags: [<span class="string">'script'</span>, <span class="string">'noscript'</span>, <span class="string">'style'</span>, <span class="string">'textarea'</span>, <span class="string">'pre'</span>, <span class="string">'code'</span>],</span><br><span class="line">        processEscapes: <span class="literal">true</span></span><br><span class="line">    &#125;,</span><br><span class="line">    TeX: &#123;<span class="attr">equationNumbers</span>: &#123; <span class="attr">autoNumber</span>: <span class="string">"AMS"</span> &#125;&#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>即增加<code>TeX</code>一行(不要忘了前面的逗号<code>,</code>)。</p>
<p><figure class="highlight tex"><table><tr><td class="code"><pre><span class="line"><span class="formula">$$<span class="tag">\<span class="name">begin</span><span class="string">&#123;equation&#125;</span></span></span></span><br><span class="line"><span class="formula"><span class="tag">\<span class="name">begin</span><span class="string">&#123;aligned&#125;</span></span></span></span><br><span class="line"><span class="formula">a=b+&amp;c <span class="tag">\<span class="name">\</span></span></span></span><br><span class="line"><span class="formula">&amp;+e+f</span></span><br><span class="line"><span class="formula"><span class="tag">\<span class="name">end</span><span class="string">&#123;aligned&#125;</span></span></span></span><br><span class="line"><span class="formula"><span class="tag">\<span class="name">end</span><span class="string">&#123;equation&#125;</span></span><span class="tag">\<span class="name">label</span><span class="string">&#123;eq1&#125;</span></span>$$</span></span><br></pre></td></tr></table></figure></p>
<p>效果：
$$\begin{equation}
\begin{aligned}
a=b+&amp;c \
&amp;+e+f
\end{aligned}
\end{equation}\label{eq1}$$</p>
<p>还可以用<code>$\eqref{eq1}$</code>来引用公式$\eqref{eq1}$。上面equation例子还需要注意的是，默认的Markdown渲染器会将两个斜线<code>\\</code>渲染为<code>\</code>，从而导致无法转行。这里根据网络上的办法，修改<code>node_modules/marked/lib/marked.js</code>，将</p>
<p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="built_in">escape</span>: <span class="regexp">/^\\([\\`*&#123;&#125;\[\]()#+\-.!_&gt;])/</span>,</span><br></pre></td></tr></table></figure></p>
<p>改为</p>
<p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="built_in">escape</span>: <span class="regexp">/^\\([`*\[\]()# +\-.!_&gt;])/</span>,</span><br></pre></td></tr></table></figure></p>
<p>移除marked对花括号和反斜线的渲染。如果出现下划线渲染问题，再将<code>em:</code>一行从</p>
<p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">em: <span class="regexp">/^_([^\s_](?:[^_]|__)+?[^\s_])_\b|^\*((?:\*\*|[^*])+?)\*(?!\*)/</span></span><br></pre></td></tr></table></figure></p>
<p>改为</p>
<p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">em: <span class="regexp">/^\*((?:\*\*|[\s\S])+?)\*(?!\*)/</span>,</span><br></pre></td></tr></table></figure></p>
<p>以移除对下划线<code>_</code>的渲染. 看一下结果</p>
<table>
<thead>
<tr>
<th style="text-align:left">Markdown</th>
<th style="text-align:left">类型</th>
<th style="text-align:left">渲染结果</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left"><code>$a_b$</code></td>
<td style="text-align:left">公式</td>
<td style="text-align:left">$a_b$</td>
</tr>
<tr>
<td style="text-align:left"><code>$a^*$</code></td>
<td style="text-align:left">公式</td>
<td style="text-align:left">$a^*$</td>
</tr>
<tr>
<td style="text-align:left"><code>$a^* b^*$</code></td>
<td style="text-align:left">公式</td>
<td style="text-align:left">$a^<em>b^</em>$</td>
</tr>
<tr>
<td style="text-align:left"><code>$a^\ast b^\ast$</code></td>
<td style="text-align:left">公式</td>
<td style="text-align:left">$a^\ast b^\ast$</td>
</tr>
<tr>
<td style="text-align:left"><code>*em*</code></td>
<td style="text-align:left">强调文本</td>
<td style="text-align:left"><em>em</em></td>
</tr>
<tr>
<td style="text-align:left"><code>_em_</code></td>
<td style="text-align:left">强调文本</td>
<td style="text-align:left"><em>em</em></td>
</tr>
</tbody>
</table>
<p>可以看到, 当公式里同时出现两个星号时, 公式将无法正常渲染. 一种解决方案是用<code>\ast</code>代替<code>*</code>.</p>
<p>由于Mathjax的CDN<a href="https://www.mathjax.org/cdn-shutting-down/#alternative-cdn-providers" target="_blank" rel="noopener">在17年中退役</a>, 修改<code>mathjax.html</code>中CDN脚本一行</p>
<p><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span> <span class="attr">async</span> <span class="attr">src</span>=<span class="string">"https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<h3>链接自己博客内的文章</h3>
<p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">&#123;% post_link md-filename-wo-extension %&#125;</span><br></pre></td></tr></table></figure></p>
<p>如</p>
<p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">&#123;% post_link compile_VASP_on_macOS %&#125;</span><br></pre></td></tr></table></figure></p>
<p><a href="/2018/01/02/compile_VASP_on_macOS/" title="解决macOS上编译VASP时遇到的libparser.a未定义符号问题">解决macOS上编译VASP时遇到的libparser.a未定义符号问题</a></p>
<p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">&#123;% post_link f2py<span class="number">-1</span> %&#125;</span><br></pre></td></tr></table></figure></p>
<p><a href="/2018/05/15/f2py-1/" title="Python笔记(一)——利用F2PY调用Fortran函数或子程序">Python笔记(一)——利用F2PY调用Fortran函数或子程序</a></p>
<h3>图片说明</h3>
<p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">npm install --save hexo-image-caption</span><br></pre></td></tr></table></figure></p>
<p>在<code>_config.yml</code>中加入</p>
<p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">image_caption:</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">class_name:</span></span><br></pre></td></tr></table></figure></p>
<p>并按照这一条<a href="https://github.com/wayou/hexo-image-caption/pull/4/files" target="_blank" rel="noopener">PR</a>修改<code>node_modules/hexo-image-caption/index.js</code>.</p>
<h3>流程图</h3>
<p>安装<a href="https://github.com/bubkoo/hexo-filter-flowchart" target="_blank" rel="noopener">hexo-filter-flowchart</a></p>
<p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">npm install --save hexo-filter-flowchart</span><br></pre></td></tr></table></figure></p>
<p>直接使用即可. 具体语法参考<a href="https://flowchart.js.org/" target="_blank" rel="noopener">flowchart.js官网</a></p>
<p>&lt;div id=&quot;flowchart-0&quot; class=&quot;flow-chart&quot;&gt;&lt;/div&gt;</p>
<p>对于比较长的流程, 需要在<code>_config.yml</code>中</p>
<h2>Freemind特性</h2>
<h3>首页摘要</h3>
<p>在要作为摘要的文字后面加上<code>&lt;!--more--&gt;</code>，首页将只显示<code>&lt;!--more--&gt;</code>前面的内容，同时出现&quot;Read More&quot;的按钮。摘要内容仍然会在正文中显示。</p>
<h3>标签插件</h3>
<p>使用标签插件(Tag plugins)可以使得文章的可读性更好。在这里我参考了wxpan提供的<a href="https://github.com/PytLab/hexo-theme-freemind/blob/source/_posts/tag-plugins-cn.md" target="_blank" rel="noopener">样例</a>。~~总结一些tag plugins用法，包括一般Hexo和Bootstrap的tag plugins。~~在使用插件前，需要先安装<a href="https://github.com/wzpan/hexo-tag-bootstrap" target="_blank" rel="noopener">Bootstrap</a></p>
<p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">npm install hexo-tag-bootstrap --save</span><br></pre></td></tr></table></figure></p>
<h4>标签(label)</h4>
<p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">&#123;% label <span class="keyword">default</span> %&#125;</span><br><span class="line">&#123;% label warn warning %&#125;</span><br><span class="line">&#123;% label succ success %&#125;</span><br><span class="line">&#123;% label danger danger %&#125;</span><br><span class="line">&#123;% label prim primary %&#125;</span><br><span class="line">&#123;% label info info %&#125;</span><br></pre></td></tr></table></figure></p>
<p>效果是插入一个醒目的颜色小标签
<span class="label label-default">default</span> <span class="label label-warning">warn</span> <span class="label label-success">succ</span> <span class="label label-danger">danger</span> <span class="label label-primary">prim</span> <span class="label label-info">info</span></p>
<h4>警报(alert)</h4>
<p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">&#123;% alert warning %&#125; 这是一个警告类型的警报 &#123;% endalert %&#125;</span><br><span class="line">&#123;% alert danger %&#125; 这是一个危险类型的警报 &#123;% endalert %&#125;</span><br><span class="line">&#123;% alert success %&#125; 这是一个成功类型的警报 &#123;% endalert %&#125;</span><br><span class="line">&#123;% alert info %&#125; 这是一个信息类型的警报 &#123;% endalert %&#125;</span><br></pre></td></tr></table></figure></p>
<p>效果是插入一个带特定背景色的文字块，左上方含有标识文本性质的符号。</p>
<p><div class="alert alert-warning"><i class="fa fa-bell  float-left"></i>  <p>这是一个警告类型的警报</p>
</div>
<div class="alert alert-danger"><i class="fa fa-bug  float-left"></i>  <p>这是一个危险类型的警报</p>
</div>
<div class="alert alert-success"><i class="fa fa-lightbulb-o  float-left"></i>  <p>这是一个成功类型的警报</p>
</div>
<div class="alert alert-info"><i class="fa fa-info  float-left"></i>  <p>这是一个信息类型的警报</p>
</div></p>
<h4>徽章(badge)</h4>
<p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">&#123;% badge 徽章测试 %&#125;</span><br></pre></td></tr></table></figure></p>
<p>效果是<span class="badge badge-secondary">徽章测试</span></p>
<h2>Freemind调教</h2>
<p><div class="alert alert-warning"><i class="fa fa-bell  float-left"></i>  <p>若非特别指出，所有的关于Freemind的调教都是在<code>themes/freemind</code>文件夹内，不要与Hexo根目录混淆。</p>
</div></p>
<h3>网站图标</h3>
<p><s>Hexo会在根目录下<code>source/assets/images/favicon/</code>内寻找图片作为网站图标。另一种方法是在<code>_config.yml</code>内通过编辑<code>favicon</code>标签显示指定</s></p>
<p>网站图标设定功能在<code>layout/_partial/head.ejs</code>中定义</p>
<p><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">%</span> <span class="attr">if</span> (<span class="attr">theme.favicon</span>)&#123; %&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">href</span>=<span class="string">"&lt;%- config.root %&gt;assets/images/favicon/icon.png"</span> <span class="attr">rel</span>=<span class="string">"icon"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">%</span> &#125; %&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>在<code>_config.yml</code>中设置</p>
<p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">favicon:</span> <span class="literal">True</span></span><br></pre></td></tr></table></figure></p>
<p>然后将命名为<code>icon.png</code>的网站图标图片放入Hexo根目录下的<code>source/assets/images/favicon</code>下即可。也可以修改<code>href</code>属性，换成自己想要的路径。</p>
<h3>Wiki型浮窗式的脚注</h3>
<p>用<code>npm</code>安装<a href="https://github.com/kchen0x/hexo-reference" target="_blank" rel="noopener">hexo-reference</a></p>
<p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">npm install hexo-refernce --save</span><br></pre></td></tr></table></figure></p>
<p>在Hexo根目录<code>_config.yml</code>中启用插件</p>
<p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">Plugins:</span></span><br><span class="line">  <span class="string">hexo-reference</span></span><br></pre></td></tr></table></figure></p>
<p>为了跟网页主体风格相一致, 稍微修改了一下其中的源码(<code>hint.min.css</code>)以调整浮窗文字的背景颜色, 置于主题CSS文件夹下</p>
<p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sed <span class="string">'s/b34e4d/1863a1/g'</span> node_modules/hexo-reference/src/hint.min.css &gt; themes/freemind/<span class="built_in">source</span>/css/hint.min.css</span><br></pre></td></tr></table></figure></p>
<p>同时修改<code>index.js</code>, 将<code>href</code>的CDN地址改为本地地址</p>
<p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cd</span> node_modules/hexo-reference/</span><br><span class="line">mv index.js index.js_bak <span class="comment"># back up original file</span></span><br><span class="line">sed <span class="string">'s/https:\/\/cdn.jsdelivr.net\/hint.css\/2.4.1\//\/css\//g'</span> index.js_bak &gt; index.js</span><br></pre></td></tr></table></figure></p>
<p>测试一下效果.&lt;sup id=&quot;fnref:1&quot;&gt;&lt;a href=&quot;#fn:1&quot; rel=&quot;footnote&quot;&gt;&lt;span class=&quot;hint--top hint--error hint--medium hint--rounded hint--bounce&quot; aria-label=&quot;这是一个脚注测试&quot;&gt;[1]&lt;/span&gt;&lt;/a&gt;&lt;/sup&gt;</p>
<h3>在首页摘要中移除alert效果</h3>
<p>在<code>&lt;!--more--&gt;</code>前使用Bootstrap的alert对象时, 首页摘要显示也会出现的alert的效果. 这可以通过修改hexo库中的excerpt.js来移除alert的div标签来实现.</p>
<p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 位置在node_modules/hexo/lib/plugins/filter/after_post_render/excerpt.js</span></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="comment">//data.excerpt = content.substring(0, index).trim(); //修改前</span></span><br><span class="line">data.excerpt = content.substring(<span class="number">0</span>, index).replace(</span><br><span class="line">     /&lt;div class="alert alert-\w+"&gt;&lt;i class="fa [\w\s-]+"&gt;&lt;\/i&gt;([\S\s]+)\s&lt;\/div&gt;/g, "$1").trim();</span><br></pre></td></tr></table></figure></p>
<h3>边栏链接及链接图标</h3>
<p>在<code>_config.yml</code>内编辑<code>links</code>标签，每一条短线对应一个链接条目</p>
<p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">links:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">title:</span> <span class="string">"Github-minyez"</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">https://github.com/minyez</span></span><br><span class="line">    <span class="attr">icon:</span> <span class="string">"fa fa-github"</span></span><br></pre></td></tr></table></figure></p>
<p>其中<code>icon</code>对应链接旁显示的图标。本示例使用了<a href="https://fontawesome.com" target="_blank" rel="noopener">Font Awesome</a>提供的图标，该项目提供的全部图标可以在<a href="https://fontawesome.com/icons?d=gallery" target="_blank" rel="noopener">这里</a>找到。</p>
<h3>谷歌统计GA</h3>
<p>使用谷歌账号登录<a href="https://analytics.google.com/analytics/web/#/" target="_blank" rel="noopener">谷歌统计</a>, 在管理标签中找到用户管理。在媒体资源设置中找到自己的跟踪ID，并设置默认跟踪网址, 然后在跟踪信息-跟踪代码中，将全局网站代码粘贴到<code>layout/_partial/after_foot.ejs</code>底部, 并把明文的GA ID改成<code>&lt;%= theme.google_analytics.siteid %&gt;</code>.</p>
<p><figure class="null"><img src="follow-code-GA.png" alt="跟踪代码块截图"><figcaption>跟踪代码块截图</figcaption></figure></p>
<p>在GA主页上, 可以通过&quot;管理-过滤器-添加过滤条件&quot;来排除来自特定IP的流量. GA通过浏览器工作, 而<a href="https://www.en.advertisercommunity.com/t5/Google-Analytics-Filters/Employee-Mobile-Phone-MAC-Address-exclusions/td-p/853289#.XNEMq8OoASk.google" target="_blank" rel="noopener">浏览器不会读取MAC地址</a>, 因此无法通过检测MAC地址的方式排除特定设备的流量.</p>
<h3>不蒜子站点和页面统计</h3>
<p>将<a href="http://busuanzi.ibruce.info/" target="_blank" rel="noopener">不蒜子</a>整合到Freemind中, 以支持站点访客数统计和页面访问量统计. (GA也可以完成, 但没精力读API了...) 在<code>_config.yml</code>中加入</p>
<p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">busuanzi:</span></span><br><span class="line"><span class="comment"># number of page views from busuanzi</span></span><br><span class="line">  <span class="attr">pageview:</span> <span class="literal">true</span></span><br><span class="line"><span class="comment"># number of total visitors from busuanzi</span></span><br><span class="line">  <span class="attr">visitor:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure></p>
<p>以提供一致的开关. 在<code>layout/_partial/post/analytics.ejs</code>中引入js</p>
<p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">&lt;% <span class="keyword">if</span> (theme.busuanzi.pageview || theme.busuanzi.visitor)&#123; %&gt;</span><br><span class="line">&lt;script <span class="keyword">async</span> src=<span class="string">"//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"</span>&gt;</span><br><span class="line">&lt;<span class="regexp">/script&gt;</span></span><br><span class="line"><span class="regexp">&lt;% &#125; %&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>然后在<code>layout/_partial/footer.ejs</code>中加入总访客数标记</p>
<p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">&lt;% <span class="keyword">if</span> (theme.busuanzi.visitor) &#123; %&gt;</span><br><span class="line">   | <span class="xml"><span class="tag">&lt;<span class="name">span</span> <span class="attr">id</span>=<span class="string">"busuanzi_container_site_uv"</span>&gt;</span><span class="tag">&lt;<span class="name">span</span> <span class="attr">id</span>=<span class="string">"busuanzi_value_site_uv"</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span> visitors<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span></span><br><span class="line">&lt;% &#125; %&gt;</span><br></pre></td></tr></table></figure></p>
<p>在<code>layout/_partial/post/meta.ejs</code>中加入页面总访问数</p>
<p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">&lt;!-- page view by busuanzi --&gt;</span><br><span class="line">&lt;% <span class="keyword">if</span> (theme.busuanzi.pageview) &#123; %&gt;</span><br><span class="line">&lt;div <span class="class"><span class="keyword">class</span></span>=<span class="string">"meta-widget"</span>&gt;</span><br><span class="line">&lt;span id=<span class="string">"busuanzi_container_page_pv"</span>&gt;</span><br><span class="line">&lt;i <span class="class"><span class="keyword">class</span></span>=<span class="string">"fa fa-eye"</span>&gt;&lt;<span class="regexp">/i&gt;</span></span><br><span class="line"><span class="regexp">&lt;span id="busuanzi_value_page_pv"&gt;&lt;/</span>span&gt; views</span><br><span class="line">&lt;<span class="regexp">/span&gt;</span></span><br><span class="line"><span class="regexp">&lt;/</span>div&gt;</span><br><span class="line">&lt;% &#125; %&gt;</span><br></pre></td></tr></table></figure></p>
<p>页面每被点击一次, 总访问数就加一.</p>
<h3>全站字数统计</h3>
<p>使用<a href="https://github.com/willin/hexo-wordcount" target="_blank" rel="noopener">hexo-wordcount</a>. 类似不蒜子, 在<code>layout/_partial/footer.ejs</code>加入</p>
<p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">&lt;% <span class="keyword">if</span> (theme.wordcount.site) &#123; %&gt;</span><br><span class="line">  | <span class="xml"><span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"post-count"</span>&gt;</span><span class="tag">&lt;<span class="name">%=</span> <span class="attr">totalcount</span>(<span class="attr">site</span>) %&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span> words</span><br><span class="line">&lt;% &#125; %&gt;</span><br></pre></td></tr></table></figure></p>
<p>在YAML中开启</p>
<p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">wordcount:</span></span><br><span class="line">  <span class="attr">site:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure></p>
<h3>修改页尾标记</h3>
<p>在<code>layout/_partial/footer.ejs</code>中修改.</p>
<h3>配色修改</h3>
<p>由于个人偏好蓝色和深绿色，需要简单修改一下博文大小标题和行间代码的配色。在<code>source/css/highlight.css</code>中修改行间代码的CSS样式</p>
<p><figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-tag">code</span> &#123;</span><br><span class="line">    <span class="attribute">background</span>: <span class="number">#eee</span>;</span><br><span class="line">    <span class="attribute">border</span>: <span class="number">1px</span> solid <span class="number">#d6d6d6</span>;</span><br><span class="line">    <span class="attribute">padding</span>: <span class="number">0</span> <span class="number">5px</span>;</span><br><span class="line">    <span class="attribute">margin</span>: <span class="number">0</span> <span class="number">2px</span>;</span><br><span class="line">    <span class="attribute">font-size</span>: <span class="number">90%</span>;</span><br><span class="line">    <span class="comment">/*text-shadow: 0 1px #fff; */</span> <span class="comment">/*删去白色阴影*/</span></span><br><span class="line">    <span class="attribute">word-break</span>: break-all;</span><br><span class="line">    <span class="attribute">word-wrap</span>: break-word;</span><br><span class="line">    <span class="attribute">white-space</span>: normal;</span><br><span class="line">    <span class="attribute">color</span>: <span class="number">#458B00</span>; <span class="comment">/* 翠绿 */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>在<code>source/css/style.css</code>中修改文章中大小标题的样式</p>
<p><figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-tag">h2</span>&#123;</span><br><span class="line">    <span class="attribute">margin</span>: <span class="number">0.83em</span> <span class="number">0</span>;</span><br><span class="line">    <span class="attribute">color</span>: <span class="number">#104E8B</span>; <span class="comment">/* 二级标题藏青 */</span></span><br><span class="line">  <span class="comment">/*  color: green; */</span></span><br><span class="line">    <span class="attribute">padding-top</span>: <span class="number">40px</span>;</span><br><span class="line">    <span class="attribute">margin-top</span>: -<span class="number">25px</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">h3</span> &#123;</span><br><span class="line">  <span class="comment">/*  color: #9C4C17; */</span></span><br><span class="line">    <span class="attribute">color</span>: <span class="number">#1E90FF</span>; <span class="comment">/* 三级标题湖蓝 */</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">h4</span> &#123;</span><br><span class="line">  <span class="comment">/*  color: #B94A48; */</span></span><br><span class="line">    <span class="attribute">color</span>: <span class="number">#CC0033</span>; <span class="comment">/* 四级标题红色以防标题层级过低看不到 */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3>文字两端对齐</h3>
<p>在<code>source/css/style.css</code>中加入</p>
<p><figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-tag">p</span> &#123;</span><br><span class="line">    <span class="attribute">text-align</span>: justify</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3>DISQUS评论</h3>
<p>注册<a href="https://disqus.com/" target="_blank" rel="noopener">DISQUS</a>账号，选择&quot;I want to install disqus on my site&quot;，使用universal code安装，将这部分代码拷贝到<code>layout/_partial/post/comment.ejs</code>中。接下来配置Disqus，主要是<code>Website Name</code>和<code>Website URL</code>，前者我设置为我的shigaro。然后在Hexo根目录<code>_config.yml</code>下加入</p>
<p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># comment</span></span><br><span class="line"><span class="attr">disqus_shortname:</span> <span class="string">shigaro</span></span><br></pre></td></tr></table></figure></p>
<h3>三线表</h3>
<p>在<code>source/css/style.css</code>中加入</p>
<p><figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* 居中三线表 */</span></span><br><span class="line"><span class="selector-pseudo">:not(figure)</span>&gt;<span class="selector-tag">table</span> &#123;</span><br><span class="line">  <span class="attribute">border-top</span>: <span class="number">2px</span> solid <span class="number">#4088b8</span>;</span><br><span class="line">  <span class="attribute">border-bottom</span>: <span class="number">2px</span> solid <span class="number">#4088b8</span>;</span><br><span class="line">  <span class="attribute">margin</span>: <span class="number">1.5em</span> auto <span class="number">1.5em</span> auto;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">th</span> &#123;</span><br><span class="line">  <span class="attribute">padding</span>: <span class="number">12px</span> <span class="number">10px</span> <span class="number">12px</span> <span class="number">10px</span>;</span><br><span class="line">  <span class="attribute">border-bottom</span>: <span class="number">2px</span> solid <span class="number">#4088b8</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 非代码块table元素, 悬停表格主体行时灰色高量 */</span></span><br><span class="line"><span class="selector-pseudo">:not(figure)</span>&gt;<span class="selector-tag">table</span>&gt;<span class="selector-tag">tbody</span>&gt;<span class="selector-tag">tr</span><span class="selector-pseudo">:hover</span> &#123;</span><br><span class="line">  <span class="attribute">background-color</span>: <span class="number">#D9D9D9</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3>背景图片</h3>
<p>在<code>layout/layout.ejs</code>中, 修改body标签, 增加一段ejs</p>
<p><figure class="highlight"><table><tr><td class="code"><pre><span class="line">&lt;body &lt;%- partial('_partial/background') %&gt;&gt;</span><br></pre></td></tr></table></figure></p>
<p>新建<code>layout/_partial/background.ejs</code></p>
<p><figure class="highlight css"><table><tr><td class="code"><pre><span class="line">&lt;% if(theme.background) &#123; %&gt;</span><br><span class="line">style="background:url(&lt;%- config.root %&gt;assets/images/&lt;%- theme.background %&gt;);" class="body-img-background"</span><br><span class="line">&lt;% &#125; %&gt;</span><br></pre></td></tr></table></figure></p>
<p><code>body-img-background</code>类的样式由<code>source/css/style.css</code>控制</p>
<p><figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* fixed image background by minyez*/</span></span><br><span class="line"><span class="selector-tag">body</span><span class="selector-class">.body-img-background</span> &#123;</span><br><span class="line">  <span class="attribute">background-repeat</span>: no-repeat;</span><br><span class="line">  <span class="attribute">background-attachment</span>: fixed;</span><br><span class="line">  <span class="attribute">background-position</span>:<span class="number">50%</span> <span class="number">50%</span>;</span><br><span class="line">  <span class="attribute">background-size</span>: cover;</span><br><span class="line">  <span class="attribute">-webkit-background-size</span>: cover;</span><br><span class="line">  <span class="attribute">-o-background-size</span>: cover;</span><br><span class="line">  <span class="attribute">-moz-background-size</span>: cover;</span><br><span class="line">  <span class="attribute">-ms-background-size</span>: cover;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>然后在<code>_config.yml</code>中加入</p>
<p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">background:</span> <span class="string">background.png</span></span><br></pre></td></tr></table></figure></p>
<p>再把想作为背景的图片background.png放到Hexo根目录<code>source/assets/images/</code>下面就可以了. 目前样式参考了<a href="https://vonsdite.cn/posts/c08e78b.html" target="_blank" rel="noopener">这条链接</a>.</p>
<h3>TODO</h3>
<ul>
<li>[x] Bugfix: 点击<code>Software</code>的category徽章后显示的文章不全. 启用根目录下<code>category_generator</code>并将<code>per_page</code>设为0即可解决.</li>
<li>[ ] 代码块复制功能.</li>
<li>[ ] Quotes页面, 存储一些摘句, 同时有一个即时搜索引擎.</li>
<li>[ ] 文章中侧边栏随正文一同滚动. 对于TOC较长的情形, 鼠标移动到侧边栏上对TOC滚动浏览.</li>
</ul>
<h2>总结</h2>
<p>笔者基于Hexo框架和Freemind主题搭建了个人博客，根据自己的需求进行了自定义，并利用MathJax渲染器和Bootstrap特性进行了Markdown写作。</p>
<h2>参考</h2>
<p><a href="https://jdhao.github.io/2018/01/25/hexo-mathjax-equation-number/" target="_blank" rel="noopener">LaTeX Equation Numbering Done Right in Hexo</a></p>
<p>另一个渲染器hexo-math及一个讨论其用法的<a href="https://github.com/hexojs/hexo-math/issues/26" target="_blank" rel="noopener">Issue</a></p>
<p>如何在自己的主题下实现MathJax支持：<a href="https://www.cnblogs.com/wangxin37/p/8185688.html" target="_blank" rel="noopener">在Hexo中渲染MathJax数学公式</a></p>
<p>代码块复制：<a href="https://www.ofind.cn/blog/HEXO/HEXO%E4%BC%98%E5%8C%96%E4%B9%8B%EF%BC%88%E4%BA%8C%EF%BC%89-%E6%B7%BB%E5%8A%A0%E5%A4%8D%E5%88%B6%E5%8A%9F%E8%83%BD.html" target="_blank" rel="noopener">HEXO优化之（二）----添加复制功能</a></p>
<p><a href="https://vonsdite.cn/posts/c08e78b.html" target="_blank" rel="noopener">Hexo 添加背景图片并自适应</a></p>
<h2>更新</h2>
<h3>2019-05-07</h3>
<p>增加基于<code>hexo-reference</code>的wiki浮窗式的脚注. MathJax: 比较各种情况下<code>*</code>和<code>_</code>的渲染结果. 更改CDN.</p>
<h3>2019-05-10</h3>
<p>增加对不蒜子统计的支持. 去掉了Archives不必要的下拉菜单, 直接进入<code>archives</code>页面.</p>
<h3>2019-05-22</h3>
<p>增加背景图片, 位置由YAML中<code>background</code>变量指定.</p>
<h3>2019-05-25</h3>
<p>利用<code>hexo-wordcount</code>进行全站和页面字数统计.</p>
<h3>2020-06-30</h3>
<p>首页摘要中移除alert效果.
&lt;script src=&quot;https://cdnjs.cloudflare.com/ajax/libs/raphael/2.2.7/raphael.min.js&quot;&gt;&lt;/script&gt;&lt;script src=&quot;https://cdnjs.cloudflare.com/ajax/libs/flowchart/1.6.5/flowchart.min.js&quot;&gt;&lt;/script&gt;<textarea id="flowchart-0-code" style="display: none">st=>start: Start
op=>operation: Your Operation
cond=>condition: Yes or No?
e=>end

st->op->cond
cond(yes)->e
cond(no)->op</textarea><textarea id="flowchart-0-options" style="display: none">{"scale":1,"line-width":3,"line-length":25,"text-margin":10,"font-size":12}</textarea><script>  var code = document.getElementById("flowchart-0-code").value;  var options = JSON.parse(decodeURIComponent(document.getElementById("flowchart-0-options").value));  var diagram = flowchart.parse(code);  diagram.drawSVG("flowchart-0", options);</script>&lt;div id=&quot;footnotes&quot;&gt;&lt;hr&gt;&lt;div id=&quot;footnotelist&quot;&gt;&lt;ol style=&quot;list-style: none; padding-left: 0; margin-left: 40px&quot;&gt;&lt;li id=&quot;fn:1&quot;&gt;&lt;span style=&quot;display: inline-block; vertical-align: top; padding-right: 10px; margin-left: -40px&quot;&gt;1.&lt;/span&gt;&lt;span style=&quot;display: inline-block; vertical-align: top; margin-left: 10px;&quot;&gt;这是一个脚注测试&lt;a href=&quot;#fnref:1&quot; rev=&quot;footnote&quot;&gt; ↩&lt;/a&gt;&lt;/span&gt;&lt;/li&gt;&lt;/ol&gt;&lt;/div&gt;&lt;/div&gt;</p>

	
	</div>
  <!-- categories -->
  <span style="font-size:90%">
  
  <i style="color:#bbb" class="fa fa-folder"></i> <a style="color:#bbb" href="/categories/Software/">Software</a>
  </span>
  &nbsp
  <!-- tags -->
  <span style="font-size:90%" >
  
  <a style="color:#bbb" href="/tags/Hexo/">#Hexo</a>&nbsp&nbsp<a style="color:#bbb" href="/tags/Freemind/">#Freemind</a>
  </span>
  <!-- read more button -->
  <a type="button" href="/2018/02/15/Hexo-1/#more" class="pull-right btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->	
		<h3 class="title">
			<div class="date"> 2018-01-02 </div>
			<div class="article-title"><a href="/2018/01/02/compile_VASP_on_macOS/" >解决macOS上编译VASP时遇到的libparser.a未定义符号问题</a></div>						
		</h3>
	


			<div class="entry">
  <div class="row">
	
	
		<link rel="stylesheet" type="text/css" href="/css/hint.min.css"><p><div class="alert alert-success"><i class="fa fa-lightbulb-o  float-left"></i>  <p>介绍了笔者在macOS High Sierra上编译VASP.5.4.4时解决libparser.a中undefined symbols的问题.</p>
</div>
&lt;!-- more --&gt;</p>
<h2>背景</h2>
<p>购买mac后，我希望能在macOS运行常用的科学计算程序，方便我做小规模测试，其中之一是<a href="https://www.vasp.at/" target="_blank" rel="noopener">VASP</a>。系统环境为macOS High Sierra 10.13，编译VASP时编译环境为</p>
<ul>
<li>Intel Parallel Composer XE 2018.0.1</li>
<li>Intel ifort和icc编译的MPICH3</li>
<li>Intel ifort和icc编译的FFTW3 (MPICH3并行)</li>
<li>Intel ifort和icc编译的ScaLAPACK和BLACS (MPICH3并行)</li>
</ul>
<p>我的目标是编译5.4.1和VASP.5.4.4两个版本并成功用于Silicon的算例. VASP.5.4.1的编译很容易就通过了并能够正常地跑Silicon的例子, 但VASP.5.4.4始终无法编译通过，主要问题是在用C++编译parser库时无法链接到部分symbol上。</p>
<h2>问题细节</h2>
<p>VASP编译过程用到的<code>makefile.include</code>文件如下所示。5.4.4版同5.4.1版include文件的主要区别，除了最后的GPU部分外，还有一个用C++编译<code>libparser.a</code>的选项，即<code>CXX_PARS</code>。</p>
<p><figure class="highlight makefile"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Precompiler options</span></span><br><span class="line">CPP_OPTIONS = -DHOST=<span class="string">"LinuxIFC"</span> \</span><br><span class="line">              -DMPI -DMPI_BLOCK=8000 \</span><br><span class="line">              -Duse_collective \</span><br><span class="line">              -DscaLAPACK \</span><br><span class="line">              -DCACHE_SIZE=4000 \</span><br><span class="line">              -Davoidalloc \</span><br><span class="line">              -Duse_bse_te \</span><br><span class="line">              -Dtbdyn \</span><br><span class="line">              -Duse_shmem</span><br><span class="line">CPP        = fpp -f_com=no -free -w0  <span class="variable">$*</span><span class="variable">$(FUFFIX)</span> <span class="variable">$*</span><span class="variable">$(SUFFIX)</span> <span class="variable">$(CPP_OPTIONS)</span></span><br><span class="line">FC         = mpifort</span><br><span class="line">FCL        = mpifort <span class="comment">#-mkl=sequential -lstdc++</span></span><br><span class="line">FREE       = -free -names lowercase</span><br><span class="line">FFLAGS     = -assume byterecl -w</span><br><span class="line">OFLAG      = -O2</span><br><span class="line">OFLAG_IN   = <span class="variable">$(OFLAG)</span></span><br><span class="line">DEBUG      = -O0</span><br><span class="line">MKL_PATH   = <span class="variable">$(MKLROOT)</span>/lib/</span><br><span class="line">BLAS       =</span><br><span class="line">LAPACK     = <span class="variable">$(MKLROOT)</span>/lib/libmkl_intel_lp64.a <span class="variable">$(MKLROOT)</span>/lib/libmkl_sequential.a <span class="variable">$(MKLROOT)</span>/lib/libmkl_core.a -lpthread -lm -ldl</span><br><span class="line">BLACS      =</span><br><span class="line">SCALAPACK  = /Users/stevezhang/software/mathlib/scalapack/2.0.2/intel/18.0.1/libscalapack.a</span><br><span class="line"></span><br><span class="line">OBJECTS    = fftmpiw.o fftmpi_map.o fft3dlib.o fftw3d.o <span class="variable">$(HOME)</span>/lib/libfftw3xf_intel.a</span><br><span class="line"></span><br><span class="line">INCS       = -m64 -I<span class="variable">$(MKLROOT)</span>/<span class="keyword">include</span>/fftw -I<span class="variable">$(MKLROOT)</span>/<span class="keyword">include</span>/</span><br><span class="line"></span><br><span class="line">LLIBS      = <span class="variable">$(SCALAPACK)</span> <span class="variable">$(LAPACK)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">OBJECTS_O1 += fftw3d.o fftmpi.o fftmpiw.o</span><br><span class="line">OBJECTS_O2 += fft3dlib.o</span><br><span class="line"></span><br><span class="line"><span class="comment"># For what used to be vasp.5.lib</span></span><br><span class="line">CPP_LIB    = <span class="variable">$(CPP)</span></span><br><span class="line">FC_LIB     = <span class="variable">$(FC)</span></span><br><span class="line">CC_LIB     = icc</span><br><span class="line">CFLAGS_LIB = -O</span><br><span class="line">FFLAGS_LIB = -O1</span><br><span class="line">FREE_LIB   = <span class="variable">$(FREE)</span></span><br><span class="line"></span><br><span class="line">OBJECTS_LIB= linpack_double.o getshmem.o</span><br><span class="line"></span><br><span class="line"><span class="comment"># For the parser library</span></span><br><span class="line">CXX_PARS   = icpc</span><br><span class="line"></span><br><span class="line">LIBS       += parser</span><br><span class="line">LLIBS      += -Lparser -lparser -lstdc++</span><br><span class="line"></span><br><span class="line"><span class="comment"># Normally no need to change this</span></span><br><span class="line">SRCDIR     = ../../src</span><br><span class="line">BINDIR     = ../../bin</span><br><span class="line"></span><br><span class="line"><span class="comment">### GPU stuff below</span></span><br></pre></td></tr></table></figure></p>
<p>输入命令</p>
<p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">make std</span><br></pre></td></tr></table></figure></p>
<p>在最后链接产生<code>vasp</code>前报错, 提示libparser.a中大量Undefined symbols,</p>
<p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Undefined symbols for architecture x86_64:</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line">ld: symbol(s) not found for architecture x86_64</span><br><span class="line">make[2]: *** [vasp] Error 1</span><br><span class="line">cp: vasp: No such file or directory</span><br><span class="line">make[1]: *** [all] Error 1</span><br><span class="line">make: *** [std] Error 2</span><br></pre></td></tr></table></figure></p>
<p><code>Undefined symbols for architecture x86_64</code>表示在x86_64架构下符号未被定义, 具体错误信息在<a href="libparser_undefined_sym.error">这里</a>, 总结起来未定义的符号包括</p>
<p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">__ZNKSt3__112basic_stringIcNS_11char_traitsIcEENS_9allocatorIcEEE7compareEmmPKcm</span><br><span class="line">__ZNKSt3__120__vector_base_commonILb1EE20__throw_length_errorEv</span><br><span class="line">__ZNKSt3__16locale9use_facetERNS0_2idE</span><br><span class="line">__ZNKSt3__18ios_base6getlocEv</span><br><span class="line">__ZNSt11logic_errorC2EPKc</span><br><span class="line">__ZNSt3__112basic_stringIcNS_11char_traitsIcEENS_9allocatorIcEEE6__initEPKcm</span><br><span class="line">__ZNSt3__112basic_stringIcNS_11char_traitsIcEENS_9allocatorIcEEE6__initEmc</span><br><span class="line">__ZNSt3__112basic_stringIcNS_11char_traitsIcEENS_9allocatorIcEEE6appendEPKcm</span><br><span class="line">__ZNSt3__112basic_stringIcNS_11char_traitsIcEENS_9allocatorIcEEE9push_backEc</span><br><span class="line">__ZNSt3__112basic_stringIcNS_11char_traitsIcEENS_9allocatorIcEEED1Ev</span><br><span class="line">__ZNSt3__113basic_ostreamIcNS_11char_traitsIcEEE3putEc</span><br><span class="line">__ZNSt3__113basic_ostreamIcNS_11char_traitsIcEEE5flushEv</span><br><span class="line">__ZNSt3__113basic_ostreamIcNS_11char_traitsIcEEE6sentryC1ERS3_</span><br><span class="line">__ZNSt3__113basic_ostreamIcNS_11char_traitsIcEEE6sentryD1Ev</span><br><span class="line">__ZNSt3__113basic_ostreamIcNS_11char_traitsIcEEElsEd</span><br><span class="line">__ZNSt3__113basic_ostreamIcNS_11char_traitsIcEEElsEf</span><br><span class="line">__ZNSt3__113basic_ostreamIcNS_11char_traitsIcEEElsEi</span><br><span class="line">__ZNSt3__14coutE</span><br><span class="line">__ZNSt3__15ctypeIcE2idE</span><br><span class="line">__ZNSt3__16localeD1Ev</span><br><span class="line">__ZNSt3__18ios_base33__set_badbit_and_consider_rethrowEv</span><br><span class="line">__ZNSt3__18ios_base5clearEj</span><br></pre></td></tr></table></figure></p>
<h2>解决过程</h2>
<p>首先在<code>makefile.include</code>里面的<code>CXX_PARS</code>后面加上Homebrew安装的GCC库和<code>-lstdc++</code>，即</p>
<p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">-L/usr/local/Cellar/gcc/7.2.0/lib/gcc/7 -lstdc++</span><br></pre></td></tr></table></figure></p>
<p>这样子可以正常编译通过。但是跑VASP时会出现错误</p>
<p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"> running on    1 total cores</span><br><span class="line"> distrk:  each k-point on    1 cores,    1 groups</span><br><span class="line"> distr:  one band on    1 cores,    1 groups</span><br><span class="line"> using from now: INCAR</span><br><span class="line"> vasp.5.4.4.18Apr17-6-g9f103f2a35 (build Jan 09 2018 16:27:40) complex</span><br><span class="line"></span><br><span class="line"> POSCAR found type information on POSCAR  Si</span><br><span class="line"> POSCAR found :  1 types and       2 ions</span><br><span class="line"> scaLAPACK will be used</span><br><span class="line">dyld: lazy symbol binding failed: Symbol not found: __ZNSt7__cxx1112basic_stringIcSt11char_traitsIcESaIcEEC1Ev</span><br><span class="line">  Referenced from: /Users/stevezhang/software/sci/vasp/vasp.5.4.4-intel-2018.0.1/common/build/std/vasp</span><br><span class="line">  Expected in: flat namespace</span><br><span class="line"></span><br><span class="line">dyld: Symbol not found: __ZNSt7__cxx1112basic_stringIcSt11char_traitsIcESaIcEEC1Ev</span><br><span class="line">  Referenced from: /Users/stevezhang/software/sci/vasp/vasp.5.4.4-intel-2018.0.1/common/build/std/vasp</span><br><span class="line">  Expected in: flat namespace</span><br><span class="line"></span><br><span class="line">forrtl: error (76): Abort trap signal</span><br><span class="line">Image              PC                Routine            Line        Source</span><br><span class="line">vasp               0000000103C7ABFA  for__signal_handl     Unknown  Unknown</span><br><span class="line">libsystem_platfor  00007FFF6C6DEF5A  _sigtramp             Unknown  Unknown</span><br><span class="line">fish: &apos;vasp&apos; terminated by signal SIGABRT (Abort)</span><br></pre></td></tr></table></figure></p>
<p>主要错误是<code>dyld</code>没有找到symbol。用<code>nm</code>命令检查<code>libstdc++.a</code>和<code>libstdc++.dylib</code>，可以看到<code>__ZNSt7__cxx1112basic_stringIcSt11char_traitsIcESaIcEEC1Ev</code>都是有定义的，但始终链接不上去。考虑<code>dyld</code>的搜索路径<code>DYLD_LD_LIBRARY</code>。将<code>/usr/local/Cellar/gcc/7.2.0/lib/gcc/7</code>添加到环境变量<code>DYLD_LD_LIBRARY</code>中后重新编译<code>libparser.a</code>，再编译<code>vasp</code>就能成功运行。</p>
<p>最后5.4.4编译成功时的环境变量</p>
<p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> <span class="variable">$DYLD_LIBRARY_PATH</span></span><br><span class="line">/usr/<span class="built_in">local</span>/Cellar/gcc/7.2.0/lib/gcc/7:/usr/<span class="built_in">local</span>/Cellar/gcc/7.2.0/lib/gcc/7/gcc/x86_64-apple-darwin17.0.0/7.2.0/:/Users/stevezhang/software/compiler/mpich/3.2.1/intel/18.0.1/lib:/opt/intel/compilers_and_libraries_2018.1.126/mac/compiler/lib:/opt/intel/compilers_and_libraries_2018.1.126/mac/compiler/lib/intel64:/opt/intel/compilers_and_libraries_2018.1.126/mac/ipp/lib:/opt/intel/compilers_and_libraries_2018.1.126/mac/compiler/lib:/opt/intel/compilers_and_libraries_2018.1.126/mac/mkl/lib:/opt/intel/compilers_and_libraries_2018.1.126/mac/tbb/lib:/opt/intel/compilers_and_libraries_2018.1.126/mac/tbb/lib:/opt/intel/compilers_and_libraries_2018.1.126/mac/daal/lib:/opt/intel/compilers_and_libraries_2018.1.126/mac/daal/../tbb/lib:/usr/<span class="built_in">local</span>/opt/tcl-tk/lib:/usr/<span class="built_in">local</span>/lib:/usr/lib:</span><br><span class="line">$ <span class="built_in">echo</span> <span class="variable">$LIBRARY_PATH</span></span><br><span class="line">... <span class="comment"># 和DYLD一样</span></span><br><span class="line">$ <span class="built_in">echo</span> <span class="variable">$LD_LIBRARY_PATH</span></span><br><span class="line">/usr/<span class="built_in">local</span>/Cellar/gcc/7.2.0/lib/gcc/7:/usr/<span class="built_in">local</span>/Cellar/gcc/7.2.0/lib/gcc/7/gcc/x86_64-apple-darwin17.0.0/7.2.0/:/Users/stevezhang/software/mathlib/scalapack/2.0.2/intel/18.0.1/:/Users/stevezhang/software/mathlib/fftw/3.3.7/intel/18.0.1/lib:/Users/stevezhang/software/compiler/mpich/3.2.1/intel/18.0.1/lib:/usr/<span class="built_in">local</span>/opt/tcl-tk/lib:/usr/<span class="built_in">local</span>/lib:/usr/lib:</span><br></pre></td></tr></table></figure></p>
<p>注意到<code>LD_LIBRARY_PATH</code>和<code>LIBRARY_PATH</code>之间的差别, 由于MKLROOT之类的环境变量是通过</p>
<p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">source</span> compilervars.sh intel64</span><br></pre></td></tr></table></figure></p>
<p>来添加的，可见<code>compilervars.sh</code>并没有编辑<code>LD_LIBRARY_PATH</code>这一变量。</p>
<p>最终可用的include文件如下</p>
<p><figure class="highlight makefile"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Precompiler options</span></span><br><span class="line">CPP_OPTIONS = -DHOST=<span class="string">"LinuxIFC"</span> \</span><br><span class="line">              -DMPI -DMPI_BLOCK=8000 \</span><br><span class="line">              -Duse_collective \</span><br><span class="line">              -DscaLAPACK \</span><br><span class="line">              -DCACHE_SIZE=4000 \</span><br><span class="line">              -Davoidalloc \</span><br><span class="line">              -Duse_bse_te \</span><br><span class="line">              -Dtbdyn \</span><br><span class="line">              -Duse_shmem</span><br><span class="line"></span><br><span class="line">CPP        = fpp -f_com=no -free -w0  <span class="variable">$*</span><span class="variable">$(FUFFIX)</span> <span class="variable">$*</span><span class="variable">$(SUFFIX)</span> <span class="variable">$(CPP_OPTIONS)</span></span><br><span class="line">FC         = mpifort</span><br><span class="line">FCL        = mpifort -mkl=sequential -lstdc++</span><br><span class="line"></span><br><span class="line">FREE       = -free -names lowercase</span><br><span class="line"></span><br><span class="line">FFLAGS     = -assume byterecl -w</span><br><span class="line">OFLAG      = -O2</span><br><span class="line">OFLAG_IN   = <span class="variable">$(OFLAG)</span></span><br><span class="line">DEBUG      = -O0</span><br><span class="line"></span><br><span class="line">MKL_PATH   = <span class="variable">$(MKLROOT)</span>/lib/</span><br><span class="line">BLAS       =</span><br><span class="line">LAPACK     = <span class="variable">$(MKLROOT)</span>/lib/libmkl_intel_lp64.a <span class="variable">$(MKLROOT)</span>/lib/libmkl_sequential.a <span class="variable">$(MKLROOT)</span>/lib/libmkl_core.a -lpthread -lm -ldl</span><br><span class="line">BLACS      =</span><br><span class="line">SCALAPACK  = /Users/stevezhang/software/mathlib/scalapack/2.0.2/intel/18.0.1/libscalapack.a</span><br><span class="line"></span><br><span class="line">OBJECTS    = fftmpiw.o fftmpi_map.o fft3dlib.o fftw3d.o <span class="variable">$(HOME)</span>/lib/libfftw3xf_intel.a</span><br><span class="line"></span><br><span class="line">INCS       = -m64 -I<span class="variable">$(MKLROOT)</span>/<span class="keyword">include</span>/fftw -I<span class="variable">$(MKLROOT)</span>/<span class="keyword">include</span>/</span><br><span class="line"></span><br><span class="line">LLIBS      = -L/usr/local/lib/gcc/7/ <span class="variable">$(SCALAPACK)</span> <span class="variable">$(LAPACK)</span>  </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">OBJECTS_O1 += fftw3d.o fftmpi.o fftmpiw.o</span><br><span class="line">OBJECTS_O2 += fft3dlib.o</span><br><span class="line"></span><br><span class="line"><span class="comment"># For what used to be vasp.5.lib</span></span><br><span class="line">CPP_LIB    = <span class="variable">$(CPP)</span></span><br><span class="line">FC_LIB     = <span class="variable">$(FC)</span></span><br><span class="line">CC_LIB     = icc</span><br><span class="line">CFLAGS_LIB = -O</span><br><span class="line">FFLAGS_LIB = -O1</span><br><span class="line">FREE_LIB   = <span class="variable">$(FREE)</span></span><br><span class="line"></span><br><span class="line">OBJECTS_LIB= linpack_double.o getshmem.o</span><br><span class="line"></span><br><span class="line"><span class="comment"># For the parser library</span></span><br><span class="line"><span class="comment">#CXX_PARS   = c++ #/usr/local/lib/gcc/7/libstdc++.a</span></span><br><span class="line"><span class="comment">#CXX_PARS = clang++ -++ -std=gnu++11</span></span><br><span class="line">CXX_PARS = icpc -lstdc++</span><br><span class="line"></span><br><span class="line">LIBS       += parser</span><br><span class="line">LLIBS      += -Lparser  -lparser -L/usr/local/lib/gcc/7/ -lstdc++</span><br><span class="line"></span><br><span class="line"><span class="comment"># Normally no need to change this</span></span><br><span class="line">SRCDIR     = ../../src</span><br><span class="line">BINDIR     = ../../bin</span><br><span class="line"></span><br><span class="line"><span class="comment">#================================================</span></span><br><span class="line"><span class="comment"># GPU Stuff</span></span><br><span class="line"><span class="comment">#... # skipped for clarity</span></span><br></pre></td></tr></table></figure></p>
<h2>总结</h2>
<p>macOS的操作系统是Darwin。</p>
<blockquote>
<p>Darwin是由苹果电脑于2000年所释出的一个开放原始码操作系统。Darwin 是MacOSX 操作环境的操作系统成份。苹果电脑于2000年把Darwin 释出给开放原始码社群。现在的Darwin皆可以在苹果电脑的PowerPC 架构和X86 架构下执行，而后者的架构只有有限的驱动程序支援。</p>
</blockquote>
<p>在Darwin内存储函数库搜索路径的不是像Fedora和Ubuntu的<code>LD_LIBRARY_PATH</code>，而是<code>LIBRARY_PATH</code>和<code>DYLD_LIBRARY_PATH</code>。前者是<code>ld</code>的搜索路径，后者是动态链接指令<code>dyld</code>的搜索路径。需要使用<code>.la</code>和<code>.dylib</code>动态库时，需要将库路径加入<code>DYLD_LIBRARY_PATH</code>内。</p>
<h2>附录</h2>
<p>编译成功后，我在几乎所有的modulefile中增加了<code>prepend-path DYLD_LIBRARY_PATH</code>行，在module load它们时出现警告</p>
<p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">dyld: warning, unknown environment variable: DYLD_LIBRARY_PATH_modshare</span><br></pre></td></tr></table></figure></p>
<p>这个错误在跑vasp的时候也会产生。出现原因是<code>dyld</code>和Tcl版的<code>module</code>之间不兼容。更新到最新版本的Environment module可以解决这个问题.</p>
<h2>更新</h2>
<h3>2019-05-02</h3>
<p>Environment module 4.2.1已经修正了<code>DYLD_LIBRARY_PATH</code>的问题</p>
<h2>参考链接</h2>
<p><a href="https://baike.baidu.com/item/Darwin/2537108?fr=aladdin" target="_blank" rel="noopener">Darwin 百度百科</a></p>
<p><a href="http://d.hatena.ne.jp/kimuraw/20150919/p1" target="_blank" rel="noopener">http://d.hatena.ne.jp/kimuraw/20150919/p1</a></p>
<p><a href="https://developer.apple.com/legacy/library/documentation/Darwin/Reference/ManPages/man1/dyld.1.html" target="_blank" rel="noopener">man dyld</a></p>

	
	</div>
  <!-- categories -->
  <span style="font-size:90%">
  
  <i style="color:#bbb" class="fa fa-folder"></i> <a style="color:#bbb" href="/categories/Software/">Software</a>
  </span>
  &nbsp
  <!-- tags -->
  <span style="font-size:90%" >
  
  <a style="color:#bbb" href="/tags/VASP/">#VASP</a>&nbsp&nbsp<a style="color:#bbb" href="/tags/Compilation/">#Compilation</a>&nbsp&nbsp<a style="color:#bbb" href="/tags/macOS/">#macOS</a>&nbsp&nbsp<a style="color:#bbb" href="/tags/Bugfix/">#Bugfix</a>
  </span>
  <!-- read more button -->
  <a type="button" href="/2018/01/02/compile_VASP_on_macOS/#more" class="pull-right btn btn-default more">Read More</a>
</div>

		

		</div>

		<!-- pagination -->
		<div>
  		<center>
		<div class="pagination">
<ul class="pagination">
	 
		
    	<li class="prev"><a href="/page/6/" class="alignleft prev"><i class="fa fa-arrow-circle-o-left"></i> Prev</a></li>
  		

        <li><a href="/"><i class="fa fa-home"></i>Home</a></li>

		
		   <li class="next"> <a href="/page/8/" class="alignright next">Next<i class="fa fa-arrow-circle-o-right"></i></a> </li>          
        
	
</ul>
</div>

  		</center>
		</div>

		
		
	</div> <!-- col-md-9 -->

	
		<div class="col-md-3">
	<div id="sidebar">
	
			
  <div id="site_search">
   <div class="form-group">
    <input type="text" id="local-search-input" name="q" results="0" placeholder="Search" class="st-search-input st-default-search-input form-control"/>
   </div>  
  <div id="local-search-result"></div>
  </div>


		
			
	<div class="widget">
		<h4>Categories</h4>
		<ul class="tag_box inline list-unstyled">
		
			<li><a href="/categories/Algorithm/">Algorithm<span class="badge">2</span></a></li>
		
			<li><a href="/categories/Comment/">Comment<span class="badge">2</span></a></li>
		
			<li><a href="/categories/Programming/">Programming<span class="badge">7</span></a></li>
		
			<li><a href="/categories/Software/">Software<span class="badge">26</span></a></li>
		
		</ul>
	</div>


		
			




	<div class="widget">
		<h4>Tag Cloud</h4>
		<ul class="tag_box inline list-unstyled">		
		
			<li><a href="/tags/SCAN/">SCAN<span class="badge">1</span></a></li>
		
			<li><a href="/tags/LIBXC/">LIBXC<span class="badge">1</span></a></li>
		
			<li><a href="/tags/XmGrace/">XmGrace<span class="badge">1</span></a></li>
		
			<li><a href="/tags/FFTW/">FFTW<span class="badge">1</span></a></li>
		
			<li><a href="/tags/gprof/">gprof<span class="badge">1</span></a></li>
		
			<li><a href="/tags/Emacs/">Emacs<span class="badge">3</span></a></li>
		
			<li><a href="/tags/Grid-technique/">Grid technique<span class="badge">1</span></a></li>
		
			<li><a href="/tags/Freemind/">Freemind<span class="badge">2</span></a></li>
		
			<li><a href="/tags/Pandoc/">Pandoc<span class="badge">2</span></a></li>
		
			<li><a href="/tags/MPI/">MPI<span class="badge">1</span></a></li>
		
			<li><a href="/tags/LaTeX/">LaTeX<span class="badge">3</span></a></li>
		
			<li><a href="/tags/map/">map<span class="badge">1</span></a></li>
		
			<li><a href="/tags/bilibili/">bilibili<span class="badge">1</span></a></li>
		
			<li><a href="/tags/Bugfix/">Bugfix<span class="badge">4</span></a></li>
		
			<li><a href="/tags/F2PY/">F2PY<span class="badge">1</span></a></li>
		
			<li><a href="/tags/Compilation/">Compilation<span class="badge">5</span></a></li>
		
		
		   <li><a href="/tags">...<span class="badge">55</span></a></li>
		 
		</ul>
	</div>


		
			
<div class="widget">
	<h4>Links</h4>
	<ul class="blogroll list-unstyled">
	
		<li><i class="fa fa-github-square"></i><a href="https://github.com/minyez" title="My Github account." target="_blank"]);">Github-minyez</a></li>
	
		<li><i class="fa fa-book"></i><a href="https://www.douban.com/people/shigaro" title="My DouBan account" target="_blank"]);">DouBan - Shigaro</a></li>
	
		<li><i class="fa fa-book"></i><a href="https://bookmeter.com/users/1169010" title="My Bookmeter account" target="_blank"]);">読書メーター - minyez</a></li>
	
		<li><i class="fa fa-mail-forward"></i><a href="mailto:zmysmile0929@163.com" title="Send Email to me" target="_blank"]);">Email</a></li>
	
		<li><i class="fa fa-code"></i><a href="https://github.com/minyez/minyez.github.io/tree/hexo" title="Source codes of this site" target="_blank"]);">Site source</a></li>
	
		<li><i class="fa fa-rss"></i><a href="atom.xml" title="atom rss" target="_blank"]);"> RSS</a></li>
	
	</ul>
</div>


		
	</div> <!-- sidebar -->
</div> <!-- col-md-3 -->

	
	
</div> <!-- row-fluid -->

	</div>
  </div>
  <div class="container-narrow">
  <footer> <p>
  
  &copy; 2020 by <a href="http://shigaro.org"> minyez </a>
  
    | <a href="http://github.com/minyez/hexo-theme-freemind/">Theme</a> based on two Freemind themes by <a href="https://github.com/wzpan/hexo-theme-freemind/">wzpan</a> and <a href="https://github.com/PytLab/hexo-theme-freemind/">PytLab</a> 
    | Powered by <a href="https://github.com/hexojs/hexo">Hexo</a>
  
    <span id="busuanzi_container_site_uv">| <span id="busuanzi_value_site_uv"></span> visitors</span>
  
  
	| <span class="post-count">54.3k</span> words
  
</p>
 </footer>
</div> <!-- container-narrow -->
  


  
<a id="gotop" href="#">   
  <span>▲</span> 
</a>

<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/bootstrap.min.js"></script>
<script src="/js/main.js"></script>
<script src="/js/search.js"></script> 


<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>



   <script type="text/javascript">      
     var search_path = "search.xml";
	 if (search_path.length == 0) {
	 	search_path = "search.xml";
	 }
	 var path = "/" + search_path;
     searchFunc(path, 'local-search-input', 'local-search-result');
   </script>


<!-- Global site tag (gtag.js) - Google Analytics -->
<!--    added 2018-07-12 -->
<!-- modified 2019-05-10 -->

<script async src="https://www.googletagmanager.com/gtag/js?id=UA-111612868-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-111612868-1');
</script>


<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ["$","$"], ["\\(","\\)"] ],
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
            processEscapes: true
        },
        TeX: {equationNumbers: { autoNumber: "AMS" }}
    });
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax();
        for (var i = 0; i < all.length; ++i)
            all[i].SourceElement().parentNode.className += ' has-jax';
    });
</script>
<!--<script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>-->
<script type="text/javascript" async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

</body>
   </html>
